controllers/user/orderController.js

const mongoose = require('mongoose');
const Product = require('../../models/productSchema');
const User = require('../../models/userSchema');
const Order = require('../../models/orderSchema');

const computeOrderStatus = (orderItems) => {
  const statuses = orderItems.map(i => i.status);

  const allDelivered = statuses.every(s => s === 'delivered');
  const allCancelled = statuses.every(s => s === 'cancelled');
  const allReturned   = statuses.every(s => s === 'returned');

  const hasDelivered       = statuses.includes('delivered');
  const hasCancelled       = statuses.includes('cancelled');
  const hasReturned        = statuses.includes('returned');
  const hasReturnRequested = statuses.includes('return requested');
  const hasReturnRejected  = statuses.includes('return rejected');
  const hasShipped         = statuses.includes('shipped');

  if (allDelivered)                 return 'delivered';
  if (allCancelled)                 return 'cancelled';
  if (allReturned)                  return 'returned';
  if (hasReturned && !allReturned)  return 'partially_returned';
  if (hasCancelled && !allCancelled) return 'partially_cancelled';
  if (hasReturnRequested)           return 'return_requested';
  if (hasReturnRejected)            return 'return_rejected';
  if (hasShipped)                   return 'shipped';
  if (hasDelivered && !allDelivered) return 'processing';

  return 'pending';
};

async function updateOrderStatus(order, session = null) {
  const newStatus = computeOrderStatus(order.orderItems);

  if (order.status !== newStatus) {
    order.status = newStatus;

    const labelExists = order.timeline.some(t =>
      t.label.toLowerCase().includes(newStatus.toLowerCase())
    );

    if (!labelExists) {
      order.timeline.push({
        label: `Order ${newStatus.charAt(0).toUpperCase() + newStatus.slice(1)}`,
        completed: ['delivered','cancelled','returned'].includes(newStatus),
        current: true,
        date: new Date(),
      });
    }

    order.timeline.forEach((step, idx, arr) => {
      step.current = (idx === arr.length - 1);
    });
  }

  await order.save({ session });
}

exports.loadOrderPage = async (req, res) => {
  try {
    const userId = req.session.user;
    if (!userId) return res.redirect('/login');

    const user = await User.findById(userId).select('avatar name email phone');
    if (!user) return res.status(404).send('User not found');

    const page = parseInt(req.query.page) || 1;
    const limit = 3;
    const skip = (page - 1) * limit;
   
    const filter = { user: userId };
    
    if (req.query.search && req.query.search.trim() !== '') {
      const searchTerm = req.query.search.trim();
      const searchRegex = { $regex: searchTerm, $options: 'i' };

      const productSearch = { 'orderItems.productName': searchRegex };
      const statusSearch = { status: searchRegex };

      filter.$or = [productSearch, statusSearch];
    }
   
    const validStatuses = ['processing', 'completed'];
    if (req.query.status && req.query.status !== '' && validStatuses.includes(req.query.status)) {
      filter.status = req.query.status;
    }
    

    const totalOrders = await Order.countDocuments(filter);
    const totalPages = Math.ceil(totalOrders / limit);
  
    const orders = await Order.find(filter)
      .select('orderId createdOn status finalAmount paymentMethod paymentId orderItems')
      .populate({
        path: 'orderItems.product', 
        select: 'productName productImages',
      })
      .sort({createdAt:-1})
      .skip(skip)
      .limit(limit)
      .lean(); 

 
    for (const order of orders) {
      const newStatus = computeOrderStatus(order.orderItems);
      if (order.status !== newStatus) {
        order.status = newStatus;
        await Order.updateOne({ _id: order._id }, { status: newStatus });
      }
    }

    const message = orders.length === 0 ? 'No orders found for selected filter' : null;

    res.render('user/orders', {
      user: {
        avatar: user.avatar || '/default-avatar.jpg',
        name: user.name || 'User Name',
        email: user.email || 'user@example.com',
        phone: user.phone || '+1234567890',
      },
      orders: orders.map(order => ({
        _id: order._id,
        orderID: order.orderId,
        createdAt: order.createdOn,
        paymentStatus: order.paymentId ? 'Paid' : 'Pending',
        status: order.status || 'processing',
        finalAmount: order.finalAmount || 0,
        orderItems: order.orderItems.map(item => ({
          productId: item.product?._id,
          productName: item.productName || item.product?.productName || 'Unknown Product',
          image: item.productImage || 
            (item.product?.productImages?.[0] ? `/uploads/product-images/${item.product.productImages[0]}` : '/default-image.jpg'),
        })),
      })),
      message,
      filters: req.query, 
      currentPage: page,
      totalPages: totalPages
    });
  } catch (err) {
    console.error('Error loading orders page:', err);
    res.status(500).send('Internal Server Error');
  }
};

exports.getOrderDetailsPage = async (req, res) => {
  try {
    const userId = req.session.user;
    if (!userId) {
      console.log('User not logged in, redirecting to login page.');
      return res.redirect('/user/login');
    }

    const orderId = req.params.orderId;
    const query = mongoose.Types.ObjectId.isValid(orderId)
      ? { _id: orderId, user: userId }
      : { orderId: orderId, user: userId };

    const order = await Order.findOne(query)
      .populate('user', 'name email')
      .populate({
        path: 'orderItems.product',
        select: 'productName productImages regularPrice',
      })
      .lean();

    if (!order) {
      console.log('Order not found for user:', userId, 'and Order ID:', orderId);
      return res.status(404).send('Order not found');
    }

    const timelineSteps = order.timeline.map(step => ({
      title: step.label,
      completed: step.completed,
      current: step.current,
      date: step.date || null,
    }));

    const orderData = {
      _id: order._id,
      orderID: order.orderId,
      orderStatus: order.status,
      orderDate: order.createdOn,
      invoiceDate: order.invoiceDate || order.createdOn,
      paymentMethod: order.paymentMethod || 'N/A',
      paymentStatus: order.paymentId ? 'Paid' : 'Pending',
      transactionId: order.paymentId || 'N/A',
      shippingAddress: {
        name: order.address.fullName,
        address: order.address.address,
        city: order.address.city,
        state: order.address.state,
        country: order.address.country,
        pinCode: order.address.pincode,
        phone: order.address.phone,
        addressType: order.address.addressType,
      },
      user: order.user || { name: 'N/A', email: 'N/A' },
      items: order.orderItems.filter(item => item).map((item, index) => {
        const mappedItem = {
          productId: item.product?._id || item.product || 'N/A',
          productName: item.productName || item.product?.productName || 'Unknown Product',
          purchasePrice: item.purchasePrice || 0,
          quantity: item.quantity || 1,
          productImage: item.productImage || 
            (item.product?.productImages?.[0] ? `/uploads/product-images/${item.product.productImages[0]}` : '/default-image.jpg'),
          productStatus: item.status || 'Unknown',
        };
        console.log(`Mapped item ${index}:`, JSON.stringify(mappedItem, null, 2));
        return mappedItem;
      }),
      timeline: timelineSteps,
      originalAmount: order.totalPrice || 0,
      offerDiscount: order.discount || 0,
      couponApplied: order.couponApplied || false,
      couponDiscount: order.couponApplied ? order.discount || 0 : 0,
      subtotal: order.totalPrice - (order.discount || 0),
      shipping: order.shipping || 0,
      tax: order.tax || 0,
      total: order.finalAmount || 0,
      message: order.message || '',
    };

    console.log('Mapped orderData.items count:', orderData.items.length);
    console.log('Mapped orderData.items:', JSON.stringify(orderData.items, null, 2));

    if (orderData.total < 0) {
      console.warn('Negative final amount detected:', orderData.total);
      orderData.totalWarning = 'Warning: Negative total amount. Please verify order calculations.';
    }

    res.render('user/order-details', { order: orderData, user: req.session.user });
  } catch (error) {
    console.error('Error fetching order details:', error);
    res.status(500).send('Internal Server Error');
  }
};

exports.cancelItem = async (req, res) => {
  try {
    const { orderId, productId, reason } = req.body;
    const userId = req.session.user;

    if (!userId) {
      return res.status(401).json({ success: false, message: 'Unauthorized' });
    }

    if (!mongoose.Types.ObjectId.isValid(orderId) || !mongoose.Types.ObjectId.isValid(productId)) {
      return res.status(400).json({ success: false, message: 'Invalid order or product ID' });
    }

    const order = await Order.findById(orderId);
    if (!order || order.user.toString() !== userId) {
      return res.status(404).json({ success: false, message: 'Order not found or unauthorized' });
    }

    const item = order.orderItems.find(i => i.product.toString() === productId);
    if (!item) {
      return res.status(404).json({ success: false, message: 'Item not found in order' });
    }

    if (!['pending', 'ordered'].includes(item.status)) {
      return res.status(400).json({ success: false, message: `Item cannot be cancelled (current status: ${item.status})` });
    }

    item.status = 'cancelled';
    await Product.findByIdAndUpdate(item.product, { $inc: { quantity: item.quantity } });

    order.timeline.push({
      label: `Item ${item.productName} Cancelled`,
      completed: true,
      current: false,
      date: new Date(),
      notes: `Reason: ${reason || 'No reason provided'}`,
    });

    await updateOrderStatus(order);
    await order.save();

    res.json({ 
      success: true, 
      message: 'Item cancelled successfully', 
      orderStatus: order.status 
    });

  } catch (error) {
    console.error('Error cancelling item:', error);
    res.status(500).json({ success: false, message: `Failed to cancel item: ${error.message}` });
  }
};

exports.returnItem = async (req, res) => {
  console.log("Return request initiated");

  try {
    const { orderId, productId, reason } = req.body;
    const order = await Order.findById(orderId);
    if (!order) {
      return res.status(404).json({ success: false, message: 'Order not found' });
    }

    const item = order.orderItems.find(item => item.product.toString() === productId);
    if (!item || item.status !== 'delivered') {
      return res.status(400).json({ success: false, message: 'Item cannot be returned' });
    }

    const RETURN_EXPIRY_DAYS = 7;
    const deliveryDate = item.deliveryDate ? new Date(item.deliveryDate) : new Date(order.createdOn);
    const expiryDate = new Date(deliveryDate);
    expiryDate.setDate(deliveryDate.getDate() + RETURN_EXPIRY_DAYS);

    if (new Date() > expiryDate) {
      return res.status(400).json({ success: false, message: 'Return period has expired' });
    }

    item.status = 'return requested';
    order.timeline.push({
      label: `Return Requested for ${item.productName}`,
      completed: true,
      current: false,
      date: new Date(),
      notes: `Reason: ${reason}`,
    });

    await updateOrderStatus(order);  
    await order.save();              

    res.json({ 
      success: true, 
      message: 'Return request submitted successfully',
      orderStatus: order.status   
    });

  } catch (error) {
    console.error('Error requesting return:', error);
    res.status(500).json({ success: false, message: 'Internal Server Error' });
  }
};



user/coupnController.js

const Coupon = require('../../models/couponSchema')

exports.applyCoupon = async(req,res)=>{
    try{

    }catch(error){
        
    }
}



user/checkoutController.js

const mongoose = require('mongoose');
const Product = require('../../models/productSchema');
const Order = require('../../models/orderSchema');
const Address = require('../../models/addressSchema');
const Cart = require('../../models/cartSchema');
const { v4: uuidv4 } = require('uuid');
require('dotenv').config();
const Razorpay = require('razorpay');
const crypto   = require('crypto');

const razorpay = new Razorpay({
  key_id: process.env.RAZORPAY_KEY_ID,
  key_secret: process.env.RAZORPAY_SECRET,
});

console.log("Razorpay initialized with key:", process.env.RAZORPAY_KEY_ID);

exports.getCheckoutPage = async (req, res) => {
  try {
    const userId = req.user?._id;
    console.log('getCheckoutPage: userId:', userId);
    if (!userId) {
      console.log('getCheckoutPage: No userId, redirecting to login');
      return res.redirect("/user/login");
    }

    console.log('getCheckoutPage: Fetching cart for userId:', userId);
    const cart = await Cart.findOne({ userId }).populate({
      path: 'items.productId',
      populate: { path: 'category' }
    });
    console.log('getCheckoutPage: Cart found:', cart ? cart : 'No cart found');

    if (!cart || !cart.items||cart.items.length===0) {
      console.log('getCheckoutPage: Cart is empty or not found, redirecting to cart');
      return res.redirect('/cart');
    }

    cart.items = cart.items.filter(item=>item.productId)
    await cart.save()


    console.log('getCheckoutPage: Fetching user addresses');
    const addressDoc = await Address.findOne({ userId });
    console.log('getCheckoutPage: User addresses found:', addressDoc ? addressDoc.address : 'No addresses');


    const userAddresses = addressDoc && Array.isArray(addressDoc.address) ? addressDoc.address : [];

    let subtotal = 0;
    let shippingCost = 50;
    let discount = 0;

    subtotal = cart.items.reduce((sum, item) => {
      if (item.productId && item.productId.salePrice) {
        const salePrice = item.productId.salePrice;
        const regularPrice = item.productId.regularPrice || salePrice;
        discount += (regularPrice - salePrice) * item.quantity;
        return sum + (salePrice * item.quantity);
      }
      return sum;
    }, 0);

    shippingCost = subtotal > 1000 ? 0 : 50;
    const tax = subtotal * 0.1;
    const total = subtotal - discount + shippingCost + tax;

    console.log('getCheckoutPage: Rendering checkout page with addresses:', userAddresses);
    res.render('user/checkout', {
      cart: cart || { items: [] },
      user: req.user,
      userAddresses : userAddresses || [],
      subtotal,
      shippingCost,
      tax,
      total,
      discount
    });
  } catch (error) {
    console.error('Error loading checkout page:', error.stack);
    res.status(500).render('user/page-404', {
      message: 'An error occurred while loading the checkout page.',
      pageTitle: 'Error'
    });
  }
};

exports.addAddress = async (req, res) => {
  try {
    const userId = req.user?._id;
    const { fullName, phone, address, city, state, country, pincode, addressType, isDefault } = req.body;

    console.log('[addAddress] Request data:', { userId, fullName, phone, address, city, state, country, pincode, addressType, isDefault });

 
    if (!userId) {
      return res.status(401).json({ success: false, message: 'Please login' });
    }

 
    if (!fullName || !phone || !address || !city || !state || !country || !pincode || !addressType) {
      return res.status(400).json({ success: false, message: 'All fields are required' });
    }


    const pinCode = Number(pincode);
    if (isNaN(pinCode)) {
      return res.status(400).json({ success: false, message: 'Invalid pincode' });
    }

  
    let addressDoc = await Address.findOne({ userId });
    if (!addressDoc) {
      addressDoc = new Address({ userId, address: [] });
    }


    if (isDefault === 'true' || isDefault === true) {
      addressDoc.address.forEach(addr => (addr.isDefault = false));
    }

    const newAddress = {
      _id: new mongoose.Types.ObjectId(),
      addressType,
      name: fullName,
      address,
      city,
      state,
      country,
      pinCode,
      phone,
      isDefault: isDefault === 'true' || isDefault === true
    };

    addressDoc.address.push(newAddress);
    await addressDoc.save();

    console.log('[addAddress] Address saved:', newAddress);

 
    if (req.session) {
      req.session.userAddresses = addressDoc.address;
    }


    res.json({
      success: true,
      message: 'Address added successfully',
      address: newAddress
    });
  } catch (error) {
    console.error('[addAddress] Error:', error.message, error.stack);
    res.status(500).json({ success: false, message: 'Error adding address' });
  }
};



exports.getAddress = async (req, res) => {
  try {
    const userId = req.user?._id;
    const addressId = req.params.addressId
    if (!userId) {
      return res.status(401).json({ success: false, message: 'Please login' });
    }

    const addressDoc = await Address.findOne({ userId,'address._id':addressId });
    const addresses = addressDoc && Array.isArray(addressDoc.address) ? addressDoc.address : [];

    res.json({
      success: true,
      addresses: addresses.map(addr => ({
        _id: addr._id,
        name: addr.name,
        fullName: addr.name,
        phone: addr.phone,
        address: addr.address,
        city: addr.city,
        state: addr.state,
        country: addr.country || 'India',
        pinCode: addr.pinCode,
        pincode: addr.pinCode,
        addressType: addr.addressType,
        isDefault: addr.isDefault
      }))
    });
  } catch (error) {
    console.error('[getAllAddresses] Error:', error.message, error.stack);
    res.status(500).json({ success: false, message: 'Error fetching addresses' });
  }
};
exports.editAddress = async (req, res) => {
    try {
      console.log("[PUT /address/edit/:id] Session ID:", req.sessionID);
      console.log("[PUT /address/edit/:id] Session:", req.session);

      const addressId = req.params.addressId;
      const userId = req.session.user?.id || req.session.user;
      console.log("[PUT /address/edit/:id] User in session:", userId);
      console.log("addressId",addressId)

      if (!userId) {
        console.log("[PUT /address/edit/:id] No user in session");
        return res.status(401).json({
          success: false,
          message: "Unauthorized",
        });
      }

      console.log("[PUT /address/edit/:id] User found:", userId);
      console.log("req.body:", req.body);
      const {
        fullName,
        phone,
        address,
        city,
        state,
        country,
        pincode,
        addressType,
        isDefault,
      } = req.body;

     
      if (
        !fullName ||
        !phone ||
        !address ||
        !city ||
        !state ||
        !country ||
        !pincode ||
        !addressType
      ) {
        return res.status(400).json({
          success: false,
          message: "All fields are required",
        });
      }

      
      if (!/^\d{10}$/.test(phone)) {
        return res.status(400).json({
          success: false,
          message: "Phone number must be exactly 10 digits",
        });
      }

     
      if (!/^\d{6}$/.test(pincode) || pincode === "000000") {
        return res.status(400).json({
          success: false,
          message: "Invalid pincode format",
        });
      }
      const  objectAddressId = new mongoose.Types.ObjectId(addressId)
      console.log("123456789",objectAddressId)
     
      const existingAddress = await Address.findOne({userId,'address._id':objectAddressId});

      if (!existingAddress) {
        return res.status(404).json({
          success: false,
          message: "Address not found",
        });
      }

     
      if (isDefault) {
        await Address.updateMany(
          { userId, 'address.isDefault':true,'address._id':{ $ne: objectAddressId } },
          { $set: { isDefault: false } }
        );
      }

    const updatedAddress = await Address.findOneAndUpdate(
      {userId,'address._id':objectAddressId},
      {
        $set:{
          'address.$.name':fullName.trim(),
          'address.$.phone':phone.trim(),
          'address.$.city':city.trim(),
          'address.$.address':address.trim(),
          'address.$.pinCode':pincode.trim(),
          'address.$.state':state.trim(),
          'address.$.country':country.trim(),
          'address.$.addressType':addressType,
          'address.$.isDefault':Boolean(isDefault),
          'address.$.updatedAt':new Date()
        } 
      },
      {new:true}
    )

    if(!updatedAddress){
      return res.status(404).json({success:false, message: "Address not found" })
    }

    const updatedDetails = updatedAddress.address.find(a=>a._id.equals(objectAddressId))
      res.json({
        success: true,
        message: "Address updated successfully",
        address:{
          id:updatedDetails._id,
          fullName:updatedDetails.name,
          name:updatedDetails.name,
          phone:updatedDetails.phone,
          address:updatedDetails.address,
          city:updatedDetails.city,
          state:updatedDetails.state,
          country:updatedDetails.country||'India',
          pinCode:updatedDetails.pinCode,
          pincode:updatedDetails.pinCode,
          addressType:updatedDetails.addressType,
          isDefault:updatedDetails.isDefault

        }
      });
    } catch (error) {
      console.error("Edit address error:", error);
      res.status(500).json({
        success: false,
        message: "Failed to update address. Please try again.",
        address:{
          id:updatedDetails._id,
          fullName:updatedDetails.name,
          name:updatedDetails.name,
          phone:updatedDetails.phone,
          address:updatedDetails.address,
          city:updatedDetails.city,
          state:updatedDetails.state,
          country:updatedDetails.country||'India',
          pinCode:updatedDetails.pinCode,
          pincode:updatedDetails.pinCode,
          addressType:updatedDetails.addressType,
          isDefault:updatedDetails.isDefault

        }
      });
    }
  }

exports.removeAddress = async (req, res) => {
  try {
    const userId = req.user?._id;
    const addressId = req.params.addressId;

    if (!userId) {
      return res.status(401).json({ success: false, message: 'Please login' });
    }

    const addressDoc = await Address.findOne({ userId });
    if (!addressDoc) {
      return res.status(404).json({ success: false, message: 'No addresses found' });
    }

    addressDoc.address.pull({ _id: addressId });
    await addressDoc.save();

    res.json({ success: true, message: 'Address removed successfully' });
  } catch (error) {
    console.error('[removeAddress] Error:', error.message, error.stack);
    res.status(500).json({ success: false, message: 'Error removing address' });
  }
};

exports.placeOrder = async (req, res) => {
  try {
    const userId = req.user?._id;
    const { selectedAddress, paymentMethod } = req.body;

    // ────── BASIC VALIDATION ──────
    if (!userId) return res.status(401).json({ success: false, message: 'Please login' });

    const cart = await Cart.findOne({ userId }).populate('items.productId');
    const addressDoc = await Address.findOne({ userId });

    if (!cart || !cart.items.length) {
      return res.status(400).json({ success: false, message: 'Cart is empty' });
    }

    const address = addressDoc?.address.id(selectedAddress);
    if (!address) {
      return res.status(400).json({ success: false, message: 'Address not found' });
    }

    // ────── STOCK VALIDATION ──────
    for (const item of cart.items) {
      const p = item.productId;
      if (!p) return res.status(400).json({ success: false, message: 'Product missing' });

      if (p.isActive !== true || p.isBlocked === true || p.status !== 'Available') {
        return res.status(400).json({ success: false, message: `"${p.productName}" unavailable` });
      }
      if (p.quantity === 0) {
        return res.status(400).json({ success: false, message: `"${p.productName}" out of stock` });
      }
      if (item.quantity > p.quantity) {
        return res.status(400).json({ success: false, message: `Only ${p.quantity} "${p.productName}" left` });
      }
    }

    // ────── CALCULATE AMOUNTS ──────
    const subtotal = cart.items.reduce((s, i) => s + i.productId.salePrice * i.quantity, 0);
    const discount = cart.items.reduce((s, i) => {
      const reg = i.productId.regularPrice || i.productId.salePrice;
      return s + (reg - i.productId.salePrice) * i.quantity;
    }, 0);
    const shippingCost = subtotal > 1000 ? 0 : 50;
    const tax = subtotal * 0.1;
    const finalAmount = subtotal - discount + shippingCost + tax;

    const addressSnapshot = {
      fullName: address.name,
      address: address.address,
      city: address.city,
      state: address.state,
      country: address.country,
      pincode: address.pinCode,
      phone: address.phone,
      addressType: address.addressType,
      isDefault: address.isDefault,
    };

    const orderItems = cart.items.map(i => ({
      product: i.productId._id,
      purchasePrice: i.productId.salePrice,
      quantity: i.quantity,
      status: 'ordered',
      productName: i.productId.productName,
      productImage: i.productId.productImage,
    }));

    // ────── RAZORPAY FLOW ──────
    if (paymentMethod === 'razorpay') {
      // Generate a short receipt (e.g., "o_" + first 35 chars of UUID)
      const shortReceipt = `o_${uuidv4().slice(0, 35)}`; // Total length: 2 + 35 = 37 chars

      // Create Razorpay order
      const razorpayOrder = await razorpay.orders.create({
        amount: Math.round(finalAmount * 100), // paise
        currency: 'INR',
        receipt: shortReceipt, // Fixed: shorter receipt
        payment_capture: 1,
      });

      // Save pending order
      const pendingOrder = new Order({
        user: userId,
        orderItems,
        totalPrice: subtotal,
        discount,
        finalAmount,
        address: addressSnapshot,
        invoiceDate: new Date(),
        status: 'pending',
        couponApplied: discount > 0,
        paymentMethod,
        paymentId: razorpayOrder.id,
        shipping: shippingCost,
        tax,
      });
      await pendingOrder.save();

      return res.json({
        success: true,
        razorpay: true,
        key_id: process.env.RAZORPAY_KEY_ID,
        razorpayOrderId: razorpayOrder.id,
        amount: razorpayOrder.amount,
        orderId: pendingOrder._id.toString(),
      });
    }

    // ────── COD / WALLET FLOW ──────
    const order = new Order({
      user: userId,
      orderItems,
      totalPrice: subtotal,
      discount,
      finalAmount,
      address: addressSnapshot,
      invoiceDate: new Date(),
      status: 'processing',
      couponApplied: discount > 0,
      paymentMethod,
      paymentId: null,
      shipping: shippingCost,
      tax,
    });
    await order.save();

    // Deduct stock
    for (const item of order.orderItems) {
      await Product.findByIdAndUpdate(item.product, { $inc: { quantity: -item.quantity } });
    }

    // Clear cart
    await Cart.findOneAndDelete({ userId });

    res.json({
      success: true,
      orderId: order._id.toString(),
      finalAmount,
      paymentMethod,
    });
  } catch (error) {
    console.error('[placeOrder] Error:', error);
    res.status(500).json({ success: false, message: 'Order failed' });
  }
};

exports.verifyRazorpayPayment = async(req,res)=>{
  try{
    const {
      razorpay_order_id,
      razorpay_payment_id,
      razorpay_signature,
      orderId,
    } = req.body;
    const userId = req.user?._id;

    if(!razorpay_order_id||!razorpay_payment_id||!razorpay_signature||!orderId){
      return res.status(400).json({
        success:false,
        message:'Missing payment details',
      })
    }
    const expectedSignature = crypto
      .createHmac('sha256', process.env.RAZORPAY_SECRET)
      .update(`${razorpay_order_id}|${razorpay_payment_id}`)
      .digest('hex');

      if(expectedSignature!==razorpay_signature){
        return res.status(400).json({
          success:false,
          message:'Invalid payment signature',
        })
      }
      const order = await Order.findOne({ _id: orderId, user: userId, status: 'pending' }).populate('orderItems.product');

      if(!order){
        return res.status(404).json({
          success:false,
          message:'Order not found or already processed',
        })
      }

    order.status = 'processing';
    order.paymentId = razorpay_payment_id;
    await order.save();

    for (const item of order.orderItems) {
      await Product.findByIdAndUpdate(
        item.product,
        { $inc: { quantity: -item.quantity } },
        { new: true }
      );
    }

    await Cart.findOneAndDelete({ userId })

    res.json({
      success: true,
      orderId: order._id.toString(),
      finalAmount: order.finalAmount,
      paymentMethod: order.paymentMethod,
      message: 'Payment verified and order confirmed',
    });
  }catch(error){
    console.error('[verifyRazorpayPayment] Error:', error.message, error.stack);
    res.status(500).json({
      success: false,
      message: 'Payment verification failed',
    });
  }
}
exports.getOrderSuccessPage = async (req, res) => {
  try {
    const userId = req.user?._id;
    if (!userId) {
      console.log('[getOrderSuccessPage] No userId, redirecting to /login');
      return res.redirect('/user/login');
    }

    const { orderId } = req.query;
    if (!orderId) {
      console.log('[getOrderSuccessPage] No orderId provided');
      return res.redirect('/user/order-error?message=Invalid%20Order&details=Order%20ID%20not%20provided');
    }

    const order = await Order.findById(orderId).populate('orderItems.product');
    if (!order || order.user.toString() !== userId.toString()) {
      console.log('[getOrderSuccessPage] Order not found or user mismatch');
      return res.redirect('/user/order-error?message=Order%20Not%20Found&details=Invalid%20order%20ID');
    }

    res.render('user/order-success', {
      message: 'Your order has been placed successfully!',
      orderId: order._id.toString(),
      paymentMethod: order.paymentMethod,
      orderItems: order.orderItems,
      subtotal: order.totalPrice,
      discount: order.discount || 0,
      shippingCost: order.shipping,
      tax: order.tax,
      finalAmount: order.finalAmount,
      shippingAddress: order.address
    });
  } catch (error) {
    console.error('[getOrderSuccessPage] Error:', error.message, error.stack);
    res.redirect('/user/order-error?message=Server%20Error&details=An%20error%20occurred%20while%20loading%20order%20details');
  }
};

exports.getOrderErrorPage = async (req, res) => {
  try {
    const { message, details, code, orderId, finalAmount } = req.query;
    console.log('[getOrderErrorPage] Query params:', { message, details, code, orderId, finalAmount });

    res.render('user/order-error', {
      errorMessage: message || "We couldn't process your order",
      errorDetails: details || "There was an issue with your transaction. Please try again.",
      errorCode: code || null,
      orderId: orderId || 'N/A',
      finalAmount: finalAmount ? parseFloat(finalAmount) : undefined
    });
  } catch (error) {
    console.error('[getOrderErrorPage] Error:', error.message, error.stack);
    res.redirect('/user');
  }
};



controllers/admin/couponController.js

crete the files


admin/orderController.js

const mongoose = require('mongoose');
const Order = require('../../models/orderSchema');
const Product = require('../../models/productSchema');

const computeOrderStatus = (orderItems) => {
  const statuses = orderItems.map(i => i.status);

  const allDelivered = statuses.every(s => s === 'delivered');
  const allCancelled = statuses.every(s => s === 'cancelled');
  const allReturned   = statuses.every(s => s === 'returned');

  const hasDelivered       = statuses.includes('delivered');
  const hasCancelled       = statuses.includes('cancelled');
  const hasReturned        = statuses.includes('returned');
  const hasReturnRequested = statuses.includes('return requested');
  const hasReturnRejected  = statuses.includes('return rejected');
  const hasShipped         = statuses.includes('shipped');

  if (allDelivered)                 return 'delivered';
  if (allCancelled)                 return 'cancelled';
  if (allReturned)                  return 'returned';
  if (hasReturned && !allReturned)  return 'partially_returned';
  if (hasCancelled && !allCancelled) return 'partially_cancelled';
  if (hasReturnRequested)           return 'return_requested';
  if (hasReturnRejected)            return 'return_rejected';
  if (hasShipped)                   return 'shipped';
  if (hasDelivered && !allDelivered) return 'processing';

  return 'pending';
};


async function updateOrderStatus(order, session = null) {
  const newStatus = computeOrderStatus(order.orderItems);

  if (order.status !== newStatus) {
    order.status = newStatus;


    const exists = order.timeline.some(t => t.label.toLowerCase().includes(newStatus));
    if (!exists) {
      order.timeline.push({
        label: `Order ${newStatus.charAt(0).toUpperCase() + newStatus.slice(1)}`,
        completed: ['delivered','cancelled','returned'].includes(newStatus),
        current: true,
        date: new Date(),
      });
    }

    order.timeline.forEach((step, idx, arr) => {
      step.current = (idx === arr.length - 1);
    });
  }

  await order.save({ session });
}

exports.renderOrderManage = async (req, res) => {
  try {
    let page = parseInt(req.query.page) || 1;
    let limit = 5;
    let skip = (page - 1) * limit;

    const totalOrders = await Order.countDocuments();
    const orders = await Order.find()
      .populate('user', 'name email')
      .populate('address')
      .populate({
        path: 'orderItems.product',
        select: 'productName productImages',
      })
      .sort({ createdOn: -1 })
      .skip(skip)
      .limit(limit)
      .lean();

    for (const order of orders) {
      const newStatus = computeOrderStatus(order.orderItems);
      if (order.status !== newStatus) {
        order.status = newStatus;
        await Order.updateOne({ _id: order._id }, { status: newStatus });
      }

      order.orderItems.forEach(item => {
        if (!item.product) console.warn(`Order ${order.orderId} has an item with no valid product reference. Product ID: ${item.product}`);
        item.displayName = item.productName || (item.product?.productName || 'Unknown Product');
        item.displayImage = item.productImage || (item.product?.productImages?.[0] ? `/uploads/product-images/${item.product.productImages[0]}` : '/default-image.jpg');
      });
    }

    res.render('admin/orderManage', {
      orders,
      currentPage: page,
      totalPages: Math.ceil(totalOrders / limit),
      admin: req.session.admin,
    });
  } catch (error) {
    console.error('Error fetching orders:', error);
    res.status(500).send('Internal Server Error');
  }
};

exports.renderOrderDetails = async (req, res) => {
  try {
    console.log('Fetching order details for orderId:', req.params.orderId);

    const order = await Order.findOne({ orderId: req.params.orderId })
      .populate('user', 'name email')
      .populate({
        path: 'orderItems.product',
        select: 'productName productImages',
      })
      .lean();

    if (!order) {
      console.log('Order not found for orderId:', req.params.orderId);
      return res.status(404).send('Order not found');
    }


    order.orderItems = order.orderItems.map(item => ({
      ...item,
      productName: item.productName || (item.product?.productName || 'Unknown Product'),
      productImage: item.productImage || (item.product?.productImages?.[0] ? `/uploads/product-images/${item.product.productImages[0]}` : '/default-image.jpg'),
      status: item.status || 'ordered',
      productId: item.product?._id?.toString() || item.product || 'N/A',
    }));


    order.timeline = order.timeline || [{ label: 'Ordered', current: true, completed: false, date: new Date() }];


    order.address = order.address || {
      fullName: 'N/A',
      address: '',
      city: '',
      state: '',
      country: '',
      pincode: '',
      phone: 'N/A',
      addressType: 'N/A',
    };


    order.paymentStatus = order.paymentStatus || 'Pending';
    order.transactionId = order.paymentId || 'N/A';

    console.log('Processed order:', order);

    res.render('admin/orderDetails', {
      order,
      admin: req.session.admin,
    });
  } catch (error) {
    console.error('Error fetching order details:', error);
    res.status(500).send('Server Error');
  }
};

exports.getOrderById = async (req, res) => {
  try {
    const order = await Order.findOne({ orderId: req.params.orderId })
      .populate('user', 'name email')
      .populate({
        path: 'orderItems.product',
        select: 'productName productImages',
      })
      .lean();

    if (!order) {
      return res.status(404).json({ success: false, message: 'Order not found' });
    }

    order.orderItems = order.orderItems.map(item => ({
      ...item,
      productName: item.productName || (item.product?.productName || 'Unknown Product'),
      productImage: item.productImage || (item.product?.productImages?.[0] ? `/uploads/product-images/${item.product.productImages[0]}` : '/default-image.jpg'),
      status: item.status || 'ordered',
      productId: item.product?._id?.toString() || item.product || 'N/A',
    }));

    order.timeline = order.timeline || [{ label: 'Ordered', current: true, completed: false, date: new Date() }];
    order.address = order.address || {
      fullName: 'N/A',
      address: '',
      city: '',
      state: '',
      country: '',
      pincode: '',
      phone: 'N/A',
      addressType: 'N/A',
    };

    order.paymentStatus = order.paymentStatus || 'Pending';
    order.transactionId = order.paymentId || 'N/A';

    res.json({ success: true, order });
  } catch (error) {
    console.error('Error fetching order:', error);
    res.status(500).json({ success: false, message: 'Internal Server Error' });
  }
};

exports.updateOrderStatus = async (req, res) => {
  console.log('updateOrderStatus hit', req.params, req.body);
  try {
    const { itemId, status } = req.body;
    const { orderId } = req.params;

    const validStatuses = ['ordered', 'shipped', 'delivered', 'cancelled', 'returned'];
    if (!validStatuses.includes(status)) {
      return res.status(400).json({ message: 'Invalid status' });
    }

    const order = await Order.findOne({ orderId });
    if (!order) {
      return res.status(404).json({ message: 'Order not found' });
    }

    const item = order.orderItems.find(item => item.ord_id.toString() === itemId);
    if (!item) {
      return res.status(404).json({ message: 'Item not found in order' });
    }

    item.status = status;


    await updateOrderStatus(order);

    res.status(200).json({
      success: true,
      message: 'Item status updated successfully',
      orderStatus: order.status,    
      orderId: order._id
    });
  } catch (error) {
    console.error('Error updating item status:', error.stack);
    res.status(500).json({ message: 'An error occurred while updating the status.' });
  }
};


exports.verifyReturn = async (req, res) => {
  console.log("verifyReturn hit");
  console.log("Params:", req.params);
  console.log("Body:", req.body);

  try {
    const { orderId } = req.params;
    const { itemId, action } = req.body;

    const order = await Order.findOne({ orderId });
    console.log("Order found?", !!order);

    if (!order) {
      return res.status(404).json({ success: false, message: 'Order not found' });
    }

    const item = order.orderItems.find(i => i.ord_id.toString() === itemId);
    console.log("Item found?", !!item, "Status:", item?.status);

    if (!item || item.status !== 'return requested') {
      return res.status(400).json({ success: false, message: 'Invalid item or status' });
    }

    if (action === 'accepted') {
      item.status = 'returned';
      
    await Product.findByIdAndUpdate(item.product, { $inc: { quantity: item.quantity } });
    } else if (action === 'rejected') {
      item.status = 'return rejected';
    } else {
      return res.status(400).json({ success: false, message: 'Invalid action' });
    }


    await updateOrderStatus(order);
    console.log("Order saved");

    return res.status(200).json({
      success: true,
      message: `Return request ${action}ed successfully`,
      orderStatus: order.status   // ← For live update
    });
  } catch (error) {
    console.error('Error verifying return:', error);
    return res.status(500).json({
      success: false,
      message: 'Internal Server Error',
    });
  }
};



models/useSchema.js

const mongoose = require('mongoose')
const {Schema} = mongoose;

const userSchema = new mongoose.Schema({
    name:{
        type :String,
        required:true
    },
    email:{
        type:String,
        required:true,
        unique:true
    },
    phone:{
        type:String,
        required:false,
        unique:false,
        sparse:true,
        default:null
    },
    googleId:{
        type:String,
        unique:true,
        sparse:true  // Add this line - allows multiple null values
    },
    password:{
        type:String,
        select:false
    },
    isBlocked:{
        type:Boolean,
        default:false
    },
    isAdmin:{
        type:Boolean,
        default:false
    },
    cart:[{
        type:Schema.Types.ObjectId,
        ref:"Cart"
    }],
    wallet:{
        type:Number,
        default:0
    },
    wishList:[{
        type:Schema.Types.ObjectId,
        ref:"WhishList"
    }],
    orderHistory:[{
        type:Schema.Types.ObjectId,
        ref:"Order"
    }],
    createdOn:{
        type:Date,
        default:Date.now
    },
    referalCode:{
        type:String
    },
    redeemed:{
        type:Boolean
    },
    redeemedUsers:[{
        type:Schema.Types.ObjectId,
        ref:"User"
    }],
    searchHistory:[{
        category:{
            type:Schema.Types.ObjectId,
            ref:"Category"
        },
        brand:{
            type:String
        },
        searchOn:{
            type:Date,
            default:Date.now
        }
    }]
},{timestamps:true})

const User = mongoose.model("User",userSchema);

module.exports = User;


models/orderSchema.js


const mongoose = require('mongoose');
const { Schema } = mongoose;
const { v4: uuidv4 } = require('uuid');
const { string } = require('zod');
const { required } = require('zod/mini');

const generateOrderId = () => {
  const datePart = new Date().toISOString().slice(0,10).replace(/-/g, ''); 
  const uuidPart = uuidv4().replace(/-/g, '').substring(0, 6).toUpperCase(); 
  return `ORD-${datePart}-${uuidPart}`; 
};

const generateOrderItemId = () => {
  const datePart = new Date().toISOString().slice(0,10).replace(/-/g, '');
  const uuidPart = uuidv4().replace(/-/g, '').substring(0, 6).toUpperCase();
  return `ITEM-${datePart}-${uuidPart}`;
};

const orderSchema = new mongoose.Schema({
  orderId: {
    type: String,
    default:generateOrderId,
    unique: true
  },
  user: {
    type: Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  orderItems: [{
    ord_id:{
      type:String,
      default:generateOrderItemId ,
      unique:true
    },
    product: {
      type: Schema.Types.ObjectId,
      ref: 'Product',
      required: true
    },
    purchasePrice: {
      type: Number,
      required: true
    },
    quantity: {
      type: Number,
      required: true
    },
    status: {
      type: String,
      enum: ['ordered', 'shipped', 'delivered', 'cancelled','return requested','return rejected','returned'],
      default: 'ordered'
    },
    productName: {
      type: String,
      required: true
    },
    productImage: {
      type: String
    }
  }],
  totalPrice: {
    type: Number,
    required: true
  },
  discount: {
    type: Number,
    default: 0
  },
  finalAmount: {
    type: Number,
    required: true
  },
  address: {
    fullName: { type: String, required: true },
    address: { type: String, required: true },
    city: { type: String, required: true },
    state: { type: String, required: true },
    country: { type: String, required: true },
    pincode: { type: Number, required: true },
    phone: { type: String, required: true },
    addressType: { type: String, required: true },
    isDefault: { type: Boolean, default: false }
  },
  invoiceDate: {
    type: Date
  },
  status: {
  type: String,
  required: true,
  enum: [
    'pending',
    'processing',
    'shipped',
    'delivered',
    'cancelled',
    'returned',
    'partially_returned',
    'partially_cancelled',
    'return_requested',
    'return_rejected',
    'return_approved',
    'payment_failed'
  ],
  default: 'pending'
},
  createdOn: {
    type: Date,
    default: Date.now,
    required: true
  },
  couponApplied: {
    type: Boolean,
    default: false
  },
  message: {
    type: String
  },
  timeline: [{
  label: { type: String, required: true },   // e.g. "Ordered", "Shipped"
  completed: { type: Boolean, default: false },
  current: { type: Boolean, default: false },
  date: { type: Date }
}],
  paymentId: {
    type: String,
    ref: 'Payment',
    required:false
  },
  paymentMethod: {
    type: String,
    required: true
  },
  shipping: {
    type: Number,
    required: true
  },
  tax: {
    type: Number,
    required: true
  }
}, { timestamps: true });

const Order = mongoose.model("Order", orderSchema);
module.exports = Order;


models/couponSchema.js

const mongoose = require('mongoose');
const { Schema } = mongoose;

const couponSchema = new Schema({
  name: {
    type: String,
    required: true,
    unique: true
  },
  couponCode: {
    type: String,
    required: true,
    unique: true
  },
  createdOn: {
    type: Date,
    default: Date.now,
    required: true
  },
  expireOn: {
    type: Date,
    required: true
  },
  offerPrice: {
    type: Number,
    required: true
  },
  minimumPrice: {
    type: Number,
    required: true
  },
  usageLimit: {
    type: Number,
    default: 1
  },
  quantity: {
    type: Number,
    default: 1
  },
  isListed: {
    type: Boolean,
    default: true,
    required: true
  },
  userId: {
    type: Schema.Types.ObjectId,
    ref: "User"
  }
});


const Coupon = mongoose.model("Coupen",couponSchema)
module.exports = Coupon



models/transactionSchema.js

const mongoose = require('mongoose');

const transactionSchema = new mongoose.Schema({
  userId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  orderId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Order'
  },
  amount: {
    type: Number,
    required: true
  },
  type: {
    type: String,
    enum: ['credit', 'debit', 'refund'],
    required: true
  },
  status: {
    type: String,
    enum: ['pending', 'completed', 'rejected'],
    default: 'completed'
  },
  description: {
    type: String,
    default: ''
  },
  date: {
    type: Date,
    default: Date.now
  }
}, { timestamps: true });

module.exports = mongoose.model('Transaction', transactionSchema);


===== C:\Users\HP\OneDrive\Desktop\pure botanica\routes\adminRouter.js =====
const express = require('express')
const router = express.Router();
const adminController = require('../controllers/admin/adminController')
const {userAuth,adminAuth} = require('../middlewares/auth')
const customerController = require('../controllers/admin/customerController')
const categoryController = require('../controllers/admin/categoryController')
const productController = require('../controllers/admin/productController')
const orderController = require('../controllers/admin/orderController')

const uploads = require('../utils/multer');
const path = require('path')

router.get('/admin-error',adminController.pageError)

router.get('/login',adminController.loadLogin)
router.post('/login',adminController.login)
router.get('/dashboard',adminAuth,adminController.loadDashboard)
router.get('/logout',adminController.logout)
//customer managent
router.get('/users',adminAuth,customerController.customerInfo)
router.post('/block/:id',adminAuth,customerController.customerBlocked)
router.post('/unblock/:id',adminAuth,customerController.customerUnblocked)

//category management
router.get('/category',adminAuth,categoryController.categoryInfo)
router.post('/addCategory',adminAuth,categoryController.addCategory)
router.put('/listCategory',adminAuth,categoryController.getListCategory);
router.put('/unListCategory',adminAuth,categoryController.getUnlistCategory)


router.get('/edit-category/:id',adminAuth,categoryController.getEditCategory)
router.post('/edit-category/:id',adminAuth,categoryController.editCategory)

//Product management
router.get('/add-product',adminAuth,productController.getproductAddPage);
router.post('/add-product',adminAuth,uploads.array("images",4),productController.addProducts)
router.get('/product-list',adminAuth,productController.getAllproducts)
router.put('/blockProduct/:id',adminAuth,productController.blockProduct)
router.put('/unblockProduct/:id',adminAuth,productController.unblockProduct)
router.get('/edit-product/:id',adminAuth,productController.getEditProduct)
router.post('/update-product/:id',adminAuth,uploads.array("images",4),productController.updateProduct)


router.get("/orders",  orderController.renderOrderManage);
router.get("/order/details/:orderId", orderController.renderOrderDetails);
router.get("/order/orderId", orderController.getOrderById);
router.post('/order/update-status/:orderId', orderController.updateOrderStatus);        
// router.post('/order/update-all-items/:orderId', orderController.updateAllItemsStatus);
router.post('/order/verify-return/:orderId', orderController.verifyReturn);



module.exports = router
===== C:\Users\HP\OneDrive\Desktop\pure botanica\routes\userRouter.js =====
const express = require('express')
const router = express.Router()
const passport = require('passport')
const { isLoggedIn } = require('../middlewares/auth');

const userController = require('../controllers/user/userController')
const profileController = require('../controllers/user/profileController')
const shopController = require('../controllers/user/shopController');
const orderController = require('../controllers/user/orderController');
const addressController = require('../controllers/user/addressController')
const cartController = require('../controllers/user/cartController')
const checkoutController = require('../controllers/user/checkoutController')
const forgotPassController = require('../controllers/user/forgotPassController')        
const { signupSchema, loginSchema} = require('../validators/authValidators');
const walletController = require('../controllers/user/walletController')
const wishlistController = require('../controllers/user/wishlistController')
const couponController = require('../controllers/user/couponController')



const { userAuth } = require('../middlewares/auth');
const validate = require('../middlewares/validate');

router.get('/',userController.loadHomePage)
router.get('/pageNotFound',userController.pageNotFound)
router.get('/signup',userController.loadSignup)
router.post('/signup',validate(signupSchema, 'user/signup'),userController.signup)      
router.get('/verify-otp',userController.loadOtp)
router.post('/verify-otp',userController.verifyOtp)
router.post("/resend-otp",userController.resendOtp)

//Forgot password
router.get('/forgot-password', forgotPassController.getForgotPassPage);
router.post('/forgot-password' ,forgotPassController.sendForgotOtp);
router.get('/reset-otp', forgotPassController.loadOtpPage);
router.post('/reset-otp', forgotPassController.forgotVerifyOtp);
router.post('/resend-otp', forgotPassController.forgotResendOtp);
router.get('/reset-password', forgotPassController.loadResetPasswordPage);
router.post('/reset-password', forgotPassController.resetPassword);

router.get('/login',userController.loadLogin)
router.post('/login',validate(loginSchema, 'user/login'),userController.login)
router.get('/logout',userController.logout)

// Google authentication
router.get('/auth/google',
   passport.authenticate('google', { scope: ['profile', 'email'] })
);

router.get('/google/callback',
  (req, res, next) => {
    console.log('=== Google Callback Hit ===');
    console.log('Full URL:', req.url);
    console.log('Query params:', req.query);
    console.log('Session ID:', req.sessionID);
    next();
  },
  passport.authenticate('google', { failureRedirect: '/signup' }),
  (req, res) => {
    console.log('=== Auth Successful ===');
    console.log('User object:', req.user);
    console.log('Is authenticated:', req.isAuthenticated());

    if(req.user.isBlocked){
      req.logout(()=>{
        req.session.destroy();
        return res.redirect('/login?blocked=true')
      })
    }else{
      req.session.user = req.user._id
      res.redirect('/');
    }
  }
);

// Profile management
router.get('/profile', userAuth, profileController.loadUserProfile)
router.get('/profile/:id', userAuth, profileController.userProfile)
router.post('/send-emailOtp',userAuth,profileController.sendEmailOtp)
router.post('/verify-email-otp',userAuth,profileController.verifyEmailOtp)
router.post('/resend-emailOtp',userAuth,profileController.resendEmailOtp)
router.post('/update-profile',userAuth, profileController.updateProfile)
router.post('/change-password',userAuth,profileController.updatePassword)

// Address management
router.get('/address', userAuth, addressController.loadAddress);
router.get('/address/:id', userAuth, addressController.getAddress);
router.post('/address/add', userAuth,addressController.addAddress);
router.put('/address/edit/:id', userAuth, addressController.editAddress);
router.delete('/address/:id', userAuth, addressController.deleteAddress);

// Shop
router.get('/shop', userAuth, shopController.loadShopPage);
router.get('/api/products', shopController.getProductsApi);
router.get('/product/availability/:id', shopController.checkProductAvailability);       
router.get('/product/:id',isLoggedIn, shopController.loadProductPage);

// Order management
router.get('/orders', userAuth, orderController.loadOrderPage);
router.get('/order-details/:orderId', userAuth, orderController.getOrderDetailsPage);   
router.post('/orders/:orderId/cancel-item', userAuth, orderController.cancelItem);      
router.post('/orders/:orderId/return', userAuth, orderController.returnItem);

// Cart management
router.get('/cart', userAuth, cartController.getCartPage);
router.post('/cart/add', userAuth, cartController.addToCart);
router.post('/cart/update', userAuth, cartController.updateCartQuantity);
router.post('/cart/remove', userAuth, cartController.removeFromCart);
router.post('/cart/contents', userAuth, cartController.getCartContents);
router.post('/cart/quantity', userAuth, cartController.getCartQuantity);
router.post('/cart/summary', userAuth, cartController.getCartSummary);
router.post('/cart/check-quantity',userAuth,cartController.getCountInCart)

// Checkout management
router.get('/checkout', userAuth, checkoutController.getCheckoutPage);
router.post('/checkout/place-order', userAuth, checkoutController.placeOrder);
router.post('/checkout/verify-razorpay',userAuth,checkoutController.verifyRazorpayPayment)
router.get('/order-success', userAuth, checkoutController.getOrderSuccessPage);
router.get('/order-error', userAuth, checkoutController.getOrderErrorPage);
router.post('/add-address', userAuth, checkoutController.addAddress);
router.get('/get-address/:addressId', userAuth, checkoutController.getAddress);
router.put('/edit-address/:addressId', userAuth, checkoutController.editAddress);       
router.delete('/remove-address/:addressId', userAuth, checkoutController.removeAddress);

//wallet management

router.get('/wallet', userAuth, walletController.getWallet);
router.post('/wallet/toggle-default', userAuth, walletController.toggleDefault);



//Wishlist
router.get('/wishlist',userAuth,wishlistController.getWishlist)
router.post('/wishlist/toggle',userAuth,wishlistController.toggleWishlist)
router.post('/wishlist/remove',userAuth,wishlistController.removeFromWishList)
router.get('/wishlist/count', userAuth, wishlistController.getWishListCount);
router.post('/wishlist/clear', userAuth, wishlistController.clearWishList);


//coupon Management
router.post('/apply-coupon',userAuth,couponController.applyCoupon)

module.exports = router



views/user/checkout.ejs

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Beauty Cart - Checkout</title>
  <!-- Razorpay SDK -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script> 
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: "Lato", sans-serif;
      background-color: #f9fafb;
      padding-top: 100px;
    }

    .input-field {
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }

    .input-field:focus {
      border-color: palevioletred;
      outline: none;
      box-shadow: 0 0 0 2px pink;
    }

    .input-field.error {
      border-color: #ef4444;
      box-shadow: 0 0 0 1px #ef4444;
    }

    .error-message {
      color: #ef4444;
      font-size: 0.75rem;
      margin-top: 0.25rem;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .address-card,
    .payment-option {
      transition: all 0.2s ease;
      border: 1px solid #e5e7eb;
      cursor: pointer;
    }

    .address-card.selected,
    .payment-option.selected {
      border-color: palevioletred;
      box-shadow: 0 0 0 1px pink;
    }

    .address-card:hover,
    .payment-option:hover {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    input[type="radio"]:disabled+label {
      color: #a0aec0;
      cursor: not-allowed;
    }

    .payment-option input[type="radio"]:disabled + label {
      pointer-events: none;
    }

    .payment-option.disabled {
      cursor: not-allowed;
    }

    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      height: 80px;
    }

    .section-card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
    }
  </style>
</head>

<body>
  <%- include('../partials/user/header') %>

      <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
      <h1 class="text-3xl font-bold mb-8 text-center text-gray-800">
        Checkout
      </h1>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- LEFT: Addresses + Payment (2 columns on desktop) -->
        <div class="lg:col-span-2 space-y-6">
          <form action="/checkout/place-order" method="POST" id="checkout-form">

            <!-- Address Section -->
            <div class="section-card">
              <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-map-marker-alt mr-2 text-gray-600"></i>
                Shipping Address
              </h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="address-list">
                <% if (userAddresses && Array.isArray(userAddresses) && userAddresses.length> 0) { %>
                  <% userAddresses.forEach((addr) => { %>
                    <div class="address-card bg-gray-50 border rounded-lg p-4 <%= addr.isDefault ? 'selected' : '' %>"
                      data-address-id="<%= addr._id %>">
                      <div class="flex items-start mb-3">
                        <input type="radio" name="selectedAddress" id="address-<%= addr._id %>"
                          value="<%= addr._id %>" <%= addr.isDefault ? 'checked' : '' %> class="mt-1 mr-2">
                        <div class="flex-1">
                          <label for="address-<%= addr._id %>"
                            class="font-medium text-gray-800 block mb-1 cursor-pointer">
                            <%= addr.name || addr.fullName || 'Unnamed Address' %>
                          </label>
                          <div class="flex flex-wrap gap-1 mb-2">
                            <span class="inline-block bg-gray-200 text-gray-700 px-2 py-1 text-xs rounded">
                              <%= addr.addressType || 'Unknown' %>
                            </span>
                            <% if (addr.isDefault) { %>
                              <span class="inline-block bg-black text-white px-2 py-1 text-xs rounded">
                                Default
                              </span>
                              <% } %>
                          </div>
                          <p class="text-gray-600 text-sm leading-relaxed">
                            <%= addr.address || 'N/A' %><br />
                            <%= addr.city || 'N/A' %>, <%= addr.state || 'N/A' %><br />
                            <%= addr.country || 'N/A' %> - <%= addr.pinCode || addr.pincode || 'N/A' %><br />
                            Phone: <%= addr.phone || 'N/A' %>
                            <% if (addr.altPhone) { %>
                              <br />Alt Phone: <%= addr.altPhone %>
                              <% } %>
                          </p>
                        </div>
                      </div>
                      <div class="flex justify-end space-x-2 mt-3 pt-3 border-t border-gray-200 text-sm">
                        <a href="#" class="text-black hover:text-gray-600 edit-address"
                          data-address-id="<%= addr._id.toString() %>">
                          <i class="fas fa-edit mr-1"></i>Edit
                        </a>
                        <span class="text-gray-300">|</span>
                        <a href="#" class="text-gray-600 hover:text-red-600 remove-address"
                          data-address-id="<%= addr._id %>">
                          <i class="fas fa-trash mr-1"></i>Remove
                        </a>
                      </div>
                    </div>
                    <% }) %>
                      <% } else { %>
                        <div id="no-address-message"
                          class="col-span-2 text-red-500 text-sm text-center p-4 bg-red-50 rounded-lg">
                          <i class="fas fa-exclamation-circle mr-2"></i>
                          No shipping addresses available. Please add an address to proceed.
                        </div>
                        <% } %>
              </div>

              <button type="button" id="add-address-btn"
                class="mt-6 flex items-center text-black hover:text-gray-700 transition">
                <i class="fas fa-plus-circle mr-2"></i>
                <span class="font-medium">Add New Address</span>
              </button>

              <div id="address-error" class="text-red-500 text-sm mt-3 hidden bg-red-50 p-2 rounded">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Please select a shipping address before proceeding.
              </div>
            </div>

            <!-- Payment Section -->
            <div class="section-card">
              <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-credit-card mr-2 text-gray-600"></i>
                Payment Method
              </h2>
              <div class="space-y-3">

                <!-- COD Option -->
                <div class="payment-option bg-gray-50 rounded-lg p-4 selected">
                  <div class="flex items-center">
                    <input type="radio" id="cod" name="paymentMethod" value="cod" class="mr-3" checked />
                    <label for="cod" class="flex items-center cursor-pointer w-full">
                      <div class="bg-white p-3 rounded-lg mr-3 shadow-sm">
                        <i class="fas fa-money-bill-wave text-green-600 text-lg"></i>
                      </div>
                      <div>
                        <span class="font-medium text-gray-800 block">Cash on Delivery</span>
                        <span class="text-sm text-gray-500">Pay when you receive your order</span>
                      </div>
                    </label>
                  </div>
                </div>

                <!-- UPI Option (Disabled) -->
                <!-- UPI Option (Now Enabled) -->
<div class="payment-option bg-gray-50 rounded-lg p-4">
  <div class="flex items-center">
    <input type="radio" id="razorpay" name="paymentMethod" value="razorpay" class="mr-3" />
    <label for="razorpay" class="flex items-center cursor-pointer w-full">
      <div class="bg-white p-3 rounded-lg mr-3 shadow-sm">
        <i class="fas fa-credit-card text-indigo-600 text-lg"></i>
      </div>
      <div>
        <span class="font-medium text-gray-800 block flex items-center gap-2">
          Razorpay
        </span>
        <span class="text-sm text-gray-500">Credit/Debit Card, Net-Banking, UPI, Wallet</span>
      </div>
    </label>
  </div>
</div>

                <div class="payment-option bg-gray-50 rounded-lg p-4">
      <div class="flex items-center">
        <input type="radio" id="wallet" name="paymentMethod" value="wallet" class="mr-3" />
        <label for="wallet" class="flex items-center cursor-pointer w-full">
          <div class="bg-white p-3 rounded-lg mr-3 shadow-sm">
            <i class="fas fa-wallet text-purple-600 text-lg"></i>
          </div>
          <div>
            <span class="font-medium text-gray-800 block flex items-center gap-2">
              Wallet
            </span>
            <span class="text-sm text-gray-500">Pay using available wallet balance</span>
          </div>
        </label>
      </div>
    </div>

                <div id="payment-error" class="text-red-500 text-sm hidden bg-red-50 p-2 rounded">
                  <i class="fas fa-exclamation-triangle mr-2"></i>
                  Please select a payment method before proceeding.
                </div>
              </div>

              <button type="submit" id="place-order-btn"
                class="w-full bg-black text-white py-3 rounded-lg hover:bg-gray-800 transition mt-6 font-medium shadow-md"
                <%= userAddresses && Array.isArray(userAddresses) && userAddresses.length> 0 ? '' : 'disabled' %>>
                <i class="fas fa-lock mr-2"></i>
                Place Order
              </button>

              <div class="mt-4 flex items-center justify-center text-gray-500 text-sm">
                <i class="fas fa-shield-alt mr-2 text-green-500"></i>
                Secure Checkout - Your information is safe with us
              </div>
            </div>

          </form>
        </div>

        <!-- RIGHT: Order Summary (1 column on desktop) -->
        <div class="lg:col-span-1">
          <div class="section-card sticky top-24">
            <h2 class="text-lg font-bold mb-4 text-gray-800 pb-3 border-b flex items-center">
              <i class="fas fa-shopping-bag mr-2 text-gray-600"></i>
              Order Summary
            </h2>

            <div class="space-y-3 mb-6">
              <% cart.items.forEach((item) => { %>
                <div class="flex justify-between items-start pb-3 border-b border-gray-100">
                  <div class="flex-1">
                    <p class="font-medium text-sm text-gray-800">
                      <%= item.productId.productName %>
                    </p>
                    <p class="text-xs text-gray-500 mt-1">Quantity: <%= item.quantity %>
                    </p>
                  </div>
                  <p class="font-medium text-sm">₹<%= (item.productId.salePrice * item.quantity).toFixed(2) %>
                  </p>
                </div>
                <% }) %>

                  <div class="space-y-2 pt-2">
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-600">Subtotal</span>
                      <span class="font-medium">₹<%= subtotal.toFixed(2) %></span>
                    </div>
                    <% if (discount> 0) { %>
                      <div class="flex justify-between text-sm text-green-600">
                        <span>Discount</span>
                        <span class="font-medium">-₹<%= discount.toFixed(2) %></span>
                      </div>
                      <% } %>
                        <div class="flex justify-between text-sm">
                          <span class="text-gray-600">Shipping</span>
                          <span class="font-medium">₹<%= shippingCost.toFixed(2) %></span>
                        </div>
                        <div class="flex justify-between text-sm">
                          <span class="text-gray-600">Tax</span>
                          <span class="font-medium">₹<%= tax.toFixed(2) %></span>
                        </div>
                  </div>

                  <div class="flex justify-between font-bold text-lg pt-4 border-t-2 border-gray-200">
                    <span>Total</span>
                    <span class="text-black">₹<%= total.toFixed(2) %></span>
                  </div>
            </div>

            <div class="bg-gray-50 p-3 rounded-lg text-center">
              <p class="text-xs text-gray-600">
                <i class="fas fa-truck mr-1"></i>
                Free delivery on orders above ₹999
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Address Modal -->
    <div id="address-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-20 mx-auto p-6 border max-w-md w-full shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-semibold text-gray-800">Add New Address</h3>
          <button id="close-modal" class="text-gray-500 hover:text-gray-700 transition">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <form id="new-address-form">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
              <input type="text" name="fullName" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-fullName"></div>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
              <input type="tel" name="phone" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-phone"></div>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
              <input type="text" name="address" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-address"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
              <input type="text" name="city" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-city"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
              <input type="text" name="state" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-state"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Country</label>
              <input type="text" name="country" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-country"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Pincode</label>
              <input type="text" name="pincode" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-pincode"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Address Type</label>
              <select name="addressType" class="input-field w-full px-3 py-2 rounded-md bg-white">
                <option value="Home">Home</option>
                <option value="Work">Work</option>
                <option value="Other">Other</option>
              </select>
              <div class="error-message" id="error-addressType"></div>
            </div>
            <div class="md:col-span-2">
              <div class="flex items-center mt-2">
                <input type="checkbox" name="isDefault" id="isDefault" class="h-4 w-4 text-black rounded" />
                <label for="isDefault" class="ml-2 text-sm text-gray-700">Set as default address</label>
              </div>
            </div>
          </div>

          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" id="cancel-address"
              class="px-5 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition text-gray-800 font-medium">
              Cancel
            </button>
            <button type="submit" id="save-address-btn"
              class="px-5 py-2 bg-black rounded-lg text-white hover:bg-gray-800 transition font-medium">
              Save Address
            </button>
          </div>
        </form>
      </div>
    </div>

    <%- include('../partials/user/footer') %>



      <!-- 3. REPLACE YOUR ENTIRE <script> WITH THIS -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const addAddressBtn = document.getElementById("add-address-btn");
    const addressModal = document.getElementById("address-modal");
    const cancelAddressBtn = document.getElementById("cancel-address");
    const closeModalBtn = document.getElementById("close-modal");
    const newAddressForm = document.getElementById("new-address-form");
    const saveAddressBtn = document.getElementById("save-address-btn");
    const checkoutForm = document.getElementById("checkout-form");
    const placeOrderBtn = document.getElementById("place-order-btn");
    const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');
    const paymentOptions = document.querySelectorAll(".payment-option");
    let isEditMode = false;
    let currentAddressId = null;

    // SweetAlert2 shortcut
    const Swal = window.Swal || window.SweetAlert2;

    // Auto-open modal if no addresses
    if (document.querySelectorAll(".address-card").length === 0) {
      addAddressBtn.click();
    }

    // Open modal
    addAddressBtn.addEventListener("click", () => {
      isEditMode = false;
      currentAddressId = null;
      document.querySelector("#address-modal h3").textContent = "Add New Address";
      newAddressForm.reset();
      clearErrors();
      addressModal.classList.remove("hidden");
    });

    // Close modal
    function closeModal() {
      addressModal.classList.add("hidden");
      newAddressForm.reset();
      clearErrors();
      isEditMode = false;
      currentAddressId = null;
      document.querySelector("#address-modal h3").textContent = "Add New Address";
    }
    cancelAddressBtn.addEventListener("click", closeModal);
    closeModalBtn.addEventListener("click", closeModal);
    addressModal.addEventListener("click", e => e.target === addressModal && closeModal());

    // Address selection
    document.querySelectorAll(".address-card").forEach(card => {
      const radio = card.querySelector('input[type="radio"]');
      card.addEventListener("click", e => {
        if (e.target.tagName !== "A") {
          document.querySelectorAll(".address-card").forEach(c => c.classList.remove("selected"));
          card.classList.add("selected");
          radio.checked = true;
          document.getElementById("address-error").classList.add("hidden");
          placeOrderBtn.disabled = false;
        }
      });
    });

    // Payment selection
    paymentRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        paymentOptions.forEach(opt => {
          opt.classList.toggle("selected", opt.querySelector('input[type="radio"]') === radio);
        });
        document.getElementById("payment-error").classList.add("hidden");
      });
    });
    paymentOptions.forEach(opt => {
      opt.addEventListener("click", () => {
        const radio = opt.querySelector('input[type="radio"]');
        if (radio && !radio.disabled) {
          radio.checked = true;
          radio.dispatchEvent(new Event("change"));
        }
      });
    });

    // Edit Address
    document.querySelectorAll(".edit-address").forEach(btn => {
      btn.addEventListener("click", async e => {
        e.preventDefault();
        const id = btn.dataset.addressId;
        try {
          const res = await fetch(`/get-address/${id}`);
          const data = await res.json();
          if (data.success) {
            const a = data.addresses[0];
            document.querySelector('[name="fullName"]').value = a.fullName || a.name || "";
            document.querySelector('[name="phone"]').value = a.phone || "";
            document.querySelector('[name="address"]').value = a.address || "";
            document.querySelector('[name="city"]').value = a.city || "";
            document.querySelector('[name="state"]').value = a.state || "";
            document.querySelector('[name="country"]').value = a.country || "";
            document.querySelector('[name="pincode"]').value = a.pincode || a.pinCode || "";
            document.querySelector('[name="addressType"]').value = a.addressType || "Home";
            document.querySelector('[name="isDefault"]').checked = !!a.isDefault;

            isEditMode = true;
            currentAddressId = id;
            document.querySelector("#address-modal h3").textContent = "Edit Address";
            clearErrors();
            addressModal.classList.remove("hidden");
          } else {
            Swal.fire("Error", data.message || "Failed to load address", "error");
          }
        } catch (err) {
          Swal.fire("Error", "Could not load address", "error");
        }
      });
    });

    // Remove Address
    document.querySelectorAll(".remove-address").forEach(btn => {
      btn.addEventListener("click", async e => {
        e.preventDefault();
        const id = btn.dataset.addressId;
        Swal.fire({
          title: "Remove address?",
          text: "This cannot be undone.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          confirmButtonText: "Yes, remove"
        }).then(async result => {
          if (result.isConfirmed) {
            try {
              const res = await fetch(`/remove-address/${id}`, { method: "DELETE" });
              const data = await res.json();
              if (data.success) {
                Swal.fire("Removed!", "Address deleted.", "success");
                btn.closest(".address-card").remove();
                const cards = document.querySelectorAll(".address-card");
                placeOrderBtn.disabled = cards.length === 0;
                if (cards.length === 0) {
                  document.getElementById("no-address-message")?.classList.remove("hidden");
                  addAddressBtn.click();
                }
              } else {
                Swal.fire("Error", data.message || "Failed to remove", "error");
              }
            } catch (err) {
              Swal.fire("Error", "Network error", "error");
            }
          }
        });
      });
    });

    // Save Address (Add/Edit)
    newAddressForm.addEventListener("submit", async e => {
      e.preventDefault();
      saveAddressBtn.disabled = true;
      saveAddressBtn.textContent = "Saving...";

      const formData = new FormData(newAddressForm);
      const data = Object.fromEntries(formData);
      data.isDefault = formData.has("isDefault");

      if (!validateForm(data)) {
        Swal.fire("Validation Error", "Please fix the errors in the form", "error");
        saveAddressBtn.disabled = false;
        saveAddressBtn.textContent = "Save Address";
        return;
      }

      const url = isEditMode ? `/edit-address/${currentAddressId}` : "/add-address";
      const method = isEditMode ? "PUT" : "POST";

      try {
        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        const result = await res.json();

        if (res.ok && result.success) {
          Swal.fire("Success", isEditMode ? "Address updated" : "Address added", "success");

          const addressList = document.getElementById("address-list");
          const noMsg = document.getElementById("no-address-message");
          const addr = result.address;

          if (isEditMode) {
            const card = document.querySelector(`.address-card[data-address-id="${currentAddressId}"]`);
            if (card) {
              card.querySelector("label").textContent = addr.fullName || addr.name;
              card.querySelector("p").innerHTML = `${addr.address}<br>${addr.city}, ${addr.state}<br>${addr.country} - ${addr.pincode || addr.pinCode}<br>Phone: ${addr.phone}`;
              card.querySelector(".bg-gray-200").textContent = addr.addressType;
              if (addr.isDefault) {
                document.querySelectorAll(".address-card").forEach(c => c.classList.remove("selected"));
                card.classList.add("selected");
                card.querySelector('input[type="radio"]').checked = true;
              }
            }
          } else {
            const card = document.createElement("div");
            card.className = `address-card bg-gray-50 border rounded-lg p-4 ${addr.isDefault ? "selected" : ""}`;
            card.dataset.addressId = addr._id;
            card.innerHTML = `
              <div class="flex items-start mb-3">
                <input type="radio" name="selectedAddress" id="address-${addr._id}" value="${addr._id}" ${addr.isDefault ? "checked" : ""} class="mt-1 mr-2">
                <div class="flex-1">
                  <label for="address-${addr._id}" class="font-medium text-gray-800 block mb-1 cursor-pointer">
                    ${addr.fullName || addr.name}
                  </label>
                  <div class="flex flex-wrap gap-1 mb-2">
                    <span class="inline-block bg-gray-200 text-gray-700 px-2 py-1 text-xs rounded">${addr.addressType}</span>
                    ${addr.isDefault ? '<span class="inline-block bg-black text-white px-2 py-1 text-xs rounded">Default</span>' : ""}
                  </div>
                  <p class="text-gray-600 text-sm leading-relaxed">
                    ${addr.address}<br>${addr.city}, ${addr.state}<br>${addr.country} - ${addr.pincode || addr.pinCode}<br>Phone: ${addr.phone}
                  </p>
                </div>
              </div>
              <div class="flex justify-end space-x-2 mt-3 pt-3 border-t border-gray-200 text-sm">
                <a href="#" class="text-black hover:text-gray-600 edit-address" data-address-id="${addr._id}"><i class="fas fa-edit mr-1"></i>Edit</a>
                <span class="text-gray-300">|</span>
                <a href="#" class="text-gray-600 hover:text-red-600 remove-address" data-address-id="${addr._id}"><i class="fas fa-trash mr-1"></i>Remove</a>
              </div>
            `;
            addressList.appendChild(card);
            if (noMsg) noMsg.classList.add("hidden");
            placeOrderBtn.disabled = false;

            // Re-attach events
            reattachCardEvents(card);
          }
          closeModal();
        } else {
          Swal.fire("Error", result.message || "Failed to save address", "error");
        }
      } catch (err) {
        Swal.fire("Error", "Network error", "error");
      } finally {
        saveAddressBtn.disabled = false;
        saveAddressBtn.textContent = "Save Address";
      }
    });

    // Re-attach edit/remove/click events to new cards
    function reattachCardEvents(card) {
      card.querySelector(".edit-address").addEventListener("click", editHandler);
      card.querySelector(".remove-address").addEventListener("click", removeHandler);
      card.addEventListener("click", cardClickHandler);
    }
    function editHandler(e) { /* same as above edit logic */ }
    function removeHandler(e) { /* same as above remove logic */ }
    function cardClickHandler(e) {
      if (e.target.tagName !== "A") {
        document.querySelectorAll(".address-card").forEach(c => c.classList.remove("selected"));
        this.classList.add("selected");
        this.querySelector('input[type="radio"]').checked = true;
        document.getElementById("address-error").classList.add("hidden");
        placeOrderBtn.disabled = false;
      }
    }

    // COD / Wallet order submission
    async function submitOrder() {
      const form = checkoutForm;
      const btn = placeOrderBtn;
      btn.disabled = true;
      btn.textContent = "Processing...";

      try {
        const res = await fetch(form.action, {
          method: form.method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(Object.fromEntries(new FormData(form)))
        });
        const data = await res.json();

        if (data.success && data.orderId) {
          Swal.fire({ icon: "success", title: "Order Placed!", text: "Redirecting..." });
          setTimeout(() => location.href = `/order-success?orderId=${data.orderId}&finalAmount=${data.finalAmount}&paymentMethod=${data.paymentMethod}`, 1200);
        } else {
          throw new Error(data.message || "Order failed");
        }
      } catch (err) {
        Swal.fire({ icon: "error", title: "Error", text: err.message });
      } finally {
        btn.disabled = false;
        btn.textContent = "Place Order";
      }
    }

    // MAIN CHECKOUT SUBMIT (handles Razorpay + COD)
    checkoutForm.addEventListener("submit", async e => {
      e.preventDefault();

      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
      const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked')?.value;

      if (!selectedAddress) return Swal.fire({ icon: "error", title: "Address Required", text: "Please select a shipping address" });
      if (!paymentMethod) return Swal.fire({ icon: "error", title: "Payment Required", text: "Please select a payment method" });

      if (paymentMethod !== "razorpay") {
        return submitOrder();
      }

      // RAZORPAY FLOW
      const btn = placeOrderBtn;
      btn.disabled = true;
      btn.textContent = "Creating Order...";

      try {
        const res = await fetch("/checkout/place-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ selectedAddress, paymentMethod })
        });
        const data = await res.json();

        if (!data.success || !data.razorpay) {
          throw new Error(data.message || "Failed to create Razorpay order");
        }

        const options = {
          key: data.key_id,
          amount: data.amount,
          currency: "INR",
          name: "Beauty Cart",
          description: "Order Payment",
          order_id: data.razorpayOrderId,
          handler: async function (response) {
            const verifyRes = await fetch("/checkout/verify-razorpay", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                razorpay_order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_signature: response.razorpay_signature,
                orderId: data.orderId
              })
            });
            const vData = await verifyRes.json();

            if (vData.success) {
              Swal.fire({ icon: "success", title: "Payment Success!", text: "Redirecting..." });
              setTimeout(() => location.href = `/order-success?orderId=${vData.orderId}&finalAmount=${vData.finalAmount}&paymentMethod=${vData.paymentMethod}`, 1500);
            } else {
              Swal.fire({ icon: "error", title: "Payment Failed", text: vData.message || "Verification failed" });
            }
          },
          prefill: {},
          theme: { color: "#000000" },
          modal: {
            ondismiss: () => {
              btn.disabled = false;
              btn.textContent = "Place Order";
              Swal.fire({ icon: "info", title: "Cancelled", text: "Payment was cancelled" });
            }
          }
        };

        const rzp = new Razorpay(options);
        rzp.on("payment.failed", resp => {
          Swal.fire({ icon: "error", title: "Payment Failed", text: resp.error.description });
          btn.disabled = false;
          btn.textContent = "Place Order";
        });
        rzp.open();

      } catch (err) {
        console.error(err);
        Swal.fire({ icon: "error", title: "Error", text: err.message });
        btn.disabled = false;
        btn.textContent = "Place Order";
      }
    });

    // Validation
    function validateForm(data) {
      let valid = true;
      clearErrors();
      const phonePattern = /^\d{10}$/;
      const pinPattern = /^\d{6}$/;

      if (!data.fullName?.trim()) { showError("fullName", "Full name required"); valid = false; }
      if (!data.phone || !phonePattern.test(data.phone) || data.phone === "0000000000") { showError("phone", "Valid 10-digit phone"); valid = false; }
      if (!data.address?.trim()) { showError("address", "Address required"); valid = false; }
      if (!data.city?.trim()) { showError("city", "City required"); valid = false; }
      if (!data.state?.trim()) { showError("state", "State required"); valid = false; }
      if (!data.country?.trim()) { showError("country", "Country required"); valid = false; }
      if (!data.pincode || !pinPattern.test(data.pincode) || data.pincode === "000000") { showError("pincode", "Valid 6-digit pin"); valid = false; }
      if (!data.addressType?.trim()) { showError("addressType", "Address type required"); valid = false; }

      return valid;
    }

    function showError(field, msg) {
      const el = document.querySelector(`[name="${field}"]`);
      const err = document.getElementById(`error-${field}`);
      el.classList.add("error");
      err.textContent = msg;
      err.classList.add("show");
    }

    function clearErrors() {
      newAddressForm.querySelectorAll(".input-field").forEach(i => i.classList.remove("error"));
      newAddressForm.querySelectorAll(".error-message").forEach(d => { d.textContent = ""; d.classList.remove("show"); });
    }
  });
</script>
</body>

</html>



views/user/ordr-details.ejs

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Details</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    
 :root {
      --primary-color: #108a7e;
      --secondary-color: #cce4de;
      --dark-text: #71edd0;
      --light-text: #1b7a72;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--secondary-color);
      font-size: 14px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 24px;
      width: 90%;
      max-width: 480px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      position: relative;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .close {
      position: absolute;
      right: 16px;
      top: 16px;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      transition: color 0.2s ease;
      line-height: 1;
    }
    
    .close:hover {
      color: #1f2937;
    }
    
    .timeline {
      position: relative;
      padding-left: 2.5rem;
      margin-top: 1.5rem;
    }
    
    .timeline::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0.75rem;
      height: 100%;
      width: 3px;
      background: #e5e7eb;
      border-radius: 2px;
    }
    
    .timeline.shipped::before {
      background: #16a34a;
    }
    
    .timeline-item {
      position: relative;
      margin-bottom: 1.25rem;
      padding: 0.5rem 0.75rem;
      background: #f9fafb;
      border-radius: 6px;
      transition: transform 0.3s ease;
    }
    
    .timeline-item:hover {
      transform: translateX(5px);
    }
    
    .timeline-item::before {
      content: '';
      position: absolute;
      top: 8px;
      left: -2rem;
      width: 12px;
      height: 12px;
      background: white;
      border: 2px solid #d1d5db;
      border-radius: 50%;
      box-shadow: 0 0 0 2px white;
    }
    
    .timeline-item.completed::before {
      background: #16a34a;
      border-color: #16a34a;
    }
    
    .timeline-item.active::before {
      background: #16a34a;
      border-color: #16a34a;
      box-shadow: 0 0 0 2px white, 0 0 8px rgba(22, 163, 74, 0.4);
    }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(10, 90, 75, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }
    
    .btn {
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .container {
      max-width: 1200px;
    }
    
    .product-image {
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
 
<body class="min-h-screen pb-12">
  <%- include("../../views/partials/user/header") %>
  <!-- Navigation -->
  <nav class="bg-white p-6 shadow-lg sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center">
      <span class="text-2xl font-bold text-gray-800">Order #<%= order.orderID || 'N/A' %></span>
      <div class="flex items-center gap-4">
        <a href="/orders" class="text-blue-600 font-medium hover:text-blue-800 transition flex items-center">
          <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back to Orders
        </a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mx-auto mt-8 px-4">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Section: Order Items and Timeline -->
      <div class="lg:col-span-2 space-y-8">
        <!-- Order Items -->
        <div class="card p-6">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Order Items</h1>
          
          </div>
          <% if (order.items && order.items.length > 0) { %>
            <% order.items.forEach((item, index) => { %>
              <div class="flex flex-col sm:flex-row items-start gap-6 mb-6 pb-6 <%= index < order.items.length - 1 ? 'border-b' : '' %>">
                <img 
                  src="<%= item.productImage || 'https://via.placeholder.com/100' %>" 
                  alt="<%= item.productName || 'Product' %>" 
                  class="w-32 h-32 product-image"
                  onerror="this.src='https://via.placeholder.com/100'"
                >
                <div class="flex-1 w-full">
                  <h2 class="text-xl font-semibold text-gray-800 mb-2"><%= item.productName || 'Product Name Not Available' %></h2>
                  <div class="space-y-1 mb-3">
                    <p class="text-gray-600">Quantity: <span class="font-medium"><%= item.quantity || 1 %></span></p>
                    <p class="text-gray-600">Status: 
                      <span class="capitalize font-medium <%= item.productStatus === 'delivered' ? 'text-green-600' : item.productStatus === 'cancelled' ? 'text-red-600' : 'text-yellow-600' %>">
                        <%= item.productStatus || 'Unknown' %>
                      </span>
                    </p>
                  </div>
                  <p class="text-2xl font-bold text-green-600 mb-4">
                    ₹<%= typeof item.purchasePrice === 'number' && !isNaN(item.purchasePrice) ? item.purchasePrice.toFixed(2) : '0.00' %>
                  </p>
                  <div class="flex flex-wrap gap-3">
                    <% if (['ordered', 'pending'].includes(item.productStatus)) { %>
                      <button 
                        onclick="showCancelItemModal('<%= order._id %>', '<%= item.productId %>')" 
                        class="bg-red-100 text-red-600 px-5 py-2 rounded-lg border border-red-200 btn hover:bg-red-200 font-medium"
                      >
                        Cancel Item
                      </button>
                    <% } %>
                    <% if (item.productStatus === 'delivered') { %>
                      <button 
                        onclick="returnItem('<%= order._id %>', '<%= item.productId %>')" 
                        class="bg-yellow-100 text-yellow-600 px-5 py-2 rounded-lg border border-yellow-200 btn hover:bg-yellow-200 font-medium"
                      >
                        Request Return
                      </button>
                    <% } %>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-gray-500 text-lg text-center py-8">No items found in this order.</p>
          <% } %>
        </div>

        <!-- Order Timeline -->
        <div class="card p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">Order Timeline</h2>
          <div class="timeline <%= order.items && order.items.some(item => ['shipped', 'delivered'].includes(item.productStatus)) ? 'shipped' : '' %>">
            <% if (order.timeline && order.timeline.length > 0) { %>
              <% order.timeline.forEach(step => { %>
                <div class="timeline-item <%= step.current ? 'active' : (step.completed ? 'completed' : '') %>">
                  <h3 class="text-base font-semibold text-gray-800"><%= step.title || 'Status Update' %></h3>
                  <% if (step.completed && step.date) { %>
                    <p class="text-gray-500 text-xs mt-0.5">
                      <%= new Date(step.date).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' }) %>
                    </p>
                  <% } else if (step.completed) { %>
                    <p class="text-gray-500 text-xs mt-0.5">
                      <%= new Date(order.orderDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' }) %>
                    </p>
                  <% } else { %>
                    <p class="text-gray-400 italic text-xs mt-0.5">Pending</p>
                  <% } %>
                </div>
              <% }) %>
            <% } else { %>
              <p class="text-gray-500">No timeline information available.</p>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Right Section: Order Summary and Address -->
      <div class="space-y-8">
        <!-- Order Summary -->
        <div class="card p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Order Summary</h2>
          <div class="space-y-3 text-gray-600">
            <div class="flex justify-between">
              <span>Subtotal</span>
              <span class="font-medium">₹<%= order.subtotal ? order.subtotal.toFixed(2) : '0.00' %></span>
            </div>
            <div class="flex justify-between">
              <span>Shipping</span>
              <span class="font-medium">₹<%= order.shipping ? order.shipping.toFixed(2) : '0.00' %></span>
            </div>
            <div class="flex justify-between">
              <span>Tax</span>
              <span class="font-medium">₹<%= order.tax ? order.tax.toFixed(2) : '0.00' %></span>
            </div>
            <!-- <% if (order.couponApplied && order.couponDiscount > 0) { %>
              <div class="flex justify-between text-green-600">
                <span>Coupon Discount</span>
                <span class="font-medium">-₹<%= order.couponDiscount.toFixed(2) %></span>
              </div>
            <% } %> -->
            <div class="flex justify-between font-bold text-lg text-gray-800 pt-3 border-t-2">
              <span>Total</span>
              <span>₹<%= order.total ? order.total.toFixed(2) : '0.00' %></span>
            </div>
            <% if (order.totalWarning) { %>
              <p class="text-red-600 text-sm mt-2 p-2 bg-red-50 rounded"><%= order.totalWarning %></p>
            <% } %>
          </div>
          
          <hr class="my-6 border-gray-200">
          
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Payment Method:</span>
              <span class="font-medium text-gray-800"><%= order.paymentMethod || 'N/A' %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Payment Status:</span>
              <span class="font-semibold <%= order.paymentStatus === 'Paid' ? 'text-green-600' : 'text-red-600' %>">
                <%= order.paymentStatus || 'Pending' %>
              </span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Transaction ID:</span>
              <span class="font-medium text-gray-800 break-all"><%= order.transactionId || 'N/A' %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Order Date:</span>
              <span class="font-medium text-gray-800">
                <%= new Date(order.orderDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' }) %>
              </span>
            </div>
            <% if (order.invoiceDate) { %>
              <div class="flex justify-between">
                <span class="text-gray-600">Invoice Date:</span>
                <span class="font-medium text-gray-800">
                  <%= new Date(order.invoiceDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' }) %>
                </span>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Shipping Address -->
        <div class="card p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Shipping Address</h2>
          <div class="space-y-2 text-gray-700">
            <p class="font-semibold text-gray-800 text-lg"><%= order.shippingAddress.name || 'N/A' %></p>
            <p><%= order.shippingAddress.address || '' %></p>
            <p><%= order.shippingAddress.city || '' %>, <%= order.shippingAddress.state || '' %></p>
            <p><%= order.shippingAddress.country || '' %> - <%= order.shippingAddress.pinCode || '' %></p>
            <p class="pt-2"><span class="font-medium">Phone:</span> <%= order.shippingAddress.phone || 'N/A' %></p>
            <% if (order.shippingAddress.addressType) { %>
              <p><span class="font-medium">Type:</span> <span class="capitalize"><%= order.shippingAddress.addressType %></span></p>
            <% } %>
          </div>
          <button 
            onclick="downloadInvoice()" 
            class="mt-6 bg-blue-600 text-white px-5 py-3 rounded-lg btn hover:bg-blue-700 w-full font-semibold"
          >
            Download Invoice
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cancel Item Modal -->
 <!-- Cancel Item Modal -->
  <div id="cancelItemModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="hideCancelItemModal()">&times;</span>
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Cancel Item</h2>
      <form id="cancelItemForm" class="space-y-4">
        <div>
          <label for="cancelItemReasonSelect" class="block text-sm font-medium text-gray-700 mb-2">
            Reason for Cancellation <span class="text-red-500">*</span>
          </label>
          <select 
            id="cancelItemReasonSelect" 
            name="cancelItemReasonSelect" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
            required
            onchange="toggleOtherReasonField('cancelItem')"
          >
            <option value="">Select a reason</option>
            <option value="Changed my mind">Changed my mind</option>
            <option value="Found a better price elsewhere">Found a better price elsewhere</option>
            <option value="Ordered by mistake">Ordered by mistake</option>
            <option value="Product not needed anymore">Product not needed anymore</option>
            <option value="Delivery time too long">Delivery time too long</option>
            <option value="Want to change product specifications">Want to change product specifications</option>
            <option value="Financial constraints">Financial constraints</option>
            <option value="Other">Other (Please specify)</option>
          </select>
        </div>
        <div id="cancelItemOtherReason" style="display: none;">
          <label for="cancelItemReasonText" class="block text-sm font-medium text-gray-700 mb-2">
            Please specify your reason <span class="text-red-500">*</span>
          </label>
          <textarea 
            id="cancelItemReasonText" 
            name="cancelItemReasonText" 
            rows="3" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" 
            placeholder="Please explain your reason..."
          ></textarea>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button 
            type="button" 
            class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg btn hover:bg-gray-300 font-medium" 
            onclick="hideCancelItemModal()"
          >
            Cancel
          </button>
          <button 
            type="submit" 
            class="bg-red-500 text-white px-6 py-2 rounded-lg btn hover:bg-red-600 font-medium"
          >
            Submit Cancellation
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    let currentOrderId = null;
    let currentProductId = null;

    // Show Cancel Item Modal
    function showCancelItemModal(orderId, productId) {
      currentOrderId = orderId;
      currentProductId = productId;
      const modal = document.getElementById('cancelItemModal');
      modal.classList.add('show');
      setTimeout(() => {
        // document.getElementById('cancelItemReason').focus();
        document.getElementById('cancelItemReasonSelect').focus()

      }, 100);
    }

    // Hide Cancel Item Modal
    function hideCancelItemModal() {
      const modal = document.getElementById('cancelItemModal');
      modal.classList.remove('show');
      document.getElementById('cancelItemForm').reset();
    }

    // Close modal on outside click
    document.getElementById('cancelItemModal').addEventListener('click', function(e) {
      if (e.target === this) {
        hideCancelItemModal();
      }
    });



  document.getElementById('cancelItemForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const reasonSelect = document.getElementById('cancelItemReasonSelect');
  const reasonText = document.getElementById('cancelItemReasonText');
  let reason = '';

  // Determine which value to use
  if (reasonSelect.value === 'Other') {
    reason = reasonText.value.trim();
  } else {
    reason = reasonSelect.value.trim();
  }

  // Validation
  if (!reason) {
    Swal.fire({
      icon: 'warning',
      title: 'Missing Reason',
      text: 'Please provide a reason for cancellation.',
    });
    return;
  }

  try {
    const response = await fetch(`/orders/${currentOrderId}/cancel-item`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        orderId: currentOrderId,
        productId: currentProductId,
        reason: reason
      })
    });

    const data = await response.json();

    await Swal.fire({
      icon: data.success ? 'success' : 'error',
      title: data.success ? 'Success' : 'Error',
      text: data.message || (data.success ? 'Item cancelled successfully' : 'Failed to cancel item')
    });

    if (data.success) {
      hideCancelItemModal();
      location.reload();
    }

  } catch (error) {
    console.error('Error cancelling item:', error);
    await Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'Failed to cancel item. Please try again.'
    });
  }
});

    function toggleOtherReasonField(type) {
  const select = document.getElementById(`${type}ReasonSelect`);
  const otherReasonDiv = document.getElementById(`${type}OtherReason`);
  
  if (select && otherReasonDiv) {
    if (select.value === "Other") {
      otherReasonDiv.style.display = "block";
    } else {
      otherReasonDiv.style.display = "none";
    }
  }
}


    // Return Item
    async function returnItem(orderId, productId) {
      try {
        const { value: reason } = await Swal.fire({
          title: 'Request Return',
          input: 'textarea',
          inputLabel: 'Please provide a reason for return',
          inputPlaceholder: 'Enter your reason here...',
          showCancelButton: true,
          confirmButtonText: 'Submit Return Request',
          cancelButtonText: 'Cancel',
          confirmButtonColor: '#3b82f6',
          inputValidator: (value) => {
            if (!value || !value.trim()) {
              return 'You need to provide a reason!';
            }
          }
        });

        if (reason) {
          const response = await fetch(`/orders/${orderId}/return`, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
              orderId: orderId, 
              productId: productId, 
              reason: reason.trim() 
            })
          });

          const data = await response.json();
          
          await Swal.fire({
            icon: data.success ? 'success' : 'error',
            title: data.success ? 'Success' : 'Error',
            text: data.message || (data.success ? 'Return request submitted successfully' : 'Failed to request return')
          });

          if (data.success) {
            location.reload();
          }
        }
      } catch (error) {
        console.error('Error requesting return:', error);
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to request return. Please try again.'
        });
      }
    }

    // Cancel Entire Order
    async function cancelEntireOrder(orderId) {
      try {
        const { value: reason } = await Swal.fire({
          title: 'Cancel Entire Order',
          input: 'textarea',
          inputLabel: 'Please provide a reason for cancelling the entire order',
          inputPlaceholder: 'Enter your reason here...',
          showCancelButton: true,
          confirmButtonText: 'Cancel Order',
          cancelButtonText: 'Go Back',
          confirmButtonColor: '#ef4444',
          inputValidator: (value) => {
            if (!value || !value.trim()) {
              return 'You need to provide a reason!';
            }
          }
        });

        if (reason) {
          const response = await fetch(`/orders/${orderId}/cancel-order`, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
              orderId: orderId, 
              reason: reason.trim() 
            })
          });

          const data = await response.json();
          
          await Swal.fire({
            icon: data.success ? 'success' : 'error',
            title: data.success ? 'Success' : 'Error',
            text: data.message || (data.success ? 'Order cancelled successfully' : 'Failed to cancel order')
          });

          if (data.success) {
            location.reload();
          }
        }
      } catch (error) {
        console.error('Error cancelling order:', error);
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to cancel order. Please try again.'
        });
      }
    }

    // Download Invoice
    function downloadInvoice() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text('INVOICE', 105, 20, { align: 'center' });

        // Order Details
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text(`Order ID: <%= order.orderID || 'N/A' %>`, 20, 35);
        doc.text(`Order Date: <%= new Date(order.orderDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' }) %>`, 20, 42);
        <% if (order.invoiceDate) { %>
        doc.text(`Invoice Date: <%= new Date(order.invoiceDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' }) %>`, 20, 49);
        <% } %>

        // Shipping Address
        doc.setFont(undefined, 'bold');
        doc.text('Shipping Address:', 20, 60);
        doc.setFont(undefined, 'normal');
        doc.text('<%= order.shippingAddress.name || "" %>', 20, 67);
        doc.text('<%= order.shippingAddress.address || "" %>', 20, 74, { maxWidth: 170 });
        doc.text('<%= order.shippingAddress.city || "" %>, <%= order.shippingAddress.state || "" %>', 20, 81);
        doc.text('<%= order.shippingAddress.country || "" %> - <%= order.shippingAddress.pinCode || "" %>', 20, 88);
        doc.text('Phone: <%= order.shippingAddress.phone || "" %>', 20, 95);

        // Order Items
        let yPos = 110;
        doc.setFont(undefined, 'bold');
        doc.text('Order Items:', 20, yPos);
        doc.setFont(undefined, 'normal');
        yPos += 7;

        <% if (order.items && order.items.length > 0) { %>
          <% order.items.forEach((item, index) => { %>
            doc.text('<%= (index + 1) %>. <%= (item.productName || "Product").replace(/'/g, "\\'") %>', 20, yPos);
            yPos += 7;
            doc.text('   Quantity: <%= item.quantity || 1 %> | Price: ₹<%= typeof item.purchasePrice === "number" ? item.purchasePrice.toFixed(2) : "0.00" %>', 20, yPos);
            yPos += 10;
          <% }) %>
        <% } %>

        // Order Summary
        yPos += 5;
        doc.setFont(undefined, 'bold');
        doc.text('Order Summary:', 20, yPos);
        doc.setFont(undefined, 'normal');
        yPos += 7;
        doc.text('Subtotal: ₹<%= order.subtotal ? order.subtotal.toFixed(2) : "0.00" %>', 20, yPos);
        yPos += 7;
        doc.text('Shipping: ₹<%= order.shipping ? order.shipping.toFixed(2) : "0.00" %>', 20, yPos);
        yPos += 7;
        doc.text('Tax: ₹<%= order.tax ? order.tax.toFixed(2) : "0.00" %>', 20, yPos);
        yPos += 7;
        <% if (order.couponApplied && order.couponDiscount > 0) { %>
        doc.text('Coupon Discount: -₹<%= order.couponDiscount.toFixed(2) %>', 20, yPos);
        yPos += 7;
        <% } %>
        doc.setFont(undefined, 'bold');
        doc.text('Total: ₹<%= order.total ? order.total.toFixed(2) : "0.00" %>', 20, yPos);

        // Payment Details
        yPos += 15;
        doc.setFont(undefined, 'normal');
        doc.text('Payment Method: <%= order.paymentMethod || "N/A" %>', 20, yPos);
        yPos += 7;
        doc.text('Payment Status: <%= order.paymentStatus || "Pending" %>', 20, yPos);
        yPos += 7;
        doc.text('Transaction ID: <%= order.transactionId || "N/A" %>', 20, yPos);

        // Save PDF
        doc.save('Invoice_<%= order.orderID || "order" %>.pdf');
      } catch (error) {
        console.error('Error generating PDF:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to generate invoice. Please try again.'
        });
      }
    }

    // Prevent modal from opening on page load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('Order details page loaded');
    });
  </script>
</body>
</html>


views/user/order-error.ejs

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payment Error</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .error-container {
      background: white;
      padding: 40px 30px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      max-width: 420px;
      width: 100%;
      text-align: center;
    }

    .error-icon {
      font-size: 48px;
      color: #e74c3c;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 28px;
      color: #2c3e50;
      margin-bottom: 16px;
    }

    p {
      color: #7f8c8d;
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 30px;
    }

    .retry-btn {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 14px 32px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }

    .retry-btn:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(52, 152, 219, 0.4);
    }

    .retry-btn:active {
      transform: translateY(0);
    }

    .footer-note {
      margin-top: 24px;
      font-size: 13px;
      color: #95a5a6;
    }
  </style>
</head>
<body>
  <div class="error-container">
    <div class="error-icon">⚠️</div>
    <h1>Payment Failed</h1>
    <p>We're sorry, but there was an error processing your payment. Please check your details and try again.</p>
    <button class="retry-btn" onclick="retryPayment()">
      Retry Payment
    </button>
    <div class="footer-note">
      Need help? <a href="#" style="color: #3498db; text-decoration: none;">Contact Support</a>
    </div>
  </div>

  <script>
    function retryPayment() {
      // Replace with your actual retry logic
      alert("Redirecting to payment page...");
      // window.location.href = "/checkout";
    }
  </script>
</body>
</html>


views/user/order-success.ejs

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Beauty Cart - Order Success</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Lato', sans-serif; background-color: #f9fafb; padding-top: 100px; }
    .header { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 80px; }
    .success-container { max-width: 600px; margin: 0 auto; }
    .checkmark { font-size: 3rem; color: #10b981; }
    .order-details { border: 1px solid #e5e7eb; border-radius: 0.5rem; }
  </style>
</head>
<body>
  <%- include('../partials/user/header') %>

  <div class="container mx-auto px-4 py-8 success-container">
    <div class="text-center py-12 bg-white rounded-lg shadow-lg order-details">
      <div class="mb-6">
        <i class="fas fa-check-circle checkmark"></i>
        <h1 class="text-2xl font-bold text-green-600 mt-4"><%= message %></h1>
      </div>

      <div class="mb-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-2">Order Confirmation</h2>
        <p class="text-sm text-gray-600">Your order has been successfully placed. Order ID: <span class="font-medium text-black"><%= orderId %></span></p>
        <p class="text-sm text-gray-600">Payment Method: <span class="font-medium text-black"><%= paymentMethod %></span></p>
      </div>

      <a href="/shop" class="inline-block max-w-xs bg-black text-white py-3 px-6 rounded hover:bg-gray-800 transition text-center font-medium mb-4">
        Continue Shopping
      </a>
      <a href="/orders" class="inline-block max-w-xs bg-gray-800 text-white py-3 px-6 rounded hover:bg-gray-900 transition text-center font-medium">
        Your Orders
      </a>
    </div>
  </div>

  <%- include('../partials/user/footer') %>
</body>
</html>



views/user/order-details.ejs


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Details</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    
 :root {
      --primary-color: #108a7e;
      --secondary-color: #cce4de;
      --dark-text: #71edd0;
      --light-text: #1b7a72;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--secondary-color);
      font-size: 14px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 24px;
      width: 90%;
      max-width: 480px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      position: relative;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .close {
      position: absolute;
      right: 16px;
      top: 16px;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      transition: color 0.2s ease;
      line-height: 1;
    }
    
    .close:hover {
      color: #1f2937;
    }
    
    .timeline {
      position: relative;
      padding-left: 2.5rem;
      margin-top: 1.5rem;
    }
    
    .timeline::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0.75rem;
      height: 100%;
      width: 3px;
      background: #e5e7eb;
      border-radius: 2px;
    }
    
    .timeline.shipped::before {
      background: #16a34a;
    }
    
    .timeline-item {
      position: relative;
      margin-bottom: 1.25rem;
      padding: 0.5rem 0.75rem;
      background: #f9fafb;
      border-radius: 6px;
      transition: transform 0.3s ease;
    }
    
    .timeline-item:hover {
      transform: translateX(5px);
    }
    
    .timeline-item::before {
      content: '';
      position: absolute;
      top: 8px;
      left: -2rem;
      width: 12px;
      height: 12px;
      background: white;
      border: 2px solid #d1d5db;
      border-radius: 50%;
      box-shadow: 0 0 0 2px white;
    }
    
    .timeline-item.completed::before {
      background: #16a34a;
      border-color: #16a34a;
    }
    
    .timeline-item.active::before {
      background: #16a34a;
      border-color: #16a34a;
      box-shadow: 0 0 0 2px white, 0 0 8px rgba(22, 163, 74, 0.4);
    }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(10, 90, 75, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }
    
    .btn {
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .container {
      max-width: 1200px;
    }
    
    .product-image {
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
 
<body class="min-h-screen pb-12">
  <%- include("../../views/partials/user/header") %>
  <!-- Navigation -->
  <nav class="bg-white p-6 shadow-lg sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center">
      <span class="text-2xl font-bold text-gray-800">Order #<%= order.orderID || 'N/A' %></span>
      <div class="flex items-center gap-4">
        <a href="/orders" class="text-blue-600 font-medium hover:text-blue-800 transition flex items-center">
          <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back to Orders
        </a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mx-auto mt-8 px-4">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Section: Order Items and Timeline -->
      <div class="lg:col-span-2 space-y-8">
        <!-- Order Items -->
        <div class="card p-6">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Order Items</h1>
          
          </div>
          <% if (order.items && order.items.length > 0) { %>
            <% order.items.forEach((item, index) => { %>
              <div class="flex flex-col sm:flex-row items-start gap-6 mb-6 pb-6 <%= index < order.items.length - 1 ? 'border-b' : '' %>">
                <img 
                  src="<%= item.productImage || 'https://via.placeholder.com/100' %>" 
                  alt="<%= item.productName || 'Product' %>" 
                  class="w-32 h-32 product-image"
                  onerror="this.src='https://via.placeholder.com/100'"
                >
                <div class="flex-1 w-full">
                  <h2 class="text-xl font-semibold text-gray-800 mb-2"><%= item.productName || 'Product Name Not Available' %></h2>
                  <div class="space-y-1 mb-3">
                    <p class="text-gray-600">Quantity: <span class="font-medium"><%= item.quantity || 1 %></span></p>
                    <p class="text-gray-600">Status: 
                      <span class="capitalize font-medium <%= item.productStatus === 'delivered' ? 'text-green-600' : item.productStatus === 'cancelled' ? 'text-red-600' : 'text-yellow-600' %>">
                        <%= item.productStatus || 'Unknown' %>
                      </span>
                    </p>
                  </div>
                  <p class="text-2xl font-bold text-green-600 mb-4">
                    ₹<%= typeof item.purchasePrice === 'number' && !isNaN(item.purchasePrice) ? item.purchasePrice.toFixed(2) : '0.00' %>
                  </p>
                  <div class="flex flex-wrap gap-3">
                    <% if (['ordered', 'pending'].includes(item.productStatus)) { %>
                      <button 
                        onclick="showCancelItemModal('<%= order._id %>', '<%= item.productId %>')" 
                        class="bg-red-100 text-red-600 px-5 py-2 rounded-lg border border-red-200 btn hover:bg-red-200 font-medium"
                      >
                        Cancel Item
                      </button>
                    <% } %>
                    <% if (item.productStatus === 'delivered') { %>
                      <button 
                        onclick="returnItem('<%= order._id %>', '<%= item.productId %>')" 
                        class="bg-yellow-100 text-yellow-600 px-5 py-2 rounded-lg border border-yellow-200 btn hover:bg-yellow-200 font-medium"
                      >
                        Request Return
                      </button>
                    <% } %>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-gray-500 text-lg text-center py-8">No items found in this order.</p>
          <% } %>
        </div>

        <!-- Order Timeline -->
        <div class="card p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">Order Timeline</h2>
          <div class="timeline <%= order.items && order.items.some(item => ['shipped', 'delivered'].includes(item.productStatus)) ? 'shipped' : '' %>">
            <% if (order.timeline && order.timeline.length > 0) { %>
              <% order.timeline.forEach(step => { %>
                <div class="timeline-item <%= step.current ? 'active' : (step.completed ? 'completed' : '') %>">
                  <h3 class="text-base font-semibold text-gray-800"><%= step.title || 'Status Update' %></h3>
                  <% if (step.completed && step.date) { %>
                    <p class="text-gray-500 text-xs mt-0.5">
                      <%= new Date(step.date).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' }) %>
                    </p>
                  <% } else if (step.completed) { %>
                    <p class="text-gray-500 text-xs mt-0.5">
                      <%= new Date(order.orderDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' }) %>
                    </p>
                  <% } else { %>
                    <p class="text-gray-400 italic text-xs mt-0.5">Pending</p>
                  <% } %>
                </div>
              <% }) %>
            <% } else { %>
              <p class="text-gray-500">No timeline information available.</p>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Right Section: Order Summary and Address -->
      <div class="space-y-8">
        <!-- Order Summary -->
        <div class="card p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Order Summary</h2>
          <div class="space-y-3 text-gray-600">
            <div class="flex justify-between">
              <span>Subtotal</span>
              <span class="font-medium">₹<%= order.subtotal ? order.subtotal.toFixed(2) : '0.00' %></span>
            </div>
            <div class="flex justify-between">
              <span>Shipping</span>
              <span class="font-medium">₹<%= order.shipping ? order.shipping.toFixed(2) : '0.00' %></span>
            </div>
            <div class="flex justify-between">
              <span>Tax</span>
              <span class="font-medium">₹<%= order.tax ? order.tax.toFixed(2) : '0.00' %></span>
            </div>
            <!-- <% if (order.couponApplied && order.couponDiscount > 0) { %>
              <div class="flex justify-between text-green-600">
                <span>Coupon Discount</span>
                <span class="font-medium">-₹<%= order.couponDiscount.toFixed(2) %></span>
              </div>
            <% } %> -->
            <div class="flex justify-between font-bold text-lg text-gray-800 pt-3 border-t-2">
              <span>Total</span>
              <span>₹<%= order.total ? order.total.toFixed(2) : '0.00' %></span>
            </div>
            <% if (order.totalWarning) { %>
              <p class="text-red-600 text-sm mt-2 p-2 bg-red-50 rounded"><%= order.totalWarning %></p>
            <% } %>
          </div>
          
          <hr class="my-6 border-gray-200">
          
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Payment Method:</span>
              <span class="font-medium text-gray-800"><%= order.paymentMethod || 'N/A' %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Payment Status:</span>
              <span class="font-semibold <%= order.paymentStatus === 'Paid' ? 'text-green-600' : 'text-red-600' %>">
                <%= order.paymentStatus || 'Pending' %>
              </span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Transaction ID:</span>
              <span class="font-medium text-gray-800 break-all"><%= order.transactionId || 'N/A' %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Order Date:</span>
              <span class="font-medium text-gray-800">
                <%= new Date(order.orderDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' }) %>
              </span>
            </div>
            <% if (order.invoiceDate) { %>
              <div class="flex justify-between">
                <span class="text-gray-600">Invoice Date:</span>
                <span class="font-medium text-gray-800">
                  <%= new Date(order.invoiceDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' }) %>
                </span>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Shipping Address -->
        <div class="card p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Shipping Address</h2>
          <div class="space-y-2 text-gray-700">
            <p class="font-semibold text-gray-800 text-lg"><%= order.shippingAddress.name || 'N/A' %></p>
            <p><%= order.shippingAddress.address || '' %></p>
            <p><%= order.shippingAddress.city || '' %>, <%= order.shippingAddress.state || '' %></p>
            <p><%= order.shippingAddress.country || '' %> - <%= order.shippingAddress.pinCode || '' %></p>
            <p class="pt-2"><span class="font-medium">Phone:</span> <%= order.shippingAddress.phone || 'N/A' %></p>
            <% if (order.shippingAddress.addressType) { %>
              <p><span class="font-medium">Type:</span> <span class="capitalize"><%= order.shippingAddress.addressType %></span></p>
            <% } %>
          </div>
          <button 
            onclick="downloadInvoice()" 
            class="mt-6 bg-blue-600 text-white px-5 py-3 rounded-lg btn hover:bg-blue-700 w-full font-semibold"
          >
            Download Invoice
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cancel Item Modal -->
 <!-- Cancel Item Modal -->
  <div id="cancelItemModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="hideCancelItemModal()">&times;</span>
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Cancel Item</h2>
      <form id="cancelItemForm" class="space-y-4">
        <div>
          <label for="cancelItemReasonSelect" class="block text-sm font-medium text-gray-700 mb-2">
            Reason for Cancellation <span class="text-red-500">*</span>
          </label>
          <select 
            id="cancelItemReasonSelect" 
            name="cancelItemReasonSelect" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
            required
            onchange="toggleOtherReasonField('cancelItem')"
          >
            <option value="">Select a reason</option>
            <option value="Changed my mind">Changed my mind</option>
            <option value="Found a better price elsewhere">Found a better price elsewhere</option>
            <option value="Ordered by mistake">Ordered by mistake</option>
            <option value="Product not needed anymore">Product not needed anymore</option>
            <option value="Delivery time too long">Delivery time too long</option>
            <option value="Want to change product specifications">Want to change product specifications</option>
            <option value="Financial constraints">Financial constraints</option>
            <option value="Other">Other (Please specify)</option>
          </select>
        </div>
        <div id="cancelItemOtherReason" style="display: none;">
          <label for="cancelItemReasonText" class="block text-sm font-medium text-gray-700 mb-2">
            Please specify your reason <span class="text-red-500">*</span>
          </label>
          <textarea 
            id="cancelItemReasonText" 
            name="cancelItemReasonText" 
            rows="3" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" 
            placeholder="Please explain your reason..."
          ></textarea>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button 
            type="button" 
            class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg btn hover:bg-gray-300 font-medium" 
            onclick="hideCancelItemModal()"
          >
            Cancel
          </button>
          <button 
            type="submit" 
            class="bg-red-500 text-white px-6 py-2 rounded-lg btn hover:bg-red-600 font-medium"
          >
            Submit Cancellation
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    let currentOrderId = null;
    let currentProductId = null;

    // Show Cancel Item Modal
    function showCancelItemModal(orderId, productId) {
      currentOrderId = orderId;
      currentProductId = productId;
      const modal = document.getElementById('cancelItemModal');
      modal.classList.add('show');
      setTimeout(() => {
        // document.getElementById('cancelItemReason').focus();
        document.getElementById('cancelItemReasonSelect').focus()

      }, 100);
    }

    // Hide Cancel Item Modal
    function hideCancelItemModal() {
      const modal = document.getElementById('cancelItemModal');
      modal.classList.remove('show');
      document.getElementById('cancelItemForm').reset();
    }

    // Close modal on outside click
    document.getElementById('cancelItemModal').addEventListener('click', function(e) {
      if (e.target === this) {
        hideCancelItemModal();
      }
    });



  document.getElementById('cancelItemForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const reasonSelect = document.getElementById('cancelItemReasonSelect');
  const reasonText = document.getElementById('cancelItemReasonText');
  let reason = '';

  // Determine which value to use
  if (reasonSelect.value === 'Other') {
    reason = reasonText.value.trim();
  } else {
    reason = reasonSelect.value.trim();
  }

  // Validation
  if (!reason) {
    Swal.fire({
      icon: 'warning',
      title: 'Missing Reason',
      text: 'Please provide a reason for cancellation.',
    });
    return;
  }

  try {
    const response = await fetch(`/orders/${currentOrderId}/cancel-item`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        orderId: currentOrderId,
        productId: currentProductId,
        reason: reason
      })
    });

    const data = await response.json();

    await Swal.fire({
      icon: data.success ? 'success' : 'error',
      title: data.success ? 'Success' : 'Error',
      text: data.message || (data.success ? 'Item cancelled successfully' : 'Failed to cancel item')
    });

    if (data.success) {
      hideCancelItemModal();
      location.reload();
    }

  } catch (error) {
    console.error('Error cancelling item:', error);
    await Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'Failed to cancel item. Please try again.'
    });
  }
});

    function toggleOtherReasonField(type) {
  const select = document.getElementById(`${type}ReasonSelect`);
  const otherReasonDiv = document.getElementById(`${type}OtherReason`);
  
  if (select && otherReasonDiv) {
    if (select.value === "Other") {
      otherReasonDiv.style.display = "block";
    } else {
      otherReasonDiv.style.display = "none";
    }
  }
}


    // Return Item
    async function returnItem(orderId, productId) {
      try {
        const { value: reason } = await Swal.fire({
          title: 'Request Return',
          input: 'textarea',
          inputLabel: 'Please provide a reason for return',
          inputPlaceholder: 'Enter your reason here...',
          showCancelButton: true,
          confirmButtonText: 'Submit Return Request',
          cancelButtonText: 'Cancel',
          confirmButtonColor: '#3b82f6',
          inputValidator: (value) => {
            if (!value || !value.trim()) {
              return 'You need to provide a reason!';
            }
          }
        });

        if (reason) {
          const response = await fetch(`/orders/${orderId}/return`, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
              orderId: orderId, 
              productId: productId, 
              reason: reason.trim() 
            })
          });

          const data = await response.json();
          
          await Swal.fire({
            icon: data.success ? 'success' : 'error',
            title: data.success ? 'Success' : 'Error',
            text: data.message || (data.success ? 'Return request submitted successfully' : 'Failed to request return')
          });

          if (data.success) {
            location.reload();
          }
        }
      } catch (error) {
        console.error('Error requesting return:', error);
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to request return. Please try again.'
        });
      }
    }

    // Cancel Entire Order
    async function cancelEntireOrder(orderId) {
      try {
        const { value: reason } = await Swal.fire({
          title: 'Cancel Entire Order',
          input: 'textarea',
          inputLabel: 'Please provide a reason for cancelling the entire order',
          inputPlaceholder: 'Enter your reason here...',
          showCancelButton: true,
          confirmButtonText: 'Cancel Order',
          cancelButtonText: 'Go Back',
          confirmButtonColor: '#ef4444',
          inputValidator: (value) => {
            if (!value || !value.trim()) {
              return 'You need to provide a reason!';
            }
          }
        });

        if (reason) {
          const response = await fetch(`/orders/${orderId}/cancel-order`, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
              orderId: orderId, 
              reason: reason.trim() 
            })
          });

          const data = await response.json();
          
          await Swal.fire({
            icon: data.success ? 'success' : 'error',
            title: data.success ? 'Success' : 'Error',
            text: data.message || (data.success ? 'Order cancelled successfully' : 'Failed to cancel order')
          });

          if (data.success) {
            location.reload();
          }
        }
      } catch (error) {
        console.error('Error cancelling order:', error);
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to cancel order. Please try again.'
        });
      }
    }

    // Download Invoice
    function downloadInvoice() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text('INVOICE', 105, 20, { align: 'center' });

        // Order Details
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text(`Order ID: <%= order.orderID || 'N/A' %>`, 20, 35);
        doc.text(`Order Date: <%= new Date(order.orderDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' }) %>`, 20, 42);
        <% if (order.invoiceDate) { %>
        doc.text(`Invoice Date: <%= new Date(order.invoiceDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' }) %>`, 20, 49);
        <% } %>

        // Shipping Address
        doc.setFont(undefined, 'bold');
        doc.text('Shipping Address:', 20, 60);
        doc.setFont(undefined, 'normal');
        doc.text('<%= order.shippingAddress.name || "" %>', 20, 67);
        doc.text('<%= order.shippingAddress.address || "" %>', 20, 74, { maxWidth: 170 });
        doc.text('<%= order.shippingAddress.city || "" %>, <%= order.shippingAddress.state || "" %>', 20, 81);
        doc.text('<%= order.shippingAddress.country || "" %> - <%= order.shippingAddress.pinCode || "" %>', 20, 88);
        doc.text('Phone: <%= order.shippingAddress.phone || "" %>', 20, 95);

        // Order Items
        let yPos = 110;
        doc.setFont(undefined, 'bold');
        doc.text('Order Items:', 20, yPos);
        doc.setFont(undefined, 'normal');
        yPos += 7;

        <% if (order.items && order.items.length > 0) { %>
          <% order.items.forEach((item, index) => { %>
            doc.text('<%= (index + 1) %>. <%= (item.productName || "Product").replace(/'/g, "\\'") %>', 20, yPos);
            yPos += 7;
            doc.text('   Quantity: <%= item.quantity || 1 %> | Price: ₹<%= typeof item.purchasePrice === "number" ? item.purchasePrice.toFixed(2) : "0.00" %>', 20, yPos);
            yPos += 10;
          <% }) %>
        <% } %>

        // Order Summary
        yPos += 5;
        doc.setFont(undefined, 'bold');
        doc.text('Order Summary:', 20, yPos);
        doc.setFont(undefined, 'normal');
        yPos += 7;
        doc.text('Subtotal: ₹<%= order.subtotal ? order.subtotal.toFixed(2) : "0.00" %>', 20, yPos);
        yPos += 7;
        doc.text('Shipping: ₹<%= order.shipping ? order.shipping.toFixed(2) : "0.00" %>', 20, yPos);
        yPos += 7;
        doc.text('Tax: ₹<%= order.tax ? order.tax.toFixed(2) : "0.00" %>', 20, yPos);
        yPos += 7;
        <% if (order.couponApplied && order.couponDiscount > 0) { %>
        doc.text('Coupon Discount: -₹<%= order.couponDiscount.toFixed(2) %>', 20, yPos);
        yPos += 7;
        <% } %>
        doc.setFont(undefined, 'bold');
        doc.text('Total: ₹<%= order.total ? order.total.toFixed(2) : "0.00" %>', 20, yPos);

        // Payment Details
        yPos += 15;
        doc.setFont(undefined, 'normal');
        doc.text('Payment Method: <%= order.paymentMethod || "N/A" %>', 20, yPos);
        yPos += 7;
        doc.text('Payment Status: <%= order.paymentStatus || "Pending" %>', 20, yPos);
        yPos += 7;
        doc.text('Transaction ID: <%= order.transactionId || "N/A" %>', 20, yPos);

        // Save PDF
        doc.save('Invoice_<%= order.orderID || "order" %>.pdf');
      } catch (error) {
        console.error('Error generating PDF:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to generate invoice. Please try again.'
        });
      }
    }

    // Prevent modal from opening on page load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('Order details page loaded');
    });
  </script>
</body>
</html>



views/user/orders.ejs

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - Supreme</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #1a3c34;
            --secondary-color: #e0ecf8;
            --dark-text: #1a3c34;
            --light-text: #5f8b88;
            --success: #2ecc71;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --pending: #e67e22;
            --border-radius: 8px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            --header-height: 60px;
            --footer-height: 60px;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Inter', 'Segoe UI', 'Arial', sans-serif;
            color: var(--dark-text);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 100%;
            padding: 0;
            margin: 0;
            width: 100vw;
        }

        .grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0;
            width: 100%;
            max-width: 100%;
        }

        .partial .sidebar {
      margin-left: -85px;
      position: sticky;
      top: var(--header-height);
      align-self: start;
      height: calc(100vh - var(--header-height));
      overflow-y: auto;
      z-index: 10;
    }

        .content {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 40px;
            width: 100%;
            max-width: none;
            margin-left: -10px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(26, 60, 52, 0.2);
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--dark-text);
            margin: 0;
        }

        .empty-state {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 3rem 2rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            background-color: rgba(26, 60, 52, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-size: 1rem;
        }

        .empty-state p {
            color: var(--light-text);
            font-size: 1rem;
            max-width: 400px;
            margin: 0 auto;
        }

        .order-grid {
            width: 100%;
            max-width: 100%;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .order-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: var(--secondary-color);
            border-bottom: 1px solid rgba(26, 60, 52, 0.1);
        }

        .order-id-container {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .order-date {
            color: var(--light-text);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .order-date i {
            font-size: 0.8rem;
        }

        .order-body {
            padding: 1.25rem 1.5rem;
            display: flex;
            gap: 1.25rem;
        }

        .product-image-container {
            width: 70px;
            height: 70px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
            background-color: var(--secondary-color);
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .order-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .product-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
            color: var(--dark-text);
            line-height: 1.4;
        }

        .order-quantity {
            color: var(--light-text);
            font-size: 0.9rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(26, 60, 52, 0.1);
            background-color: var(--secondary-color);
        }

        .status-payment-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .status-badge i {
            font-size: 0.7rem;
        }

        .status-completed {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--success);
        }

        .status-processing {
            background-color: rgba(230, 126, 34, 0.1);
            color: var(--pending);
        }

.status-returned {
    background-color: rgba(231, 76, 60, 0.1);
    color: #e74c3c;
}
.status-cancelled {
    background-color: rgba(192, 57, 43, 0.1);
    color: #c0392b;
}
.status-return-requested {
    background-color: rgba(241, 196, 15, 0.1);
    color: #f39c12;
}
.status-shipped {
    background-color: rgba(52, 152, 219, 0.1);
    color: #2980b9;
}
.status-partially-returned {
    background-color: rgba(231, 76, 60, 0.1);
    color: #e74c3c;
}
.status-partially-cancelled {
    background-color: rgba(192, 57, 43, 0.1);
    color: #c0392b;
}
        .payment-badge {
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .payment-badge i {
            font-size: 0.7rem;
        }

        .payment-badge.pending {
            color: var(--warning);
        }

        .payment-badge.completed {
            color: var(--success);
        }

        .price-actions-container {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .order-amount {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--dark-text);
        }

        .view-details-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.85rem;
            border-radius: var(--border-radius);
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .view-details-btn:hover {
            background-color: #2a5c54;
            color: white;
            transform: translateY(-1px);
        }

        .view-details-btn i {
            font-size: 0.75rem;
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-container input {
            border: 1px solid rgba(26, 60, 52, 0.2);
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            color: var(--dark-text);
            background-color: var(--secondary-color);
            transition: all 0.2s ease;
        }

        .search-container input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 60, 52, 0.1);
        }

        .search-container button {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .filter-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            padding-bottom: 1rem;
        }

        .filter-select {
            border: 1px solid rgba(26, 60, 52, 0.2);
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            color: var(--dark-text);
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            min-width: 150px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 60, 52, 0.1);
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
            gap: 0.5rem;
        }

        .pagination-btn {
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            background-color: var(--secondary-color);
            color: var(--dark-text);
            border: 1px solid rgba(26, 60, 52, 0.2);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            background-color: #f1f1f1;
            color: #999;
            border-color: #ddd;
            cursor: not-allowed;
        }

        @media (max-width: 1280px) {
            .page-container {
                margin: 0 auto;
                padding: 2rem 1rem;
            }
        }

        @media (max-width: 1024px) {
            .content {
                margin-left: -5px;
            }
        }

        @media (max-width: 767px) {
            .container {
                padding: 0.5rem;
            }

            .page-container {
                padding: 1rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .partial .sidebar {
                margin-left: 0;
            }

            .content {
                margin-left: 0;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .search-container {
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
            }

            .search-container input {
                width: 100%;
                max-width: none;
            }

            .search-container button {
                width: 100%;
                justify-content: center;
            }

            .order-header,
            .order-body,
            .order-footer {
                padding: 1rem;
            }

            .order-header {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }

            .order-id-container {
                width: 100%;
            }

            .order-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .price-actions-container {
                width: 100%;
                justify-content: space-between;
            }

            .empty-state {
                padding: 2rem 1rem;
            }

            .filter-container {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-select {
                width: 100%;
            }

            .pagination-container {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 480px) {
            .page-title {
                font-size: 1.5rem;
            }

            .order-body {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .product-image-container {
                width: 100px;
                height: 100px;
            }

            .order-details {
                text-align: center;
            }

            .order-quantity {
                justify-content: center;
            }

            .view-details-btn {
                width: 100%;
                justify-content: center;
                margin-top: 0.5rem;
            }

            .price-actions-container {
                flex-direction: column;
                align-items: center;
                gap: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="partial">
        <%- include("../../views/partials/user/header") %>
    </div>

    <div class="container">
        <h1>My Orders</h1>
        <div class="grid">
            <div class="partial">
                <%- include("../../views/partials/user/sidebar") %>
            </div>
            <div class="content">
                <div class="page-header">
                    <h2 class="page-title">My Orders</h2>
                    <div class="search-container">
    <input 
    type="text" 
    id="orderSearch" 
    class="form-control" 
    placeholder="Search orders by product or status..." 
    value="<%= filters.search || '' %>" 
    style="max-width: 300px; border-radius: var(--border-radius);"
>
    <button id="searchBtn" class="view-details-btn ms-2">
        Search
    </button>
    <button id="clearSearchBtn" class="view-details-btn ms-1" style="background-color: #95a5a6;">
        Clear
    </button>
</div>
                </div>
                
                <!-- <div class="filter-container">
                    <select id="statusFilter" class="filter-select">
                        <option value="">All Statuses</option>
                        <option value="processing">Processing</option>
                        <option value="completed">Completed</option>
                    </select>
                    <select id="timeFilter" class="filter-select">
                        <option value="">All Time</option>
                        <option value="last30">Last 30 Days</option>
                        <option value="last90">Last 90 Days</option>
                        <option value="lastYear">Last Year</option>
                    </select>
                </div> -->
                
                <% if (orders.length === 0) { %>
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <h3>No Orders Yet</h3>
                        <p><%= message %></p>
                        <a href="/shop" class="view-details-btn">
                            <i class="fas fa-shopping-cart"></i>
                            Browse Products
                        </a>
                    </div>
                <% } else { %>
                    <div class="order-grid" id="orderGrid">
                        <% orders.forEach(order => { %>
    <div class="order-card" 
         data-order-id="<%= order._id %>"              
         data-product="<%= order.orderItems[0]?.productName?.toLowerCase() || '' %>" 
         data-status="<%= order.status.toLowerCase() %>" 
         data-date="<%= order.createdAt.toISOString() %>">
        
        <div class="order-header">
            <div class="order-id-container">
                <span class="order-date">
                    <i class="far fa-calendar-alt"></i>
                    <%= order.createdAt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %>
                </span>
            </div>
            <!-- <div class="payment-status-container">
                <span class="payment-badge <%= order.paymentStatus === 'Pending' ? 'pending' : 'completed' %>">
                    <i class="<%= order.paymentStatus === 'Pending' ? 'fas fa-hourglass-half' : 'fas fa-check-circle' %>"></i>
                    <%= order.paymentStatus %>
                </span>
            </div> -->
        </div>
                                <div class="order-body">
                                    <div class="product-image-container">
                                        <img
                                            src="<%= order.orderItems[0]?.image || '/default-image.jpg' %>"
                                            alt="<%= order.orderItems[0]?.productName || 'Product' %>"
                                            class="product-image"
                                            onerror="this.src='/default-image.jpg';"
                                        />
                                    </div>
                                    <div class="order-details">
                                        <h4 class="product-name"><%= order.orderItems[0]?.productName || 'Unknown Product' %></h4>
                                        <% if (order.orderItems.length > 1) { %>
                                            <p class="order-quantity">
                                                <i class="fas fa-cubes"></i>
                                                <%= order.orderItems.length %> items in this order
                                            </p>
                                        <% } %>
                                    </div>
                                </div>

                                <div class="order-footer">
                                    <div class="status-payment-container">
    <span class="status-badge 
        <%= 
          ['delivered', 'completed'].includes(order.status) ? 'status-completed' :
          ['returned', 'partially_returned'].includes(order.status) ? 'status-returned' :
          ['cancelled', 'partially_cancelled'].includes(order.status) ? 'status-cancelled' :
          ['return_requested', 'return_requested'].includes(order.status) ? 'status-return-requested' :
          ['shipped'].includes(order.status) ? 'status-shipped' :
          'status-processing'
        %>">
        <i class="<%= 
          ['delivered', 'completed'].includes(order.status) ? 'fas fa-check-circle' :
          ['returned', 'partially_returned'].includes(order.status) ? 'fas fa-undo' :
          ['cancelled', 'partially_cancelled'].includes(order.status) ? 'fas fa-ban' :
          ['return_requested'].includes(order.status) ? 'fas fa-clock' :
          ['shipped'].includes(order.status) ? 'fas fa-truck' :
          'fas fa-cogs'
        %>"></i>
        <%= 
          order.status === 'partially_returned' ? 'Partially Returned' :
          order.status === 'partially_cancelled' ? 'Partially Cancelled' :
          order.status === 'return_requested' ? 'Return Requested' :
          order.status.charAt(0).toUpperCase() + order.status.slice(1)
        %>
    </span>
</div>

                                    <div class="price-actions-container">
                                        <span class="order-amount">₹<%= order.finalAmount.toFixed(2) %></span>
                                        <a href="/order-details/<%= order._id %>" class="view-details-btn">
                                            <i class="fas fa-eye"></i>
                                            View Details
                                        </a>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>

                    <div class="pagination-container">
    <!-- Previous -->
    <button id="prevPage"
            class="pagination-btn <%= currentPage === 1 ? 'opacity-50 cursor-not-allowed' : '' %>"
            <%= currentPage === 1 ? 'disabled' : '' %>>
        Previous
    </button>

    <!-- Page 1 -->
    <button class="pagination-btn <%= currentPage === 1 ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200' %>"
            data-page="1">
        1
    </button>

    <!-- Page 2 (only show if totalPages >= 2) -->
    <% if (totalPages >= 2) { %>
        <button class="pagination-btn <%= currentPage === 2 ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200' %>"
                data-page="2">
            2
        </button>
    <% } %>

    <!-- Next -->
    <button id="nextPage"
            class="pagination-btn <%= currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : '' %>"
            <%= currentPage === totalPages ? 'disabled' : '' %>>
        Next
    </button>
</div>
                <% } %>
            </div>
        </div>
    </div>

    <div class="partial">
        <%- include("../../views/partials/user/footer") %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
   <script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('orderSearch');
    const searchBtn = document.getElementById('searchBtn');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const orderGrid = document.getElementById('orderGrid');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageButtons = document.querySelectorAll('.pagination-btn[data-page]');

    // ── FETCH ORDERS FROM SERVER ──
    async function fetchOrders(page = 1, search = '') {
        const url = new URL('/orders', window.location.origin);
        url.searchParams.set('page', page);
        if (search) url.searchParams.set('search', search);

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network error');
            const html = await response.text();

            // Parse HTML and extract only the order grid + pagination
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newGrid = doc.querySelector('#orderGrid');
            const newPagination = doc.querySelector('.pagination-container');

            if (newGrid) orderGrid.innerHTML = newGrid.innerHTML;
            if (newPagination) {
                document.querySelector('.pagination-container').outerHTML = newPagination.outerHTML;
            }

            // Re-attach event listeners
            attachPaginationListeners();
            applyLiveSearch(); // Re-apply live search on new cards
        } catch (err) {
            console.error('Fetch error:', err);
            Swal.fire('Error', 'Failed to load orders', 'error');
        }
    }

    // ── LIVE SEARCH (Client-side) ──
    function applyLiveSearch() {
        const query = searchInput.value.toLowerCase().trim();
        const cards = document.querySelectorAll('.order-card');

        cards.forEach(card => {
            const product = (card.dataset.product || '').toLowerCase();
            const status = (card.dataset.status || '').toLowerCase();
            const matches = !query || product.includes(query) || status.includes(query);
            card.style.display = matches ? 'block' : 'none';
        });
    }

    // ── RE-ATTACH PAGINATION LISTENERS AFTER FETCH ──
    function attachPaginationListeners() {
        const newPrev = document.getElementById('prevPage');
        const newNext = document.getElementById('nextPage');
        const newPageBtns = document.querySelectorAll('.pagination-btn[data-page]');

        if (newPrev) newPrev.onclick = () => {
            const page = parseInt(newPrev.dataset.page || '<%= currentPage %>') - 1;
            if (page >= 1) fetchOrders(page, searchInput.value.trim());
        };
        if (newNext) newNext.onclick = () => {
            const page = parseInt(newNext.dataset.page || '<%= currentPage %>') + 1;
            fetchOrders(page, searchInput.value.trim());
        };
        newPageBtns.forEach(btn => {
            btn.onclick = () => fetchOrders(btn.dataset.page, searchInput.value.trim());
        });
    }

    // ── EVENT LISTENERS ──
    if (searchBtn) {
        searchBtn.addEventListener('click', () => {
            fetchOrders(1, searchInput.value.trim());
        });
    }

    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', () => {
            searchInput.value = '';
            fetchOrders(1, '');
        });
    }

    searchInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') {
            fetchOrders(1, searchInput.value.trim());
        }
    });

    // Live search while typing
    searchInput.addEventListener('input', applyLiveSearch);

    // Initial pagination
    attachPaginationListeners();

    // Apply live search on load
    applyLiveSearch();

    // ────── CANCEL / RETURN (Keep existing fetch) ──────
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');
    if (confirmCancelBtn) {
        confirmCancelBtn.addEventListener('click', async () => {
            const cancelForm = document.getElementById('cancelForm');
            const orderId = document.getElementById('orderId').value;
            const productId = document.getElementById('productId').value;
            const actionType = document.getElementById('actionType').value;
            const reason = document.getElementById('cancelReason').value === 'Other'
                ? document.getElementById('otherReason').value
                : document.getElementById('cancelReason').value;

            if (!cancelForm.checkValidity()) return cancelForm.reportValidity();

            const endpoint = actionType === 'cancel'
                ? `/orders/${orderId}/cancel-item`
                : `/orders/${orderId}/return`;

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId, productId, reason })
                });
                const result = await res.json();

                const modal = document.getElementById('cancelModal');
                bootstrap.Modal.getInstance(modal).hide();

                if (result.success) {
                    Swal.fire('Success', result.message, 'success').then(() => {
                        // Update badge
                        const card = document.querySelector(`[data-order-id="${orderId}"]`);
                        if (card && result.orderStatus) {
                            const badge = card.querySelector('.status-badge');
                            const status = result.orderStatus.toLowerCase();
                            const displayText = 
                                status === 'partially_returned' ? 'Partially Returned' :
                                status === 'partially_cancelled' ? 'Partially Cancelled' :
                                status === 'return_requested' ? 'Return Requested' :
                                status.charAt(0).toUpperCase() + status.slice(1);

                            badge.textContent = displayText;
                            badge.className = 'status-badge ' + 
                                (status === 'delivered' || status === 'completed' ? 'status-completed' :
                                 ['returned', 'partially_returned'].includes(status) ? 'status-returned' :
                                 ['cancelled', 'partially_cancelled'].includes(status) ? 'status-cancelled' :
                                 status === 'return_requested' ? 'status-return-requested' :
                                 status === 'shipped' ? 'status-shipped' : 'status-processing');
                            card.dataset.status = status;
                            applyLiveSearch();
                        }
                    });
                } else {
                    Swal.fire('Error', result.message || 'Failed', 'error');
                }
            } catch (err) {
                console.error(err);
                Swal.fire('Error', 'Network error', 'error');
            }
        });
    }
});
</script>
</body>
</html>



views/admin/orderManage.ejs
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
       /* Base Styles */
.content-main {
    margin-left: 250px;
    padding: 2rem;
    min-height: 100vh;
}

.page-title {
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
    text-align: center;
    margin-bottom: 2rem;
}

.search-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    gap: 1rem;
}

.search-form {
    flex: 1;
    max-width: 500px;
}

.search-input-group {
    display: flex;
    background: white;
    border-radius: 50px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    overflow: hidden;
}

.search-input {
    flex: 1;
    padding: 1rem 1.5rem;
    border: none;
    outline: none;
    font-size: 0.875rem;
    background: transparent;
}

.search-btn {
    padding: 1rem 1.5rem;
    background: #3b82f6;
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s;
}

.search-btn:hover {
    background: #2563eb;
}

.clear-btn {
    padding: 1rem 1.5rem;
    background: #6b7280;
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s;
}

.clear-btn:hover {
    background: #4b5563;
}

.main-card {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 4px 25px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.table-section {
    padding: 0;
    overflow: hidden;
}

.table-container {
    overflow-x: auto;
    max-height: 600px;
}

.orders-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}

.table-header {
    background: #f8fafc;
    color: #64748b;
    padding: 1rem 0.75rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.8125rem;
    border-bottom: 1px solid #e2e8f0;
    position: sticky;
    top: 0;
    z-index: 10;
}

.table-row {
    border-bottom: 1px solid #f1f5f9;
    transition: background-color 0.2s;
}

.table-row:hover {
    background: #f8fafc;
}

.table-cell {
    padding: 1rem 0.75rem;
    vertical-align: middle;
    color: #475569;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
}

/* ──────────────────────── STATUS BADGES ──────────────────────── */
.status-pending            { background: #fef3c7; color: #92400e; }
.status-processing         { background: #dbeafe; color: #1e40af; }
.status-shipped            { background: #fef3c7; color: #92400e; }
.status-delivered          { background: #d1fae5; color: #065f46; }
.status-cancelled          { background: #fee2e2; color: #991b1b; }
.status-returned           { background: #fee2e2; color: #991b1b; }
.status-partially_returned { background: #fbbf24; color: #78350f; }
.status-partially_cancelled{ background: #fee2e2; color: #dc2626; }
.status-return_requested   { background: #fbbf24; color: #78350f; }
.status-return_rejected    { background: #ef4444; color: white; }
.status-return_approved    { background: #10b981; color: white; }
.status-payment_failed     { background: #1f2937; color: #f3f4f6; }
/* ────────────────────────────────────────────────────────────── */

.product-thumbnail {
    width: 2.5rem;
    height: 2.5rem;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #e5e7eb;
}

.product-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
}

.product-details {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.action-btn {
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
}

.btn-view {
    background: #3b82f6;
    color: white;
}

.btn-view:hover {
    background: #2563eb;
}

.pagination-container {
    display: flex;
    justify-content: center;
    margin-top: 2rem;
}

.pagination {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.pagination-btn {
    padding: 0.5rem 0.75rem;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    color: #374151;
    text-decoration: none;
    font-size: 0.875rem;
    transition: all 0.2s;
}

.pagination-btn:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
}

.pagination-current {
    background: #10b981;
    color: white;
    border-color: #10b981;
}

/* ──────────────────────── RESPONSIVE ──────────────────────── */
@media (max-width: 1024px) {
    .content-main {
        margin-left: 0;
        padding: 1rem;
    }
    .search-container {
        flex-direction: column;
        gap: 1rem;
    }
    .search-form {
        max-width: 100%;
    }
}

@media (max-width: 640px) {
    .action-buttons {
        flex-direction: column;
    }
    .action-btn {
        text-align: center;
    }
    .search-input-group {
        border-radius: 0.5rem;
    }
    .search-btn,
    .clear-btn {
        border-radius: 0 0.5rem 0.5rem 0;
    }
}
    </style>
</head>
<%- include("../../views/partials/admin/sidebar") %>
<body class="bg-gray-50">
    <main class="content-main">
        <!-- Header Section -->
        <header class="mb-8">
            <h1 class="page-title">Order Management</h1>
            <!-- Search Container -->
            <div class="search-container">
                <form action="/admin/orders" method="get" class="search-form">
                    <div class="search-input-group">
                        <input 
                            type="text" 
                            name="search" 
                            id="searchInput"
                            placeholder="Search orders..." 
                            class="search-input"
                            value="<%= typeof search !== 'undefined' ? search : '' %>"
                        >
                        <button type="submit" class="search-btn">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </button>
                        <% if (typeof search !== 'undefined' && search) { %>
                            <button type="button" id="clearSearchBtn" class="clear-btn" title="Clear Search">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        <% } %>
                    </div>
                </form>
            </div>
        </header>

        <!-- Main Content Card -->
        <div class="main-card">
            <div class="table-section">
                <div class="table-container">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th class="table-header">PRODUCT</th>
                                <th class="table-header">ORDER ID</th>
                                <th class="table-header">CUSTOMER</th>
                                <th class="table-header">STATUS</th>
                                <th class="table-header">PRICE</th>
                                <th class="table-header">DATE</th>
                                <th class="table-header">ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody>
  <% if (orders && orders.length > 0) { %>
    <% orders.forEach(order => { %>
      <tr class="table-row" data-order-id="<%= order._id %>">
        <td class="table-cell">
          <% if (order.orderItems && order.orderItems.length > 0) { %>
            <% if (order.orderItems.length <= 2) { %>
              <% order.orderItems.forEach(item => { %>
                <div class="product-item">
                  <img
                    src="<%= item.displayImage %>"
                    alt="<%= item.displayName %>"
                    class="product-thumbnail"
                    onerror="this.src='/default-image.jpg'"
                  >
                </div>
              <% }) %>
            <% } else { %>
              <div class="product-item">
                <img
                  src="<%= order.orderItems[0].displayImage %>"
                  alt="<%= order.orderItems[0].displayName %>"
                  class="product-thumbnail"
                  onerror="this.src='/default-image.jpg'"
                >
                <span class="text-xs text-gray-500">+<%= order.orderItems.length - 1 %></span>
              </div>
            <% } %>
          <% } else { %>
            <span class="text-xs text-gray-500">No items</span>
          <% } %>
        </td>
        <td class="table-cell">
          <div class="product-details">
            <span class="text-sm font-semibold text-gray-900"><%= order.orderId %></span>
            <% if (order.orderItems && order.orderItems.length > 0) { %>
              <span class="text-xs text-gray-500 truncate w-full">
                <%= order.orderItems[0].displayName %>
              </span>
            <% } %>
          </div>
        </td>
        <td class="table-cell font-medium"><%= order.user ? order.user.name : 'Unknown User' %></td>
       <td class="table-cell">
  <!-- <small>Raw: <%= order.status %></small><br> -->
  <span class="status-badge status-<%= order.status.toLowerCase().replace(/ /g, '_') %>">
    <%= order.status.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') %>
  </span>
</td>
        <td class="table-cell font-semibold">₹<%= order.finalAmount.toFixed(2) %></td>
        <td class="table-cell text-gray-600"><%= new Date(order.createdOn).toLocaleDateString() %></td>
        <td class="table-cell">
          <div class="action-buttons">
            <% if (order.orderId) { %>
      <a href="order/details/<%=order.orderId%>" class="action-btn btn-view">
        <i class="fas fa-eye text-xs">View</i>
      </a>
    <% } else { %>
      <span class="text-xs text-gray-500">No Order ID</span>
    <% } %>
          </div>
        </td>
      </tr>
    <% }) %>
  <% } else { %>
    <tr>
      <td colspan="7" class="table-cell text-center text-gray-500 py-8">
        No orders found
      </td>
    </tr>
  <% } %>
</tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination-container">
            <div class="pagination">
                <% if(totalPages > 0) { %>
                    <% if(currentPage > 1) { %>
                        <a href="?page=<%= currentPage - 1 %>" class="pagination-btn">
                            <i class="fas fa-chevron-left text-xs"></i>
                        </a>
                    <% } %>
                    <% for(let i = 1; i <= totalPages; i++) { %>
                        <% if(i === currentPage) { %>
                            <span class="pagination-btn pagination-current"><%= i %></span>
                        <% } else if(i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) { %>
                            <a href="?page=<%= i %>" class="pagination-btn"><%= i %></a>
                        <% } else if(i === currentPage - 2 || i === currentPage + 2) { %>
                            <span class="pagination-btn">...</span>
                        <% } %>
                    <% } %>
                    <% if(currentPage < totalPages) { %>
                        <a href="?page=<%= currentPage + 1 %>" class="pagination-btn">
                            <i class="fas fa-chevron-right text-xs"></i>
                        </a>
                    <% } %>
                <% } %>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        class OrderManager {
            constructor() {
                this.searchInput = document.getElementById("searchInput");
                this.clearSearchBtn = document.getElementById("clearSearchBtn");

                this.init();
            }

            init() {
                if (this.clearSearchBtn) {
                    this.clearSearchBtn.addEventListener("click", this.clearSearch.bind(this));
                }

                if (this.searchInput) {
                    this.searchInput.addEventListener("input", this.handleSearch.bind(this));
                }
            }

            handleSearch() {
                const searchTerm = this.searchInput.value.toLowerCase();
                const orderRows = document.querySelectorAll('.table-row');

                orderRows.forEach(row => {
                    const orderText = row.textContent.toLowerCase();
                    if (orderText.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            clearSearch() {
                if (this.searchInput) {
                    this.searchInput.value = "";
                    window.location.href = "/admin/orders";
                }
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            new OrderManager();
        });
    </script>
</body>
</html>


views/admin/orderDetails.ejs


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Details - <%= order.orderId %></title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --primary-color: #108a7e;
      --secondary-color: #cce4de;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3bdaf6;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    /* Enhanced Timeline Styles */
    .timeline {
      position: relative;
      padding: 40px 0;
    }

    .timeline-container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      position: relative;
      padding: 0 40px;
    }

    .timeline-line {
      position: absolute;
      top: 48px;
      left: 80px;
      right: 80px;
      height: 8px;
      background: linear-gradient(90deg, #e5e7eb 0%, #e5e7eb 100%);
      z-index: 0;
      border-radius: 8px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .timeline-progress {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color) 0%, var(--success) 100%);
      transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(16, 138, 126, 0.5);
    }

    .timeline-step {
      position: relative;
      z-index: 1;
      text-align: center;
      flex: 1;
      min-width: 120px;
    }

    .timeline-icon {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      background: white;
      border: 6px solid #e5e7eb;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .timeline-step.completed .timeline-icon {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      border-color: var(--success);
      color: white;
      transform: scale(1.05);
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
    }

    .timeline-step.current .timeline-icon {
      background: linear-gradient(135deg, var(--primary-color) 0%, #0d6f66 100%);
      border-color: var(--primary-color);
      color: white;
      transform: scale(1.1);
      box-shadow: 0 0 0 6px rgba(16, 138, 126, 0.2), 0 8px 24px rgba(16, 138, 126, 0.4);
      animation: pulse 2s infinite;
    }

    .timeline-step.pending .timeline-icon {
      background: #f9fafb;
      border-color: #d1d5db;
      color: #9ca3af;
      transform: scale(0.95);
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 0 6px rgba(16, 138, 126, 0.2), 0 8px 24px rgba(16, 138, 126, 0.4);
      }
      50% {
        box-shadow: 0 0 0 12px rgba(16, 138, 126, 0.1), 0 8px 32px rgba(16, 138, 126, 0.5);
      }
    }

    .timeline-label {
      font-weight: 700;
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .timeline-step.completed .timeline-label,
    .timeline-step.current .timeline-label {
      color: #1f2937;
    }

    .timeline-date {
      font-size: 13px;
      color: #9ca3af;
      font-weight: 500;
    }

    .timeline-step.completed .timeline-date {
      color: var(--success);
      font-weight: 600;
    }

    .timeline-step.current .timeline-date {
      color: var(--primary-color);
      font-weight: 600;
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      text-transform: capitalize;
    }

    .status-badge.ordered {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-badge.shipped {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.delivered {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge.cancelled {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-badge.returned {
      background: #e0e7ff;
      color: #3730a3;
    }

    .status-badge.return-requested {
      background: #fef9c3;
      color: #713f12;
    }

    /* Custom Select */
    .status-select, .return-select {
      appearance: none;
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 8px 36px 8px 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 20px;
    }

    .status-select:hover, .return-select:hover {
      border-color: var(--primary-color);
      background-color: white;
    }

    .status-select:focus, .return-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(16, 138, 126, 0.1);
    }

    /* Action Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), #0d6f66);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #dc2626);
      color: white;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
      border: 2px solid #e5e7eb;
    }

    /* Product Card */
    .product-card {
      border: 2px solid #f3f4f6;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .product-card:hover {
      border-color: var(--primary-color);
      background: #f9fafb;
    }

    .product-image {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Info Grid */
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f3f4f6;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: #6b7280;
      font-weight: 500;
    }

    .info-value {
      color: #1f2937;
      font-weight: 600;
      text-align: right;
    }

    /* Header */
    .page-header {
      background: linear-gradient(135deg, var(--primary-color), #0d6f66);
      color: white;
      padding: 32px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 8px 16px rgba(16, 138, 126, 0.3);
    }

    /* Animations */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-in {
      animation: slideIn 0.5s ease forwards;
    }

    /* Print styles */
    @media print {
      body {
        background: white;
      }
      .no-print {
        display: none;
      }
      .card {
        box-shadow: none;
        border: 1px solid #e5e7eb;
      }
    }
  </style>
</head>
<body class="min-h-screen p-6">
  <div class="container mx-auto max-w-7xl">
    <!-- Page Header -->
    <div class="page-header animate-in">
      <div class="flex justify-between items-center flex-wrap gap-4">
        <div>
          <h1 class="text-3xl font-bold mb-2">Order #<%= order.orderId %></h1>
          <p class="text-blue-100">Manage and track order details</p>
        </div>
        <div class="flex gap-3 no-print">
          <button onclick="window.print()" class="btn btn-secondary">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
            Print
          </button>
          <button onclick="window.history.back()" class="btn btn-secondary">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back to Orders
          </button>
        </div>
      </div>
    </div>

    <% if (order.totalWarning) { %>
      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg animate-in">
        <div class="flex items-center">
          <svg class="w-6 h-6 text-yellow-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <p class="text-yellow-700 font-medium"><%= order.totalWarning %></p>
        </div>
      </div>
    <% } %>

    <!-- Timeline Section -->
    <div class="card p-8 mb-6 animate-in">
      <h2 class="text-2xl font-bold mb-6 text-gray-800">Order Timeline</h2>
      <div class="timeline">
        <div class="timeline-container">
          <div class="timeline-line">
            <div class="timeline-progress" style="width: <%= (order.timeline.filter(s => s.completed).length / order.timeline.length) * 100 %>%"></div>
          </div>
          <% order.timeline.forEach(step => { %>
            <div class="timeline-step <%= step.completed ? 'completed' : step.current ? 'current' : 'pending' %>">
              <div class="timeline-icon">
                <% if (step.label === 'Ordered') { %>
                  📦
                <% } else if (step.label === 'Shipped') { %>
                  🚚
                <% } else if (step.label === 'Out for Delivery') { %>
                  🛵
                <% } else if (step.label === 'Delivered') { %>
                  ✅
                <% } else { %>
                  📋
                <% } %>
              </div>
              <div class="timeline-label"><%= step.label %></div>
              <% if (step.completed) { %>
                <div class="timeline-date"><%= new Date().toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }) %></div>
              <% } else { %>
                <div class="timeline-date">Pending</div>
              <% } %>
            </div>
          <% }) %>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left Column: Order Items -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Order Items -->
        <div class="card p-6 animate-in">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">Order Items</h2>
          <div class="space-y-4">
            <% if (order.orderItems && order.orderItems.length > 0) { %>
              <% order.orderItems.forEach((item, index) => { %>
                <div class="product-card">
                  <div class="flex items-start gap-4">
                    <img src="<%= item.productImage %>" alt="<%= item.productName %>" class="product-image" onerror="this.src='https://via.placeholder.com/100'">
                    <div class="flex-1">
                      <h3 class="text-lg font-bold text-gray-800 mb-2"><%= item.productName %></h3>
                      <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                        <p class="text-gray-600">Product ID: <span class="font-medium text-gray-800"><%= item.productId %></span></p>
                        <p class="text-gray-600">Quantity: <span class="font-medium text-gray-800"><%= item.quantity %></span></p>
                        <p class="text-gray-600">Price: <span class="font-bold text-green-600">₹<%= item.purchasePrice.toFixed(2) %></span></p>
                      </div>
                      <div class="flex items-center justify-between flex-wrap gap-3">
  <span class="status-badge <%= item.status %>"><%= item.status.replace('-', ' ') %></span>

  <select class="status-select no-print"
          <%= ['delivered', 'cancelled'].includes(item.status) ? 'disabled' : '' %>
          onchange="updateItemStatus('<%= order.orderId %>', '<%= item.ord_id %>', this.value)">
    
    <option value="ordered"
            <%= item.status === 'ordered' ? 'selected' : '' %>
            <%= ['delivered', 'cancelled'].includes(item.status) ? 'disabled' : '' %>>Ordered</option>
    
    <option value="shipped"
            <%= item.status === 'shipped' ? 'selected' : '' %>
            <%= ['delivered', 'cancelled'].includes(item.status) ? 'disabled' : '' %>>Shipped</option>
    
    <option value="delivered"
            <%= item.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
    
    <option value="cancelled"
            <%= item.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
  </select>

  <% if (item.status === 'return requested') { %>
    <button class="btn btn-primary no-print ml-2"
            onclick="verifyReturnRequest('<%= order.orderId %>', '<%= item.ord_id %>', 'accepted')">Accept Return</button>
    <button class="btn btn-danger no-print ml-2"
            onclick="verifyReturnRequest('<%= order.orderId %>', '<%= item.ord_id %>', 'rejected')">Reject Return</button>
  <% } %>
</div>
                    </div>
                  </div>
                </div>
              <% }) %>
            <% } else { %>
              <div class="text-center py-12 text-gray-400">
                <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                </svg>
                <p class="text-lg">No items found in this order</p>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Shipping Address -->
        <div class="card p-6 animate-in">
          <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Shipping Address
          </h2>
          <div class="bg-gray-50 p-6 rounded-lg">
            <p class="text-lg font-bold text-gray-800 mb-3"><%= order.address.fullName %></p>
            <p class="text-gray-700 mb-2"><%= order.address.address %></p>
            <p class="text-gray-700 mb-2"><%= order.address.city %>, <%= order.address.state %></p>
            <p class="text-gray-700 mb-2"><%= order.address.country %> - <%= order.address.pinCode %></p>
            <p class="text-gray-700 mb-2 flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
              </svg>
              <%= order.address.phone %>
            </p>
            <span class="inline-block mt-2 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium capitalize">
              <%= order.address.addressType %>
            </span>
          </div>
        </div>
      </div>

      <!-- Right Column: Order Summary -->
      <div class="space-y-6">
        <!-- Order Status Card -->
        <div class="card p-6 animate-in">
          <h2 class="text-xl font-bold mb-4 text-gray-800">Order Status</h2>
          <div class="space-y-3">
            <div class="info-row">
              <span class="info-label">Order Status</span>
              <span class="status-badge <%= order.orderStatus %>"><%= order.orderStatus %></span>
            </div>
            <div class="info-row">
              <span class="info-label">Payment Status</span>
              <span class="info-value <%= order.paymentStatus === 'Paid' ? 'text-green-600' : 'text-red-600' %>"><%= order.paymentStatus %></span>
            </div>
            <div class="info-row">
              <span class="info-label">Payment Method</span>
              <span class="info-value"><%= order.paymentMethod %></span>
            </div>
          </div>
        </div>

        <!-- Order Information -->
        <div class="card p-6 animate-in">
          <h2 class="text-xl font-bold mb-4 text-gray-800">Order Information</h2>
          <div class="space-y-3">
            <div class="info-row">
              <span class="info-label">Order Date</span>
              <span class="info-value"><%= order.createdAt.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) %></span>
            </div>
            <div class="info-row">
              <span class="info-label">Invoice Date</span>
              <span class="info-value"><%= order.invoiceDate.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) %></span>
            </div>
            <div class="info-row">
              <span class="info-label">Transaction ID</span>
              <span class="info-value text-xs break-all"><%= order.transactionId %></span>
            </div>
          </div>
        </div>

        <!-- Customer Information -->
        <div class="card p-6 animate-in">
          <h2 class="text-xl font-bold mb-4 text-gray-800">Customer Details</h2>
          <div class="space-y-3">
            <div class="info-row">
              <span class="info-label">Name</span>
              <span class="info-value"><%= order.user.name %></span>
            </div>
            <div class="info-row">
              <span class="info-label">Email</span>
              <span class="info-value text-sm break-all"><%= order.user.email %></span>
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="card p-6 animate-in">
          <h2 class="text-xl font-bold mb-4 text-gray-800">Order Summary</h2>
          <div class="space-y-3">
            <div class="info-row">
              <span class="info-label">Subtotal</span>
              <span class="info-value">₹<%= order.totalPrice.toFixed(2) %></span>
            </div>
            <div class="info-row">
              <span class="info-label">Shipping</span>
              <span class="info-value">₹<%= order.shipping.toFixed(2) %></span>
            </div>
            <div class="info-row">
              <span class="info-label">Tax</span>
              <span class="info-value">₹<%= order.tax.toFixed(2) %></span>
            </div>
            <% if (order.couponApplied) { %>
              <div class="info-row">
                <span class="info-label text-green-600">Discount</span>
                <span class="info-value text-green-600">-₹<%= order.discount.toFixed(2) %></span>
              </div>
            <% } %>
            <div class="info-row border-t-2 border-gray-200 pt-3">
              <span class="info-label text-lg">Total Amount</span>
              <span class="info-value text-xl text-green-600">₹<%= order.finalAmount.toFixed(2) %></span>
            </div>
          </div>
          <% if (order.message) { %>
            <div class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-400 rounded-r">
              <p class="text-sm text-blue-700"><strong>Note:</strong> <%= order.message %></p>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function updateItemStatus(orderId, itemId, newStatus) {
      try {
        const confirmResult = await Swal.fire({
          title: 'Update Status?',
          text: `Change status to "${newStatus}"?`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#108a7e',
          cancelButtonColor: '#6b7280',
          confirmButtonText: 'Yes, update it!',
          cancelButtonText: 'Cancel'
        });

        if (!confirmResult.isConfirmed) {
          return; // don't reload here, let user stay on the page
        }

        const response = await fetch(`/admin/order/update-status/${orderId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ itemId, status: newStatus })
        });

        let data = {};
        try {
          data = await response.json(); // try parsing JSON
        } catch {
          // fallback if server sent empty or invalid JSON
          data.message = 'Server returned an invalid response';
        }

        if (!response.ok) {
          throw new Error(data.message || 'Failed to update status');
        }

        // Success alert
        await Swal.fire({
          icon: 'success',
          title: 'Updated!',
          text: data.message || 'Status updated successfully',
          confirmButtonColor: '#108a7e',
          timer: 2000
        });

        location.reload(); // reload after success
      } catch (error) {
        console.error('Error updating status:', error);

        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error.message || 'An error occurred while updating the status',
          confirmButtonColor: '#ef4444'
        });
      }
    }

    async function verifyReturnRequest(orderId, itemId, action) {
      try {
        const confirmResult = await Swal.fire({
          title: 'Verify Return Request?',
          text: `Mark return as "${action}"?`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#108a7e',
          cancelButtonColor: '#6b7280',
          confirmButtonText: `Yes, ${action}!`,
          cancelButtonText: 'Cancel'
        });

        if (!confirmResult.isConfirmed) {
          
          return; // don't reload here, let user stay on the page
        }

        const response = await fetch(`/admin/order/verify-return/${orderId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ itemId, action })
        });
        console.log('YYEWYWY',response)

        let data = {};
        try {
          data = await response.json(); // try parsing JSON
        } catch {
          // fallback if server sent empty or invalid JSON
          data.message = 'Server returned an invalid response';
        }

        if (!response.ok) {
          throw new Error(data.message || 'Failed to verify return request');
        }

        // Success alert
        await Swal.fire({
          icon: 'success',
          title: 'Return Processed!',
          text: data.message || `Return request ${action} successfully`,
          confirmButtonColor: '#108a7e',
          timer: 2000
        });

        location.reload(); // reload after success
      } catch (error) {
        console.error('Error verifying return request:', error);

        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error.message || 'An error occurred while processing the return request',
          confirmButtonColor: '#ef4444'
        });
      }
    }

    // Add staggered animation to cards
    document.addEventListener('DOMContentLoaded', () => {
      const cards = document.querySelectorAll('.animate-in');
      cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
      });
    });
  </script>
</body>
</html>




okay listn to me very arefull analyse the entire codes of my bakend nd frontend codes

i need some simple things


first i need you to create couponController and coupon pages in the admin side in wich admin needs to create coupon, edit coupon, unlist coupon and delete coupon

add coupon expiry date, start date, also start date shouldn't be a past date, also minimum order value etc.. perfect working i need

then in the user side create a coupon page to list all those listed coupons by admin very stilish design of coupon needed so create the coupon controller in the user side also

then comes the checkout , in the checkout add an option to fill the coupon and apply button, after checking live validation the coupon should be applied and the price of the product should be reduced
if some warning came, in the below of the input field pass a live warning, like minimum amount required to apply this coupon, coupon expired and rest with your logic
also give a modal to open for the show all available coupons
and with the applied coupon the order should be placed and price deduction also needs to shhow the, also show in the order details of the user and admin that the price breakdown couopn deducted something like those

and remember very carefully while appliying and placing the order with coupon because if multiple products are in the cart and checkout and order with coupon the price should be deducted as per the percentage of calculation i leave the logic to you,

and if the order gets cancelled the money back will not recieve from the coupon i think you understood the rest,

like if i cancel a online payment order with 2 products applied coupon, and i cancel one of them the money of the coupon dedeuct and credit the cancelled amount to my wallet like that,
rest logic i leave with you like the coupon discount amount calculation to products in checkout as per the total price and percentage,

okay so impelemtn the coupon module fully,

also i need just a simple thing,
i have implemented the online payment with razorpay test mode,
so it is working perfectly but if i cancel the order also gets cancelled, so i need that if i clicks failure  i need the order to be placed but not confirmed , and in the orders page and order details page of the user there is an option to retry payment to fullfill the payment until 10 minutes of the payment initiated, so do it like that i leave the rest of the logics of this also to you


so impress me with your skills

and don't use react , only use ejs and ejs syntax