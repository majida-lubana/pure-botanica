<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base Styles */
        .content-main {
            margin-left: 250px;
            padding: 2rem;
            min-height: 100vh;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            text-align: center;
            margin-bottom: 2rem;
        }

        .search-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            gap: 1rem;
        }

        .search-form {
            flex: 1;
            max-width: 500px;
        }

        .search-input-group {
            display: flex;
            background: white;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .search-input {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            outline: none;
            font-size: 0.875rem;
            background: transparent;
        }

        .search-btn {
            padding: 1rem 1.5rem;
            background: #3b82f6;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-btn:hover {
            background: #2563eb;
        }

        .clear-btn {
            padding: 1rem 1.5rem;
            background: #6b7280;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .clear-btn:hover {
            background: #4b5563;
        }

        .main-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .table-section {
            padding: 0;
            overflow: hidden;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .table-header {
            background: #f8fafc;
            color: #64748b;
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.8125rem;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table-row {
            border-bottom: 1px solid #f1f5f9;
            transition: background-color 0.2s;
        }

        .table-row:hover {
            background: #f8fafc;
        }

        .table-cell {
            padding: 1rem 0.75rem;
            vertical-align: middle;
            color: #475569;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-pending {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-processing {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-shipped {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-delivered {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-cancelled {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-unavailable {
            background-color: #e5e7eb;
            color: #4b5563;
        }

        .product-thumbnail {
            width: 2.5rem;
            height: 2.5rem;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }

        .product-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .product-details {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-view {
            background: #3b82f6;
            color: white;
        }

        .btn-view:hover {
            background: #2563eb;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 2rem;
        }

        .pagination {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .pagination-btn {
            padding: 0.5rem 0.75rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            color: #374151;
            text-decoration: none;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .pagination-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .pagination-current {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        @media (max-width: 1024px) {
            .content-main {
                margin-left: 0;
                padding: 1rem;
            }

            .search-container {
                flex-direction: column;
                gap: 1rem;
            }

            .search-form {
                max-width: 100%;
            }
        }

        @media (max-width: 640px) {
            .action-buttons {
                flex-direction: column;
            }

            .action-btn {
                text-align: center;
            }

            .search-input-group {
                border-radius: 0.5rem;
            }

            .search-btn {
                border-radius: 0 0.5rem 0.5rem 0;
            }

            .clear-btn {
                border-radius: 0 0.5rem 0.5rem 0;
            }
        }
    </style>
</head>
<%- include("../../views/partials/admin/sidebar") %>
<body class="bg-gray-50">
    <main class="content-main">
        <!-- Header Section -->
        <header class="mb-8">
            <h1 class="page-title">Order Management</h1>
            <!-- Search Container -->
            <div class="search-container">
                <form action="/admin/orders" method="get" class="search-form">
                    <div class="search-input-group">
                        <input 
                            type="text" 
                            name="search" 
                            id="searchInput"
                            placeholder="Search orders..." 
                            class="search-input"
                            value="<%= typeof search !== 'undefined' ? search : '' %>"
                        >
                        <button type="submit" class="search-btn">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </button>
                        <% if (typeof search !== 'undefined' && search) { %>
                            <button type="button" id="clearSearchBtn" class="clear-btn" title="Clear Search">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        <% } %>
                    </div>
                </form>
            </div>
        </header>

        <!-- Main Content Card -->
        <div class="main-card">
            <div class="table-section">
                <div class="table-container">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th class="table-header">PRODUCT</th>
                                <th class="table-header">ORDER ID</th>
                                <th class="table-header">CUSTOMER</th>
                                <th class="table-header">STATUS</th>
                                <th class="table-header">PRICE</th>
                                <th class="table-header">DATE</th>
                                <th class="table-header">ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody>
  <% if (orders && orders.length > 0) { %>
    <% orders.forEach(order => { %>
      <tr class="table-row" data-order-id="<%= order._id %>">
        <td class="table-cell">
          <% if (order.orderItems && order.orderItems.length > 0) { %>
            <% if (order.orderItems.length <= 2) { %>
              <% order.orderItems.forEach(item => { %>
                <div class="product-item">
                  <img
                    src="<%= item.displayImage %>"
                    alt="<%= item.displayName %>"
                    class="product-thumbnail"
                    onerror="this.src='/default-image.jpg'"
                  >
                </div>
              <% }) %>
            <% } else { %>
              <div class="product-item">
                <img
                  src="<%= order.orderItems[0].displayImage %>"
                  alt="<%= order.orderItems[0].displayName %>"
                  class="product-thumbnail"
                  onerror="this.src='/default-image.jpg'"
                >
                <span class="text-xs text-gray-500">+<%= order.orderItems.length - 1 %></span>
              </div>
            <% } %>
          <% } else { %>
            <span class="text-xs text-gray-500">No items</span>
          <% } %>
        </td>
        <td class="table-cell">
          <div class="product-details">
            <span class="text-sm font-semibold text-gray-900"><%= order.orderId %></span>
            <% if (order.orderItems && order.orderItems.length > 0) { %>
              <span class="text-xs text-gray-500 truncate w-full">
                <%= order.orderItems[0].displayName %>
              </span>
            <% } %>
          </div>
        </td>
        <td class="table-cell font-medium"><%= order.user ? order.user.name : 'Unknown User' %></td>
        <td class="table-cell">
          <span class="status-badge <%= order.status === 'delivered' ? 'status-delivered' : order.status === 'cancelled' ? 'status-cancelled' : order.status === 'returned' ? 'status-cancelled' : 'status-' + order.status %>">
            <%= order.status.charAt(0).toUpperCase() + order.status.slice(1) %>
          </span>
        </td>
        <td class="table-cell font-semibold">â‚¹<%= order.finalAmount.toFixed(2) %></td>
        <td class="table-cell text-gray-600"><%= new Date(order.createdOn).toLocaleDateString() %></td>
        <td class="table-cell">
          <div class="action-buttons">
            <% if (order.orderId) { %>
      <a href="order/details/<%=order.orderId%>" class="action-btn btn-view">
        <i class="fas fa-eye text-xs">View</i>
      </a>
    <% } else { %>
      <span class="text-xs text-gray-500">No Order ID</span>
    <% } %>
          </div>
        </td>
      </tr>
    <% }) %>
  <% } else { %>
    <tr>
      <td colspan="7" class="table-cell text-center text-gray-500 py-8">
        No orders found
      </td>
    </tr>
  <% } %>
</tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination-container">
            <div class="pagination">
                <% if(totalPages > 0) { %>
                    <% if(currentPage > 1) { %>
                        <a href="?page=<%= currentPage - 1 %>" class="pagination-btn">
                            <i class="fas fa-chevron-left text-xs"></i>
                        </a>
                    <% } %>
                    <% for(let i = 1; i <= totalPages; i++) { %>
                        <% if(i === currentPage) { %>
                            <span class="pagination-btn pagination-current"><%= i %></span>
                        <% } else if(i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) { %>
                            <a href="?page=<%= i %>" class="pagination-btn"><%= i %></a>
                        <% } else if(i === currentPage - 2 || i === currentPage + 2) { %>
                            <span class="pagination-btn">...</span>
                        <% } %>
                    <% } %>
                    <% if(currentPage < totalPages) { %>
                        <a href="?page=<%= currentPage + 1 %>" class="pagination-btn">
                            <i class="fas fa-chevron-right text-xs"></i>
                        </a>
                    <% } %>
                <% } %>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        class OrderManager {
            constructor() {
                this.searchInput = document.getElementById("searchInput");
                this.clearSearchBtn = document.getElementById("clearSearchBtn");

                this.init();
            }

            init() {
                if (this.clearSearchBtn) {
                    this.clearSearchBtn.addEventListener("click", this.clearSearch.bind(this));
                }

                if (this.searchInput) {
                    this.searchInput.addEventListener("input", this.handleSearch.bind(this));
                }
            }

            handleSearch() {
                const searchTerm = this.searchInput.value.toLowerCase();
                const orderRows = document.querySelectorAll('.table-row');

                orderRows.forEach(row => {
                    const orderText = row.textContent.toLowerCase();
                    if (orderText.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            clearSearch() {
                if (this.searchInput) {
                    this.searchInput.value = "";
                    window.location.href = "/admin/orders";
                }
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            new OrderManager();
        });
    </script>
</body>
</html>