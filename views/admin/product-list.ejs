<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Table</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome CDN -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  <!-- SweetAlert2 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Custom scrollbar for the table container */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: #6b7280; /* Tailwind gray-500 */
      border-radius: 10px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background-color: #f3f4f6; /* Tailwind gray-100 */
    }
    
    /* Modern button styles matching the theme */
    .btn-primary {
      background-color: #14b8a6; /* Teal-500 */
      color: white;
      font-size: 12px;
      font-weight: 600;
      border-radius: 0.5rem;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: none;
    }
    
    .btn-primary:hover {
      background-color: #0d9488; /* Teal-600 */
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background-color: #374151; /* Gray-700 */
      color: white;
      font-size: 12px;
      font-weight: 600;
      border-radius: 0.5rem;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: none;
    }
    
    .btn-secondary:hover {
      background-color: #1f2937; /* Gray-800 */
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background-color: #ef4444; /* Red-500 */
      color: white;
      font-size: 12px;
      font-weight: 600;
      border-radius: 0.5rem;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: none;
    }
    
    .btn-danger:hover {
      background-color: #dc2626; /* Red-600 */
      transform: translateY(-1px);
    }
    
    .btn-success {
      background-color: #10b981; /* Emerald-500 */
      color: white;
      font-size: 12px;
      font-weight: 600;
      border-radius: 0.5rem;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: none;
    }
    
    .btn-success:hover {
      background-color: #059669; /* Emerald-600 */
      transform: translateY(-1px);
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-listed {
      background-color: #dcfce7; /* Green-100 */
      color: #166534; /* Green-800 */
    }
    
    .status-unlisted {
      background-color: #fee2e2; /* Red-100 */
      color: #991b1b; /* Red-800 */
    }
    
    /* Table styling improvements */
    .table-header {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-bottom: 2px solid #e2e8f0;
    }
    
    .table-row {
      transition: background-color 0.2s ease;
    }
    
    .table-row:hover {
      background-color: #f8fafc;
    }
    
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .stats-card {
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      border-radius: 12px;
      padding: 20px;
      color: white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .search-input {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
      transition: border-color 0.2s ease;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #14b8a6;
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }
  </style>
</head>
<body class="bg-gray-50 font-sans">
  <%- include("../../views/partials/admin/sidebar") %>
  <!-- Main content wrapper with left margin for sidebar -->
  <div class="ml-64 p-6">
    <div class="max-w-full">
      <!-- Header section -->
      <div class="flex flex-wrap items-center gap-4 mb-8">
        <div class="stats-card flex items-center gap-4 min-w-max">
          <div class="bg-white bg-opacity-20 rounded-full p-3">
            <i class="fas fa-shopping-cart text-white text-xl"></i>
          </div>
          <div>
            <p class="text-sm font-medium opacity-90">Total Products</p>
            <p class="text-2xl font-bold"><%= totalProducts || 0 %></p>
          </div>
        </div>
        
        <button 
          onclick="window.location.href='/admin/add-product'" 
          class="btn-primary flex items-center gap-2"
        >
          <i class="fas fa-plus"></i>
          Add Product
        </button>
        
        <form class="relative flex-1 max-w-xs">
          <input
            class="search-input w-full pr-10"
            placeholder="Search products..."
            type="text"
            name="search"
          />
          <button 
            aria-label="Search" 
            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600" 
            type="submit"
          >
            <i class="fas fa-search"></i>
          </button>
        </form>
      </div>
      
      <!-- Table section -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto scrollbar-thin">
          <table class="min-w-full text-sm text-left">
            <thead class="table-header">
              <tr>
                <th class="px-6 py-4 font-semibold text-gray-700 uppercase tracking-wider">Image</th>
                <th class="px-6 py-4 font-semibold text-gray-700 uppercase tracking-wider">Product Details</th>
                <th class="px-6 py-4 font-semibold text-gray-700 uppercase tracking-wider">Category</th>
                <th class="px-6 py-4 font-semibold text-gray-700 uppercase tracking-wider">Price</th>
                <th class="px-6 py-4 font-semibold text-gray-700 uppercase tracking-wider">Stock</th>
                <th class="px-6 py-4 font-semibold text-gray-700 uppercase tracking-wider">Status</th>
                <th class="px-6 py-4 font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              <% if (products && products.length > 0) { %>
                <% products.forEach(product => { %>
                  <tr class="table-row">
                    <td class="px-6 py-4">
                      <img
                        src="<%= product.imageUrl || 'https://storage.googleapis.com/a1aa/image/placeholder.jpg' %>"
                        alt="<%= product.productName || 'product' %>"
                        class="w-12 h-12 object-cover rounded-lg border border-gray-200"
                      />
                    </td>
                    <td class="px-6 py-4">
                      <div class="font-semibold text-gray-900"><%= product.productName || 'N/A' %></div>
                    </td>
                    <td class="px-6 py-4">
                      <span class="text-gray-700"><%= product.category?.categoryName || 'N/A' %></span>
                    </td>
                    <td class="px-6 py-4">
                      <span class="font-semibold text-teal-600">â‚¹<%= product.price || '0.00' %></span>
                    </td>
                    <td class="px-6 py-4">
                      <div class="text-sm text-gray-600">
                        <% if (product.stock) { %>
                          <% Object.entries(product.stock).forEach(([size, qty]) => { %>
                            <div><%= `${size}: ${qty}` %></div>
                          <% }) %>
                        <% } else { %>
                          N/A
                        <% } %>
                      </div>
                    </td>
                    <td class="px-6 py-4">
                      <% if (product.isListed) { %>
                        <span class="status-badge status-listed">Listed</span>
                      <% } else { %>
                        <span class="status-badge status-unlisted">Unlisted</span>
                      <% } %>
                    </td>
                    <td class="px-6 py-4">
                      <div class="action-buttons">
                        <button
                          class="btn-primary"
                          onclick="window.location.href='/admin/product-details/<%= product._id %>'"
                        >
                          <i class="fas fa-eye mr-1"></i>
                          Details
                        </button>
                        
                        <button
                          class="btn-secondary"
                          onclick="window.location.href='/admin/edit-product/<%= product._id %>'"
                        >
                          <i class="fas fa-edit mr-1"></i>
                          Edit
                        </button>
                        
                        <% if (product.isListed) { %>
                          <button 
                            class="btn-danger"
                            data-product-id="<%= product._id %>"
                            onclick="toggleListProduct('<%= product._id %>', true)"
                            title="Unlist Product"
                          >
                            <i class="fas fa-times mr-1"></i>
                            Unlist
                          </button>
                        <% } else { %>
                          <button 
                            class="btn-success"
                            data-product-id="<%= product._id %>"
                            onclick="toggleListProduct('<%= product._id %>', false)"
                            title="List Product"
                          >
                            <i class="fas fa-check mr-1"></i>
                            List
                          </button>
                        <% } %>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="7" class="px-6 py-12 text-center">
                    <div class="text-gray-500">
                      <i class="fas fa-box-open text-4xl mb-4"></i>
                      <p class="text-lg font-medium">No products found</p>
                      <p class="text-sm">Get started by adding your first product</p>
                    </div>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Responsive adjustments -->
  <style>
    @media (max-width: 1024px) {
      .ml-64 {
        margin-left: 0;
        padding: 1rem;
      }
    }
    
    @media (max-width: 768px) {
      .ml-64 {
        margin-left: 0;
        padding: 0.5rem;
      }
      
      .flex-wrap {
        flex-direction: column;
        align-items: stretch !important;
      }
      
      .stats-card {
        width: 100%;
      }
      
      .search-input {
        margin-top: 1rem;
      }
      
      .action-buttons {
        flex-direction: row;
        flex-wrap: wrap;
      }
      
      .action-buttons button {
        flex: 1;
        min-width: 80px;
      }
      
      /* Make table more mobile friendly */
      .px-6 {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      
      .py-4 {
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
      }
    }
  </style>

  <script>
    async function toggleListProduct(productId, isListed) {
      console.log(`Toggling product ${productId}, isListed: ${isListed}`);
      const result = await Swal.fire({
        title: isListed ? "Unlist this product?" : "List this product?",
        text: "You can always change this later",
        icon: "question",
        showCancelButton: true,
        confirmButtonColor: "#14b8a6",
        cancelButtonColor: "#ef4444",
        confirmButtonText: isListed ? "Yes, Unlist it!" : "Yes, List it!",
        cancelButtonText: "Cancel"
      });

      if (result.isConfirmed) {
        try {
          const url = `/admin/${isListed ? 'unListProduct' : 'listProduct'}?id=${productId}`;
          console.log(`Fetching: ${url}`);
          const response = await fetch(url, {
            method: 'PUT',
            headers: { "Content-Type": "application/json" },
          });
          const data = await response.json();
          console.log('Server response:', data);

          if (response.ok && data.success) {
            await Swal.fire({
              icon: "success",
              title: "Success!",
              text: `Product ${data.isListed ? "listed" : "unlisted"} successfully.`,
              timer: 1500,
              showConfirmButton: false,
              confirmButtonColor: "#14b8a6"
            });

            // Reload the page to reflect changes
            window.location.reload();
          } else {
            throw new Error(data.message || "Failed to update product");
          }
        } catch (error) {
          console.error("Error:", error);
          Swal.fire({
            icon: "error",
            title: "Error!",
            text: error.message || "An error occurred while updating the product",
            confirmButtonColor: "#14b8a6"
          });
        }
      }
    }
  </script>
</body>
</html>