<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Table</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome CDN -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  <!-- SweetAlert2 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Custom scrollbar for the table container */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: #6b7280; /* Tailwind gray-500 */
      border-radius: 10px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background-color: #f3f4f6; /* Tailwind gray-100 */
    }
    
    /* Modern button styles matching the theme */
    .btn-primary {
      background-color: #14b8a6; /* Teal-500 */
      color: white;
      font-size: 12px;
      font-weight: 600;
      border-radius: 0.5rem;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: none;
    }
    
    .btn-primary:hover {
      background-color: #0d9488; /* Teal-600 */
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background-color: #374151; /* Gray-700 */
      color: white;
      font-size: 12px;
      font-weight: 600;
      border-radius: 0.5rem;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: none;
    }
    
    .btn-secondary:hover {
      background-color: #1f2937; /* Gray-800 */
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background-color: #ef4444; /* Red-500 */
      color: white;
      font-size: 12px;
      font-weight: 600;
      border-radius: 0.5rem;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: none;
    }
    
    .btn-danger:hover {
      background-color: #dc2626; /* Red-600 */
      transform: translateY(-1px);
    }
    
    .btn-success {
      background-color: #10b981; /* Emerald-500 */
      color: white;
      font-size: 12px;
      font-weight: 600;
      border-radius: 0.5rem;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: none;
    }
    
    .btn-success:hover {
      background-color: #059669; /* Emerald-600 */
      transform: translateY(-1px);
    }
    
    .btn-warning {
      background-color: #f59e0b; /* Amber-500 */
      color: white;
      font-size: 12px;
      font-weight: 600;
      border-radius: 0.5rem;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: none;
    }
    
    .btn-warning:hover {
      background-color: #d97706; /* Amber-600 */
      transform: translateY(-1px);
    }
    
    .btn-clear {
      background-color: #6b7280; /* Gray-500 */
      color: white;
      font-size: 12px;
      font-weight: 600;
      border-radius: 0.5rem;
      padding: 8px 12px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: none;
    }
    
    .btn-clear:hover {
      background-color: #4b5563; /* Gray-600 */
      transform: translateY(-1px);
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-listed {
      background-color: #dcfce7; /* Green-100 */
      color: #166534; /* Green-800 */
    }
    
    .status-unlisted {
      background-color: #fee2e2; /* Red-100 */
      color: #991b1b; /* Red-800 */
    }
    
    .offer-badge {
      background-color: #fef3c7; /* Amber-100 */
      color: #92400e; /* Amber-800 */
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    /* Table styling improvements */
    .table-header {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-bottom: 2px solid #e2e8f0;
    }
    
    .table-row {
      transition: background-color 0.2s ease;
    }
    
    .table-row:hover {
      background-color: #f8fafc;
    }
    
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .stats-card {
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      border-radius: 12px;
      padding: 20px;
      color: white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .search-input {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
      transition: border-color 0.2s ease;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #14b8a6;
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }
  </style>
</head>
<body class="bg-gray-50 font-sans">
  <%- include("../../views/partials/admin/sidebar") %>
  <!-- Main content wrapper with left margin for sidebar -->
  <div class="ml-64 p-6">
    <div class="max-w-full">
      <!-- Header section -->
      <div class="flex flex-wrap items-center gap-4 mb-8">
        <div class="stats-card flex items-center gap-4 min-w-max">
          <div class="bg-white bg-opacity-20 rounded-full p-3">
            <i class="fas fa-shopping-cart text-white text-xl"></i>
          </div>
          <div>
            <p class="text-sm font-medium opacity-90">Total Products</p>
            <p class="text-2xl font-bold"><%= totalProducts || 0 %></p>
          </div>
        </div>
        
        <button 
          onclick="window.location.href='/admin/add-product'" 
          class="btn-primary flex items-center gap-2"
        >
          <i class="fas fa-plus"></i>
          Add Product
        </button>
        
        <form class="relative flex-1 max-w-xs" id="searchForm">
          <div class="flex items-center gap-2">
            <div class="relative flex-1">
              <input
                class="search-input w-full pr-10"
                placeholder="Search products..."
                type="text"
                name="search"
                id="searchInput"
                value="<%= typeof search !== 'undefined' ? search : '' %>"
              />
              <button 
                aria-label="Search" 
                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors" 
                type="submit"
              >
                <i class="fas fa-search"></i>
              </button>
            </div>
            <button 
              type="button" 
              id="clearSearchBtn" 
              class="btn-clear flex items-center gap-1" 
              title="Clear Search"
              style="display: <%= (typeof search !== 'undefined' && search) ? 'flex' : 'none' %>;"
            >
              <i class="fas fa-times"></i>
              Clear
            </button>
          </div>
        </form>
      </div>
      
      <!-- Table section -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto scrollbar-thin">
          <table class="min-w-full text-sm text-left">
            <thead class="table-header">
              <tr>
                <th class="px-6 py-4 font-semibold text-gray-700 uppercase tracking-wider">Image</th>
                <th class="px-6 py-4 font-semibold text-gray-700 uppercase tracking-wider">Product Name</th>
                <th class="px-6 py-4 font-semibold text-gray-700 uppercase tracking-wider">Category</th>
                <th class="px-6 py-4 font-semibold text-gray-700 uppercase tracking-wider">Price</th>
                <th class="px-6 py-4 font-semibold text-gray-700 uppercase tracking-wider">Stock</th>
                <th class="px-6 py-4 font-semibold text-gray-700 uppercase tracking-wider">Status</th>
                <th class="px-6 py-4 font-semibold text-gray-700 uppercase tracking-wider">Offer</th>
                <th class="px-6 py-4 font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              <% if (products && products.length > 0) { %>
                <% products.forEach(product => { %>
                  <tr class="table-row">
                    <td class="px-6 py-4">
                      <img
                        src="<%= product.productImages && product.productImages[0] ? '/Uploads/product-images/' + product.productImages[0] : 'https://storage.googleapis.com/a1aa/image/placeholder.jpg' %>"
                        alt="<%= product.productName || 'product' %>"
                        class="w-12 h-12 object-cover rounded-lg border border-gray-200"
                      />
                    </td>
                    <td class="px-6 py-4">
                      <div class="font-semibold text-gray-900"><%= product.productName || 'N/A' %></div>
                    </td>
                    <td class="px-6 py-4">
                      <span class="text-gray-700"><%= product.category?.categoryName || 'N/A' %></span>
                    </td>
                    <td class="px-6 py-4">
                      <span class="font-semibold text-teal-600">â‚¹<%= product.salePrice || '0.00' %></span>
                    </td>
                    <td class="px-6 py-4">
                      <div class="text-sm text-gray-600">
                        <%= product.quantity || 'N/A' %>
                      </div>
                    </td>
                    <td class="px-6 py-4">
                      <% if (!product.isBlocked) { %>
                        <span class="status-badge status-listed">Listed</span>
                      <% } else { %>
                        <span class="status-badge status-unlisted">Unlisted</span>
                      <% } %>
                    </td>
                    <td class="px-6 py-4">
                      <span class="offer-badge" data-product-id="<%= product._id %>">
                        <%= product.productOffer > 0 ? product.productOffer + '%' : 'No Offer' %>
                      </span>
                    </td>
                    <td class="px-6 py-4">
                      <div class="action-buttons">
                        <% if (product.productOffer > 0) { %>
                          <button
                            class="btn-danger"
                            data-product-id="<%= product._id %>"
                            onclick="removeOffer('<%= product._id %>')"
                            title="Remove Offer"
                          >
                            <i class="fas fa-times mr-1"></i>
                            Remove Offer
                          </button>
                        <% } else { %>
                          <button
                            class="btn-warning"
                            data-product-id="<%= product._id %>"
                            onclick="addOffer('<%= product._id %>')"
                            title="Add Offer"
                          >
                            <i class="fas fa-tag mr-1"></i>
                            Add Offer
                          </button>
                        <% } %>
                        <button
                          class="btn-secondary"
                          onclick="window.location.href='/admin/edit-product/<%= product._id %>'"
                        >
                          <i class="fas fa-edit mr-1"></i>
                          Edit
                        </button>
                        <% if (!product.isBlocked) { %>
                          <button
                            class="btn-danger"
                            data-product-id="<%= product._id %>"
                            onclick="toggleListProduct('<%= product._id %>', true)"
                            title="Unlist Product"
                          >
                            <i class="fas fa-times mr-1"></i>
                            Unlist
                          </button>
                        <% } else { %>
                          <button
                            class="btn-success"
                            data-product-id="<%= product._id %>"
                            onclick="toggleListProduct('<%= product._id %>', false)"
                            title="List Product"
                          >
                            <i class="fas fa-check mr-1"></i>
                            List
                          </button>
                        <% } %>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="8" class="px-6 py-12 text-center">
                    <div class="text-gray-500">
                      <i class="fas fa-box-open text-4xl mb-4"></i>
                      <p class="text-lg font-medium">No products found</p>
                      <p class="text-sm">Get started by adding your first product</p>
                    </div>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="w-full flex justify-center mt-6">
    <div class="flex space-x-2">
      <% if (currentPage > 1) { %>
        <a href="?page=<%= currentPage - 1 %>" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400 text-sm">
          &laquo; Prev
        </a>
      <% } %>

      <% for (let i = 1; i <= totalPages; i++) { %>
        <% if (i === currentPage) { %>
          <span class="px-3 py-1 bg-green-600 text-white rounded text-sm font-semibold"><%= i %></span>
        <% } else { %>
          <a href="?page=<%= i %>" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400 text-sm"><%= i %></a>
        <% } %>
      <% } %>

      <% if (currentPage < totalPages) { %>
        <a href="?page=<%= currentPage + 1 %>" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400 text-sm">
          Next &raquo;
        </a>
      <% } %>
    </div>
  </div>

  <!-- Responsive adjustments -->
  <style>
    @media (max-width: 1024px) {
      .ml-64 {
        margin-left: 0;
        padding: 1rem;
      }
    }
    
    @media (max-width: 768px) {
      .ml-64 {
        margin-left: 0;
        padding: 0.5rem;
      }
      
      .flex-wrap {
        flex-direction: column;
        align-items: stretch !important;
      }
      
      .stats-card {
        width: 100%;
      }
      
      .search-input {
        margin-top: 1rem;
      }
      
      .action-buttons {
        flex-direction: row;
        flex-wrap: wrap;
      }
      
      .action-buttons button {
        flex: 1;
        min-width: 80px;
      }
      
      .px-6 {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      
      .py-4 {
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
      }
    }
  </style>

  <script>
    // Add Offer Function
    async function addOffer(productId) {
      const { value: offerPercentage } = await Swal.fire({
        title: 'Add Offer',
        text: 'Enter offer percentage (0-99)',
        input: 'number',
        inputPlaceholder: 'Enter percentage (e.g., 10)',
        inputAttributes: {
          min: 0,
          max: 99,
          step: 1
        },
        showCancelButton: true,
        confirmButtonColor: '#14b8a6',
        cancelButtonColor: '#ef4444',
        confirmButtonText: 'Add Offer',
        cancelButtonText: 'Cancel',
        inputValidator: (value) => {
          const num = parseInt(value, 10);
          if (!value) {
            return 'You need to enter a percentage!';
          }
          if (isNaN(num) || num < 0 || num > 99) {
            return 'Please enter a valid percentage between 0 and 99!';
          }
        }
      });

      if (offerPercentage !== undefined) {
        try {
          const response = await fetch(`/admin/add-product-offer/${productId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ offerPercentage: parseInt(offerPercentage, 10) }),
          });

          if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
          }

          const data = await response.json();

          if (data.success) {
            await Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: `Offer of ${data.offerPercentage}% added successfully! ${data.cartsUpdated > 0 ? data.cartsUpdated + ' cart(s) updated.' : ''}`,
              timer: 2000,
              showConfirmButton: false,
              confirmButtonColor: '#14b8a6',
            });

            // Update UI
            updateOfferUI(productId, data.offerPercentage);
          } else {
            throw new Error(data.message || 'Failed to add offer');
          }
        } catch (error) {
          console.error('Error:', error);
          await Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: error.message || 'An error occurred while adding the offer',
            confirmButtonColor: '#14b8a6',
          });
        }
      }
    }

    // Remove Offer Function
    async function removeOffer(productId) {
      const result = await Swal.fire({
        title: 'Remove offer?',
        text: 'This will set the offer to 0%',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#14b8a6',
        cancelButtonColor: '#ef4444',
        confirmButtonText: 'Yes, remove it!',
        cancelButtonText: 'Cancel',
      });

      if (result.isConfirmed) {
        try {
          const response = await fetch(`/admin/remove-product-offer/${productId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
          }

          const data = await response.json();

          if (data.success) {
            await Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: `Offer removed successfully! ${data.cartsUpdated > 0 ? data.cartsUpdated + ' cart(s) updated.' : ''}`,
              timer: 2000,
              showConfirmButton: false,
              confirmButtonColor: '#14b8a6',
            });

            // Update UI
            updateOfferUI(productId, 0);
          } else {
            throw new Error(data.message || 'Failed to remove offer');
          }
        } catch (error) {
          console.error('Error:', error);
          await Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: error.message || 'An error occurred while removing the offer',
            confirmButtonColor: '#14b8a6',
          });
        }
      }
    }

    // Update Offer UI
    function updateOfferUI(productId, offerPercentage) {
      const button = document.querySelector(`.action-buttons button[data-product-id="${productId}"]`);
      const offerBadge = document.querySelector(`.offer-badge[data-product-id="${productId}"]`);

      if (button && offerBadge) {
        // Update offer badge
        offerBadge.textContent = offerPercentage > 0 ? `${offerPercentage}%` : 'No Offer';

        // Update button
        const actionButtons = button.closest('.action-buttons');
        if (offerPercentage > 0) {
          // Change to "Remove Offer" button
          button.className = 'btn-danger';
          button.innerHTML = '<i class="fas fa-times mr-1"></i>Remove Offer';
          button.title = 'Remove Offer';
          button.onclick = () => removeOffer(productId);
        } else {
          // Change to "Add Offer" button
          button.className = 'btn-warning';
          button.innerHTML = '<i class="fas fa-tag mr-1"></i>Add Offer';
          button.title = 'Add Offer';
          button.onclick = () => addOffer(productId);
        }
      }
    }

    // Toggle List/Unlist Product
    async function toggleListProduct(productId, isListed) {
      const result = await Swal.fire({
        title: isListed ? 'Unlist this product?' : 'List this product?',
        text: 'You can always change this later',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#14b8a6',
        cancelButtonColor: '#ef4444',
        confirmButtonText: isListed ? 'Yes, Unlist it!' : 'Yes, List it!',
        cancelButtonText: 'Cancel',
      });

      if (result.isConfirmed) {
        try {
          const url = `/admin/${isListed ? 'blockProduct' : 'unblockProduct'}/${productId}`;
          const response = await fetch(url, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ isListed: !isListed }),
          });

          if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
          }

          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error(`Server did not return JSON, status: ${response.status}`);
          }

          const data = await response.json();

          if (data.success) {
            await Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: `Product ${data.isListed ? 'listed' : 'unlisted'} successfully.`,
              timer: 1500,
              showConfirmButton: false,
              confirmButtonColor: '#14b8a6',
            });

            // Update UI
            const buttons = document.querySelectorAll(`button[data-product-id="${productId}"]`);
            const listButton = Array.from(buttons).find(btn => 
              btn.textContent.includes('Unlist') || btn.textContent.includes('List')
            );
            const tableRow = listButton ? listButton.closest('tr') : null;

            if (tableRow && listButton) {
              // Update status badge
              const statusBadge = tableRow.querySelector('.status-badge');
              if (statusBadge) {
                statusBadge.classList.remove('status-listed', 'status-unlisted');
                statusBadge.classList.add(data.isListed ? 'status-listed' : 'status-unlisted');
                statusBadge.textContent = data.isListed ? 'Listed' : 'Unlisted';
              }

              // Update button
              listButton.classList.remove('btn-success', 'btn-danger');
              listButton.classList.add(data.isListed ? 'btn-danger' : 'btn-success');
              listButton.innerHTML = `<i class="fas fa-${data.isListed ? 'times' : 'check'} mr-1"></i>${data.isListed ? 'Unlist' : 'List'}`;
              listButton.title = data.isListed ? 'Unlist Product' : 'List Product';
              listButton.onclick = () => toggleListProduct(productId, data.isListed);
            } else {
              location.reload();
            }
          } else {
            throw new Error(data.message || 'Failed to update product');
          }
        } catch (error) {
          console.error('Error:', error);
          await Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: error.message || 'An error occurred while updating the product',
            confirmButtonColor: '#14b8a6',
          });
        }
      }
    }

    // Clear Search Function
    function clearSearch() {
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.value = '';
        window.location.href = '/admin/product';
      }
    }

    // Initialize Clear Search Button
    document.addEventListener('DOMContentLoaded', () => {
      const clearSearchBtn = document.getElementById('clearSearchBtn');
      if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', clearSearch);
      }
    });
  </script>
</body>
</html>