<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Beauty Cart - Checkout</title>
  <!-- Razorpay SDK -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script> 
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/css/user/checkout.css">
</head>

<body>
  <%- include('../partials/user/header') %>

      <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
      <h1 class="text-3xl font-bold mb-8 text-center text-gray-800">
        Checkout
      </h1>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- LEFT: Addresses + Payment (2 columns on desktop) -->
        <div class="lg:col-span-2 space-y-6">
          <form action="/checkout/place-order" method="POST" id="checkout-form">

            <!-- Address Section -->
            <div class="section-card">
              <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-map-marker-alt mr-2 text-gray-600"></i>
                Shipping Address
              </h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="address-list">
                <% if (userAddresses && Array.isArray(userAddresses) && userAddresses.length> 0) { %>
                  <% userAddresses.forEach((addr) => { %>
                    <div class="address-card bg-gray-50 border rounded-lg p-4 <%= addr.isDefault ? 'selected' : '' %>"
                      data-address-id="<%= addr._id %>">
                      <div class="flex items-start mb-3">
                        <input type="radio" name="selectedAddress" id="address-<%= addr._id %>"
                          value="<%= addr._id %>" <%= addr.isDefault ? 'checked' : '' %> class="mt-1 mr-2">
                        <div class="flex-1">
                          <label for="address-<%= addr._id %>"
                            class="font-medium text-gray-800 block mb-1 cursor-pointer">
                            <%= addr.name || addr.fullName || 'Unnamed Address' %>
                          </label>
                          <div class="flex flex-wrap gap-1 mb-2">
                            <span class="inline-block bg-gray-200 text-gray-700 px-2 py-1 text-xs rounded">
                              <%= addr.addressType || 'Unknown' %>
                            </span>
                            <% if (addr.isDefault) { %>
                              <span class="inline-block bg-black text-white px-2 py-1 text-xs rounded">
                                Default
                              </span>
                              <% } %>
                          </div>
                          <p class="text-gray-600 text-sm leading-relaxed">
                            <%= addr.address || 'N/A' %><br />
                            <%= addr.city || 'N/A' %>, <%= addr.state || 'N/A' %><br />
                            <%= addr.country || 'N/A' %> - <%= addr.pinCode || addr.pincode || 'N/A' %><br />
                            Phone: <%= addr.phone || 'N/A' %>
                            <% if (addr.altPhone) { %>
                              <br />Alt Phone: <%= addr.altPhone %>
                              <% } %>
                          </p>
                        </div>
                      </div>
                      <div class="flex justify-end space-x-2 mt-3 pt-3 border-t border-gray-200 text-sm">
                        <a href="#" class="text-black hover:text-gray-600 edit-address"
                          data-address-id="<%= addr._id.toString() %>">
                          <i class="fas fa-edit mr-1"></i>Edit
                        </a>
                        <span class="text-gray-300">|</span>
                        <a href="#" class="text-gray-600 hover:text-red-600 remove-address"
                          data-address-id="<%= addr._id %>">
                          <i class="fas fa-trash mr-1"></i>Remove
                        </a>
                      </div>
                    </div>
                    <% }) %>
                      <% } else { %>
                        <div id="no-address-message"
                          class="col-span-2 text-red-500 text-sm text-center p-4 bg-red-50 rounded-lg">
                          <i class="fas fa-exclamation-circle mr-2"></i>
                          No shipping addresses available. Please add an address to proceed.
                        </div>
                        <% } %>
              </div>

              <button type="button" id="add-address-btn"
                class="mt-6 flex items-center text-black hover:text-gray-700 transition">
                <i class="fas fa-plus-circle mr-2"></i>
                <span class="font-medium">Add New Address</span>
              </button>

              <div id="address-error" class="text-red-500 text-sm mt-3 hidden bg-red-50 p-2 rounded">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Please select a shipping address before proceeding.
              </div>
            </div>

            <!-- Coupon Section -->
           <!-- Coupon Section -->
<!-- Coupon Section -->
<div class="section-card bg-white rounded-xl shadow-sm p-6 mb-8">
  <h2 class="text-xl font-semibold mb-5 text-gray-800 flex items-center gap-2">
    <i class="fas fa-tags text-gray-600"></i>
    Apply Coupon
  </h2>

  <!-- Applied Coupon Display -->
  <div id="applied-coupon" 
       class="hidden flex items-center justify-between p-4 bg-green-50 border border-green-200 rounded-lg mb-6">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
        <i class="fas fa-tag text-green-600 text-xl"></i>
      </div>
      <div>
        <div class="font-semibold text-green-800 text-lg" id="applied-coupon-name"></div>
        <div class="text-sm text-green-700 mt-0.5">
          Discount: <span class="font-medium text-green-800">-₹<span id="applied-coupon-amount">0.00</span></span>
        </div>
      </div>
    </div>
    <button type="button" 
            onclick="removeCoupon()"
            class="text-red-600 hover:text-red-800 font-medium px-4 py-2 rounded-lg hover:bg-red-50 transition flex items-center gap-1">
      <i class="fas fa-times"></i>
      Remove
    </button>
  </div>

  <!-- Coupon Input Area -->
  <div id="coupon-input-section">
    <div class="flex flex-col sm:flex-row gap-3">
      <input type="text" 
             id="couponCode" 
             name="couponCode"
             placeholder="Enter coupon code" 
             class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition text-base">

      <div class="flex flex-row sm:flex-row gap-3">
        <button type="button" 
                onclick="applyCoupon()"
                class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition font-medium flex-1 sm:flex-none min-w-[110px]">
          Apply
        </button>

        <button type="button" 
                onclick="showAvailableCoupons()"
                class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg transition font-medium flex items-center justify-center gap-2 flex-1 sm:flex-none min-w-[140px]">
          <i class="fas fa-ticket-alt"></i>
          View Coupons
        </button>
      </div>
    </div>

    <!-- Warning / Success message -->
    <div id="coupon-warning" 
         class="mt-4 text-sm font-medium p-3 rounded-lg hidden">
    </div>
  </div>
</div>

            <!-- Payment Section -->
            <div class="section-card">
              <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-credit-card mr-2 text-gray-600"></i>
                Payment Method
              </h2>
              <div class="space-y-3">

                <!-- COD Option -->
                <div class="payment-option bg-gray-50 rounded-lg p-4 selected">
                  <div class="flex items-center">
                    <input type="radio" id="cod" name="paymentMethod" value="cod" class="mr-3" checked />
                    <label for="cod" class="flex items-center cursor-pointer w-full">
                      <div class="bg-white p-3 rounded-lg mr-3 shadow-sm">
                        <i class="fas fa-money-bill-wave text-green-600 text-lg"></i>
                      </div>
                      <div>
                        <span class="font-medium text-gray-800 block">Cash on Delivery</span>
                        <span class="text-sm text-gray-500">Pay when you receive your order</span>
                      </div>
                    </label>
                  </div>
                </div>

                <!-- UPI Option (Now Enabled) -->
                <% if (razorpayEnabled) { %>
  <div class="payment-option bg-gray-50 rounded-lg p-4">
    <div class="flex items-center">
      <input type="radio" id="razorpay" name="paymentMethod" value="razorpay" class="mr-3" />
      <label for="razorpay" class="flex items-center cursor-pointer w-full">
        <div class="bg-white p-3 rounded-lg mr-3 shadow-sm">
          <i class="fas fa-credit-card text-indigo-600 text-lg"></i>
        </div>
        <div>
          <span class="font-medium text-gray-800 block">Razorpay</span>
          <span class="text-sm text-gray-500">
            Card, Net-Banking, UPI, Wallet
          </span>
        </div>
      </label>
    </div>
  </div>
<% } %>


                <div class="payment-option bg-gray-50 rounded-lg p-4">
                  <div class="flex items-center">
                    <input type="radio" id="wallet" name="paymentMethod" value="wallet" class="mr-3" />
                    <label for="wallet" class="flex items-center cursor-pointer w-full">
                      <div class="bg-white p-3 rounded-lg mr-3 shadow-sm">
                        <i class="fas fa-wallet text-purple-600 text-lg"></i>
                      </div>
                      <div>
                        <span class="font-medium text-gray-800 block flex items-center gap-2">
                          Wallet
                        </span>
                        <span class="text-sm text-gray-500">Pay using available wallet balance</span>
                      </div>
                    </label>
                  </div>
                </div>

                <div id="payment-error" class="text-red-500 text-sm hidden bg-red-50 p-2 rounded">
                  <i class="fas fa-exclamation-triangle mr-2"></i>
                  Please select a payment method before proceeding.
                </div>
              </div>

              <button type="submit" id="place-order-btn"
                class="w-full bg-black text-white py-3 rounded-lg hover:bg-gray-800 transition mt-6 font-medium shadow-md"
                <%= userAddresses && Array.isArray(userAddresses) && userAddresses.length> 0 ? '' : 'disabled' %>>
                <i class="fas fa-lock mr-2"></i>
                Place Order
              </button>

              <div class="mt-4 flex items-center justify-center text-gray-500 text-sm">
                <i class="fas fa-shield-alt mr-2 text-green-500"></i>
                Secure Checkout - Your information is safe with us
              </div>
            </div>

          </form>
        </div>

        <!-- RIGHT: Order Summary (1 column on desktop) -->
        <div class="lg:col-span-1">
          <div class="section-card sticky top-24">
            <h2 class="text-lg font-bold mb-4 text-gray-800 pb-3 border-b flex items-center">
              <i class="fas fa-shopping-bag mr-2 text-gray-600"></i>
              Order Summary
            </h2>

            <div class="space-y-3 mb-6">
              <% cart.items.forEach((item) => { %>
                <div class="flex justify-between items-start pb-3 border-b border-gray-100">
                  <div class="flex-1">
                    <p class="font-medium text-sm text-gray-800">
                      <%= item.productId.productName %>
                    </p>
                    <p class="text-xs text-gray-500 mt-1">Quantity: <%= item.quantity %>
                    </p>
                  </div>
                  <p class="font-medium text-sm">₹<%= (item.productId.salePrice * item.quantity).toFixed(2) %>
                  </p>
                </div>
                <% }) %>

                  <div class="space-y-2 pt-2">
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-600">Subtotal</span>
                      <span class="font-medium" id="subtotal-amount">₹<%= subtotal.toFixed(2) %></span>
                    </div>
                    <% if (discount> 0) { %>
                      <div class="flex justify-between text-sm text-green-600">
                        <span>Product Discount</span>
                        <span class="font-medium">-₹<%= discount.toFixed(2) %></span>
                      </div>
                      <% } %>
                        <div id="coupon-discount-row" class="flex justify-between text-sm text-green-600" style="display: none;">
                          <span>Coupon Discount</span>
                          <span class="font-medium" id="coupon-discount-display">-₹0.00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                          <span class="text-gray-600">Shipping</span>
                          <span class="font-medium">₹<%= shippingCost.toFixed(2) %></span>
                        </div>
                        <div class="flex justify-between text-sm">
                          <span class="text-gray-600">Tax</span>
                          <span class="font-medium">₹<%= tax.toFixed(2) %></span>
                        </div>
                  </div>

                  <div class="flex justify-between font-bold text-lg pt-4 border-t-2 border-gray-200">
                    <span>Total</span>
                    <span class="text-black" id="final-total">₹<%= total.toFixed(2) %></span>
                  </div>
            </div>

            <div class="bg-gray-50 p-3 rounded-lg text-center">
              <p class="text-xs text-gray-600">
                <i class="fas fa-truck mr-1"></i>
                Free delivery on orders above ₹999
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Address Modal -->
    <div id="address-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-20 mx-auto p-6 border max-w-md w-full shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-semibold text-gray-800">Add New Address</h3>
          <button id="close-modal" class="text-gray-500 hover:text-gray-700 transition">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <form id="new-address-form">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
              <input type="text" name="fullName" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-fullName"></div>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
              <input type="tel" name="phone" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-phone"></div>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
              <input type="text" name="address" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-address"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
              <input type="text" name="city" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-city"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
              <input type="text" name="state" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-state"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Country</label>
              <input type="text" name="country" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-country"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Pincode</label>
              <input type="text" name="pincode" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-pincode"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Address Type</label>
              <select name="addressType" class="input-field w-full px-3 py-2 rounded-md bg-white">
                <option value="Home">Home</option>
                <option value="Work">Work</option>
                <option value="Other">Other</option>
              </select>
              <div class="error-message" id="error-addressType"></div>
            </div>
            <div class="md:col-span-2">
              <div class="flex items-center mt-2">
                <input type="checkbox" name="isDefault" id="isDefault" class="h-4 w-4 text-black rounded" />
                <label for="isDefault" class="ml-2 text-sm text-gray-700">Set as default address</label>
              </div>
            </div>
          </div>

          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" id="cancel-address"
              class="px-5 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition text-gray-800 font-medium">
              Cancel
            </button>
            <button type="submit" id="save-address-btn"
              class="px-5 py-2 bg-black rounded-lg text-white hover:bg-gray-800 transition font-medium">
              Save Address
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Available Coupons Modal -->
    <div id="coupons-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-20 mx-auto p-6 border max-w-4xl w-full shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-semibold text-gray-800">Available Coupons</h3>
          <button onclick="closeCouponsModal()" class="text-gray-500 hover:text-gray-700 transition">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <div id="coupons-loading" class="text-center py-8">
          <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
          <p class="text-gray-600 mt-2">Loading coupons...</p>
        </div>

        <div id="coupons-list" class="space-y-4 max-h-96 overflow-y-auto">
          <!-- Coupons will be loaded here -->
        </div>

        <div class="mt-6 text-center">
          <button onclick="closeCouponsModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
            Close
          </button>
        </div>
      </div>
    </div>

    <%- include('../partials/user/footer') %>
<script>
  window.checkoutConfig = {
    total: <%= total %>,
    subtotal: <%= subtotal %>
  };

  window.razorpayEnabled = <%= razorpayEnabled ? 'true' : 'false' %>;
  console.log(window.razorpayEnabled)
</script>


<script src="/js/user/checkout.js"></script>
</body>

</html>