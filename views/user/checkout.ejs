<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Beauty Cart - Checkout</title>
  <!-- Razorpay SDK -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script> 
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: "Lato", sans-serif;
      background-color: #f9fafb;
      padding-top: 100px;
    }

    .input-field {
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }

    .input-field:focus {
      border-color: palevioletred;
      outline: none;
      box-shadow: 0 0 0 2px pink;
    }

    .input-field.error {
      border-color: #ef4444;
      box-shadow: 0 0 0 1px #ef4444;
    }

    .error-message {
      color: #ef4444;
      font-size: 0.75rem;
      margin-top: 0.25rem;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .address-card,
    .payment-option {
      transition: all 0.2s ease;
      border: 1px solid #e5e7eb;
      cursor: pointer;
    }

    .address-card.selected,
    .payment-option.selected {
      border-color: palevioletred;
      box-shadow: 0 0 0 1px pink;
    }

    .address-card:hover,
    .payment-option:hover {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    input[type="radio"]:disabled+label {
      color: #a0aec0;
      cursor: not-allowed;
    }

    .payment-option input[type="radio"]:disabled + label {
      pointer-events: none;
    }

    .payment-option.disabled {
      cursor: not-allowed;
    }

    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      height: 80px;
    }

    .section-card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
    }

    .coupon-input-group {
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .coupon-warning {
      font-size: 0.75rem;
      margin-top: 0.5rem;
      padding: 0.5rem;
      border-radius: 0.25rem;
      display: none;
    }

    .coupon-warning.show {
      display: block;
    }

    .coupon-warning.error {
      background-color: #fee2e2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .coupon-warning.success {
      background-color: #dcfce7;
      color: #16a34a;
      border: 1px solid #bbf7d0;
    }

    .coupon-applied {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
  </style>
</head>

<body>
  <%- include('../partials/user/header') %>

      <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
      <h1 class="text-3xl font-bold mb-8 text-center text-gray-800">
        Checkout
      </h1>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- LEFT: Addresses + Payment (2 columns on desktop) -->
        <div class="lg:col-span-2 space-y-6">
          <form action="/checkout/place-order" method="POST" id="checkout-form">

            <!-- Address Section -->
            <div class="section-card">
              <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-map-marker-alt mr-2 text-gray-600"></i>
                Shipping Address
              </h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="address-list">
                <% if (userAddresses && Array.isArray(userAddresses) && userAddresses.length> 0) { %>
                  <% userAddresses.forEach((addr) => { %>
                    <div class="address-card bg-gray-50 border rounded-lg p-4 <%= addr.isDefault ? 'selected' : '' %>"
                      data-address-id="<%= addr._id %>">
                      <div class="flex items-start mb-3">
                        <input type="radio" name="selectedAddress" id="address-<%= addr._id %>"
                          value="<%= addr._id %>" <%= addr.isDefault ? 'checked' : '' %> class="mt-1 mr-2">
                        <div class="flex-1">
                          <label for="address-<%= addr._id %>"
                            class="font-medium text-gray-800 block mb-1 cursor-pointer">
                            <%= addr.name || addr.fullName || 'Unnamed Address' %>
                          </label>
                          <div class="flex flex-wrap gap-1 mb-2">
                            <span class="inline-block bg-gray-200 text-gray-700 px-2 py-1 text-xs rounded">
                              <%= addr.addressType || 'Unknown' %>
                            </span>
                            <% if (addr.isDefault) { %>
                              <span class="inline-block bg-black text-white px-2 py-1 text-xs rounded">
                                Default
                              </span>
                              <% } %>
                          </div>
                          <p class="text-gray-600 text-sm leading-relaxed">
                            <%= addr.address || 'N/A' %><br />
                            <%= addr.city || 'N/A' %>, <%= addr.state || 'N/A' %><br />
                            <%= addr.country || 'N/A' %> - <%= addr.pinCode || addr.pincode || 'N/A' %><br />
                            Phone: <%= addr.phone || 'N/A' %>
                            <% if (addr.altPhone) { %>
                              <br />Alt Phone: <%= addr.altPhone %>
                              <% } %>
                          </p>
                        </div>
                      </div>
                      <div class="flex justify-end space-x-2 mt-3 pt-3 border-t border-gray-200 text-sm">
                        <a href="#" class="text-black hover:text-gray-600 edit-address"
                          data-address-id="<%= addr._id.toString() %>">
                          <i class="fas fa-edit mr-1"></i>Edit
                        </a>
                        <span class="text-gray-300">|</span>
                        <a href="#" class="text-gray-600 hover:text-red-600 remove-address"
                          data-address-id="<%= addr._id %>">
                          <i class="fas fa-trash mr-1"></i>Remove
                        </a>
                      </div>
                    </div>
                    <% }) %>
                      <% } else { %>
                        <div id="no-address-message"
                          class="col-span-2 text-red-500 text-sm text-center p-4 bg-red-50 rounded-lg">
                          <i class="fas fa-exclamation-circle mr-2"></i>
                          No shipping addresses available. Please add an address to proceed.
                        </div>
                        <% } %>
              </div>

              <button type="button" id="add-address-btn"
                class="mt-6 flex items-center text-black hover:text-gray-700 transition">
                <i class="fas fa-plus-circle mr-2"></i>
                <span class="font-medium">Add New Address</span>
              </button>

              <div id="address-error" class="text-red-500 text-sm mt-3 hidden bg-red-50 p-2 rounded">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Please select a shipping address before proceeding.
              </div>
            </div>

            <!-- Coupon Section -->
            <div class="section-card">
              <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-tags mr-2 text-gray-600"></i>
                Apply Coupon
              </h2>
              
              <div id="applied-coupon" class="coupon-applied" style="display: none;">
                <div>
                  <div class="font-semibold" id="applied-coupon-name"></div>
                  <div class="text-sm opacity-90">Discount: -₹<span id="applied-coupon-amount"></span></div>
                </div>
                <button type="button" onclick="removeCoupon()" class="text-white hover:text-red-200">
                  <i class="fas fa-times"></i>
                </button>
              </div>

              <div id="coupon-input-section">
                <div class="coupon-input-group">
                  <input type="text" 
                         id="couponCode" 
                         name="couponCode"
                         placeholder="Enter coupon code" 
                         class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <button type="button" 
                          onclick="applyCoupon()" 
                          class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                    Apply
                  </button>
                  <button type="button" 
                          onclick="showAvailableCoupons()" 
                          class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                    <i class="fas fa-ticket-alt mr-1"></i>View
                  </button>
                </div>
                <div id="coupon-warning" class="coupon-warning"></div>
              </div>
            </div>

            <!-- Payment Section -->
            <div class="section-card">
              <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-credit-card mr-2 text-gray-600"></i>
                Payment Method
              </h2>
              <div class="space-y-3">

                <!-- COD Option -->
                <div class="payment-option bg-gray-50 rounded-lg p-4 selected">
                  <div class="flex items-center">
                    <input type="radio" id="cod" name="paymentMethod" value="cod" class="mr-3" checked />
                    <label for="cod" class="flex items-center cursor-pointer w-full">
                      <div class="bg-white p-3 rounded-lg mr-3 shadow-sm">
                        <i class="fas fa-money-bill-wave text-green-600 text-lg"></i>
                      </div>
                      <div>
                        <span class="font-medium text-gray-800 block">Cash on Delivery</span>
                        <span class="text-sm text-gray-500">Pay when you receive your order</span>
                      </div>
                    </label>
                  </div>
                </div>

                <!-- UPI Option (Now Enabled) -->
                <div class="payment-option bg-gray-50 rounded-lg p-4">
                  <div class="flex items-center">
                    <input type="radio" id="razorpay" name="paymentMethod" value="razorpay" class="mr-3" />
                    <label for="razorpay" class="flex items-center cursor-pointer w-full">
                      <div class="bg-white p-3 rounded-lg mr-3 shadow-sm">
                        <i class="fas fa-credit-card text-indigo-600 text-lg"></i>
                      </div>
                      <div>
                        <span class="font-medium text-gray-800 block flex items-center gap-2">
                          Razorpay
                        </span>
                        <span class="text-sm text-gray-500">Credit/Debit Card, Net-Banking, UPI, Wallet</span>
                      </div>
                    </label>
                  </div>
                </div>

                <div class="payment-option bg-gray-50 rounded-lg p-4">
                  <div class="flex items-center">
                    <input type="radio" id="wallet" name="paymentMethod" value="wallet" class="mr-3" />
                    <label for="wallet" class="flex items-center cursor-pointer w-full">
                      <div class="bg-white p-3 rounded-lg mr-3 shadow-sm">
                        <i class="fas fa-wallet text-purple-600 text-lg"></i>
                      </div>
                      <div>
                        <span class="font-medium text-gray-800 block flex items-center gap-2">
                          Wallet
                        </span>
                        <span class="text-sm text-gray-500">Pay using available wallet balance</span>
                      </div>
                    </label>
                  </div>
                </div>

                <div id="payment-error" class="text-red-500 text-sm hidden bg-red-50 p-2 rounded">
                  <i class="fas fa-exclamation-triangle mr-2"></i>
                  Please select a payment method before proceeding.
                </div>
              </div>

              <button type="submit" id="place-order-btn"
                class="w-full bg-black text-white py-3 rounded-lg hover:bg-gray-800 transition mt-6 font-medium shadow-md"
                <%= userAddresses && Array.isArray(userAddresses) && userAddresses.length> 0 ? '' : 'disabled' %>>
                <i class="fas fa-lock mr-2"></i>
                Place Order
              </button>

              <div class="mt-4 flex items-center justify-center text-gray-500 text-sm">
                <i class="fas fa-shield-alt mr-2 text-green-500"></i>
                Secure Checkout - Your information is safe with us
              </div>
            </div>

          </form>
        </div>

        <!-- RIGHT: Order Summary (1 column on desktop) -->
        <div class="lg:col-span-1">
          <div class="section-card sticky top-24">
            <h2 class="text-lg font-bold mb-4 text-gray-800 pb-3 border-b flex items-center">
              <i class="fas fa-shopping-bag mr-2 text-gray-600"></i>
              Order Summary
            </h2>

            <div class="space-y-3 mb-6">
              <% cart.items.forEach((item) => { %>
                <div class="flex justify-between items-start pb-3 border-b border-gray-100">
                  <div class="flex-1">
                    <p class="font-medium text-sm text-gray-800">
                      <%= item.productId.productName %>
                    </p>
                    <p class="text-xs text-gray-500 mt-1">Quantity: <%= item.quantity %>
                    </p>
                  </div>
                  <p class="font-medium text-sm">₹<%= (item.productId.salePrice * item.quantity).toFixed(2) %>
                  </p>
                </div>
                <% }) %>

                  <div class="space-y-2 pt-2">
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-600">Subtotal</span>
                      <span class="font-medium" id="subtotal-amount">₹<%= subtotal.toFixed(2) %></span>
                    </div>
                    <% if (discount> 0) { %>
                      <div class="flex justify-between text-sm text-green-600">
                        <span>Product Discount</span>
                        <span class="font-medium">-₹<%= discount.toFixed(2) %></span>
                      </div>
                      <% } %>
                        <div id="coupon-discount-row" class="flex justify-between text-sm text-green-600" style="display: none;">
                          <span>Coupon Discount</span>
                          <span class="font-medium" id="coupon-discount-display">-₹0.00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                          <span class="text-gray-600">Shipping</span>
                          <span class="font-medium">₹<%= shippingCost.toFixed(2) %></span>
                        </div>
                        <div class="flex justify-between text-sm">
                          <span class="text-gray-600">Tax</span>
                          <span class="font-medium">₹<%= tax.toFixed(2) %></span>
                        </div>
                  </div>

                  <div class="flex justify-between font-bold text-lg pt-4 border-t-2 border-gray-200">
                    <span>Total</span>
                    <span class="text-black" id="final-total">₹<%= total.toFixed(2) %></span>
                  </div>
            </div>

            <div class="bg-gray-50 p-3 rounded-lg text-center">
              <p class="text-xs text-gray-600">
                <i class="fas fa-truck mr-1"></i>
                Free delivery on orders above ₹999
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Address Modal -->
    <div id="address-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-20 mx-auto p-6 border max-w-md w-full shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-semibold text-gray-800">Add New Address</h3>
          <button id="close-modal" class="text-gray-500 hover:text-gray-700 transition">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <form id="new-address-form">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
              <input type="text" name="fullName" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-fullName"></div>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
              <input type="tel" name="phone" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-phone"></div>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
              <input type="text" name="address" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-address"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
              <input type="text" name="city" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-city"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
              <input type="text" name="state" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-state"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Country</label>
              <input type="text" name="country" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-country"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Pincode</label>
              <input type="text" name="pincode" class="input-field w-full px-3 py-2 rounded-md" />
              <div class="error-message" id="error-pincode"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Address Type</label>
              <select name="addressType" class="input-field w-full px-3 py-2 rounded-md bg-white">
                <option value="Home">Home</option>
                <option value="Work">Work</option>
                <option value="Other">Other</option>
              </select>
              <div class="error-message" id="error-addressType"></div>
            </div>
            <div class="md:col-span-2">
              <div class="flex items-center mt-2">
                <input type="checkbox" name="isDefault" id="isDefault" class="h-4 w-4 text-black rounded" />
                <label for="isDefault" class="ml-2 text-sm text-gray-700">Set as default address</label>
              </div>
            </div>
          </div>

          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" id="cancel-address"
              class="px-5 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition text-gray-800 font-medium">
              Cancel
            </button>
            <button type="submit" id="save-address-btn"
              class="px-5 py-2 bg-black rounded-lg text-white hover:bg-gray-800 transition font-medium">
              Save Address
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Available Coupons Modal -->
    <div id="coupons-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-20 mx-auto p-6 border max-w-4xl w-full shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-semibold text-gray-800">Available Coupons</h3>
          <button onclick="closeCouponsModal()" class="text-gray-500 hover:text-gray-700 transition">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <div id="coupons-loading" class="text-center py-8">
          <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
          <p class="text-gray-600 mt-2">Loading coupons...</p>
        </div>

        <div id="coupons-list" class="space-y-4 max-h-96 overflow-y-auto">
          <!-- Coupons will be loaded here -->
        </div>

        <div class="mt-6 text-center">
          <button onclick="closeCouponsModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
            Close
          </button>
        </div>
      </div>
    </div>

    <%- include('../partials/user/footer') %>

<script>
  let appliedCouponData = null;
  const originalTotal = <%= total %>;
  const originalSubtotal = <%= subtotal %>;

  document.addEventListener("DOMContentLoaded", function () {
    const addAddressBtn = document.getElementById("add-address-btn");
    const addressModal = document.getElementById("address-modal");
    const cancelAddressBtn = document.getElementById("cancel-address");
    const closeModalBtn = document.getElementById("close-modal");
    const newAddressForm = document.getElementById("new-address-form");
    const saveAddressBtn = document.getElementById("save-address-btn");
    const checkoutForm = document.getElementById("checkout-form");
    const placeOrderBtn = document.getElementById("place-order-btn");
    const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');
    const paymentOptions = document.querySelectorAll(".payment-option");
    let isEditMode = false;
    let currentAddressId = null;

    const Swal = window.Swal || window.SweetAlert2;

    if (document.querySelectorAll(".address-card").length === 0) {
      addAddressBtn.click();
    }

    // Open modal
    addAddressBtn.addEventListener("click", () => {
      isEditMode = false;
      currentAddressId = null;
      document.querySelector("#address-modal h3").textContent = "Add New Address";
      newAddressForm.reset();
      clearErrors();
      addressModal.classList.remove("hidden");
    });

    // Close modal
    function closeModal() {
      addressModal.classList.add("hidden");
      newAddressForm.reset();
      clearErrors();
      isEditMode = false;
      currentAddressId = null;
      document.querySelector("#address-modal h3").textContent = "Add New Address";
    }
    cancelAddressBtn.addEventListener("click", closeModal);
    closeModalBtn.addEventListener("click", closeModal);
    addressModal.addEventListener("click", e => e.target === addressModal && closeModal());

    // Address selection
    document.querySelectorAll(".address-card").forEach(card => {
      const radio = card.querySelector('input[type="radio"]');
      card.addEventListener("click", e => {
        if (e.target.tagName !== "A") {
          document.querySelectorAll(".address-card").forEach(c => c.classList.remove("selected"));
          card.classList.add("selected");
          radio.checked = true;
          document.getElementById("address-error").classList.add("hidden");
          placeOrderBtn.disabled = false;
        }
      });
    });

    // Payment selection
    paymentRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        paymentOptions.forEach(opt => {
          opt.classList.toggle("selected", opt.querySelector('input[type="radio"]') === radio);
        });
        document.getElementById("payment-error").classList.add("hidden");
      });
    });
    paymentOptions.forEach(opt => {
      opt.addEventListener("click", () => {
        const radio = opt.querySelector('input[type="radio"]');
        if (radio && !radio.disabled) {
          radio.checked = true;
          radio.dispatchEvent(new Event("change"));
        }
      });
    });

    // Edit Address (existing logic...)
    document.querySelectorAll(".edit-address").forEach(btn => {
      btn.addEventListener("click", async e => {
        e.preventDefault();
        const id = btn.dataset.addressId;
        try {
          const res = await fetch(`/get-address/${id}`);
          const data = await res.json();
          if (data.success) {
            const a = data.addresses[0];
            document.querySelector('[name="fullName"]').value = a.fullName || a.name || "";
            document.querySelector('[name="phone"]').value = a.phone || "";
            document.querySelector('[name="address"]').value = a.address || "";
            document.querySelector('[name="city"]').value = a.city || "";
            document.querySelector('[name="state"]').value = a.state || "";
            document.querySelector('[name="country"]').value = a.country || "";
            document.querySelector('[name="pincode"]').value = a.pincode || a.pinCode || "";
            document.querySelector('[name="addressType"]').value = a.addressType || "Home";
            document.querySelector('[name="isDefault"]').checked = !!a.isDefault;

            isEditMode = true;
            currentAddressId = id;
            document.querySelector("#address-modal h3").textContent = "Edit Address";
            clearErrors();
            addressModal.classList.remove("hidden");
          } else {
            Swal.fire("Error", data.message || "Failed to load address", "error");
          }
        } catch (err) {
          Swal.fire("Error", "Could not load address", "error");
        }
      });
    });

    // Remove Address (existing logic...)
    document.querySelectorAll(".remove-address").forEach(btn => {
      btn.addEventListener("click", async e => {
        e.preventDefault();
        const id = btn.dataset.addressId;
        Swal.fire({
          title: "Remove address?",
          text: "This cannot be undone.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          confirmButtonText: "Yes, remove"
        }).then(async result => {
          if (result.isConfirmed) {
            try {
              const res = await fetch(`/remove-address/${id}`, { method: "DELETE" });
              const data = await res.json();
              if (data.success) {
                Swal.fire("Removed!", "Address deleted.", "success");
                btn.closest(".address-card").remove();
                const cards = document.querySelectorAll(".address-card");
                placeOrderBtn.disabled = cards.length === 0;
                if (cards.length === 0) {
                  document.getElementById("no-address-message")?.classList.remove("hidden");
                  addAddressBtn.click();
                }
              } else {
                Swal.fire("Error", data.message || "Failed to remove", "error");
              }
            } catch (err) {
              Swal.fire("Error", "Network error", "error");
            }
          }
        });
      });
    });

    // Save Address (Add/Edit) - existing logic...
    newAddressForm.addEventListener("submit", async e => {
      e.preventDefault();
      saveAddressBtn.disabled = true;
      saveAddressBtn.textContent = "Saving...";

      const formData = new FormData(newAddressForm);
      const data = Object.fromEntries(formData);
      data.isDefault = formData.has("isDefault");

      if (!validateForm(data)) {
        Swal.fire("Validation Error", "Please fix the errors in the form", "error");
        saveAddressBtn.disabled = false;
        saveAddressBtn.textContent = "Save Address";
        return;
      }

      const url = isEditMode ? `/edit-address/${currentAddressId}` : "/add-address";
      const method = isEditMode ? "PUT" : "POST";

      try {
        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        const result = await res.json();

        if (res.ok && result.success) {
          Swal.fire("Success", isEditMode ? "Address updated" : "Address added", "success");

          const addressList = document.getElementById("address-list");
          const noMsg = document.getElementById("no-address-message");
          const addr = result.address;

          if (isEditMode) {
            const card = document.querySelector(`.address-card[data-address-id="${currentAddressId}"]`);
            if (card) {
              card.querySelector("label").textContent = addr.fullName || addr.name;
              card.querySelector("p").innerHTML = `${addr.address}<br>${addr.city}, ${addr.state}<br>${addr.country} - ${addr.pincode || addr.pinCode}<br>Phone: ${addr.phone}`;
              card.querySelector(".bg-gray-200").textContent = addr.addressType;
              if (addr.isDefault) {
                document.querySelectorAll(".address-card").forEach(c => c.classList.remove("selected"));
                card.classList.add("selected");
                card.querySelector('input[type="radio"]').checked = true;
              }
            }
          } else {
            const card = document.createElement("div");
            card.className = `address-card bg-gray-50 border rounded-lg p-4 ${addr.isDefault ? "selected" : ""}`;
            card.dataset.addressId = addr._id;
            card.innerHTML = `
              <div class="flex items-start mb-3">
                <input type="radio" name="selectedAddress" id="address-${addr._id}" value="${addr._id}" ${addr.isDefault ? "checked" : ""} class="mt-1 mr-2">
                <div class="flex-1">
                  <label for="address-${addr._id}" class="font-medium text-gray-800 block mb-1 cursor-pointer">
                    ${addr.fullName || addr.name}
                  </label>
                  <div class="flex flex-wrap gap-1 mb-2">
                    <span class="inline-block bg-gray-200 text-gray-700 px-2 py-1 text-xs rounded">${addr.addressType}</span>
                    ${addr.isDefault ? '<span class="inline-block bg-black text-white px-2 py-1 text-xs rounded">Default</span>' : ""}
                  </div>
                  <p class="text-gray-600 text-sm leading-relaxed">
                    ${addr.address}<br>${addr.city}, ${addr.state}<br>${addr.country} - ${addr.pincode || addr.pinCode}<br>Phone: ${addr.phone}
                  </p>
                </div>
              </div>
              <div class="flex justify-end space-x-2 mt-3 pt-3 border-t border-gray-200 text-sm">
                <a href="#" class="text-black hover:text-gray-600 edit-address" data-address-id="${addr._id}"><i class="fas fa-edit mr-1"></i>Edit</a>
                <span class="text-gray-300">|</span>
                <a href="#" class="text-gray-600 hover:text-red-600 remove-address" data-address-id="${addr._id}"><i class="fas fa-trash mr-1"></i>Remove</a>
              </div>
            `;
            addressList.appendChild(card);
            if (noMsg) noMsg.classList.add("hidden");
            placeOrderBtn.disabled = false;

            reattachCardEvents(card);
          }
          closeModal();
        } else {
          Swal.fire("Error", result.message || "Failed to save address", "error");
        }
      } catch (err) {
        Swal.fire("Error", "Network error", "error");
      } finally {
        saveAddressBtn.disabled = false;
        saveAddressBtn.textContent = "Save Address";
      }
    });

    // Re-attach edit/remove/click events to new cards
    function reattachCardEvents(card) {
      card.querySelector(".edit-address").addEventListener("click", editHandler);
      card.querySelector(".remove-address").addEventListener("click", removeHandler);
      card.addEventListener("click", cardClickHandler);
    }
    function editHandler(e) { /* same as above edit logic */ }
    function removeHandler(e) { /* same as above remove logic */ }
    function cardClickHandler(e) {
      if (e.target.tagName !== "A") {
        document.querySelectorAll(".address-card").forEach(c => c.classList.remove("selected"));
        this.classList.add("selected");
        this.querySelector('input[type="radio"]').checked = true;
        document.getElementById("address-error").classList.add("hidden");
        placeOrderBtn.disabled = false;
      }
    }

    // COD / Wallet order submission
    async function submitOrder() {
      const form = checkoutForm;
      const btn = placeOrderBtn;
      btn.disabled = true;
      btn.textContent = "Processing...";

      try {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        if (appliedCouponData) {
          data.couponCode = appliedCouponData.code;
        }

        const res = await fetch(form.action, {
          method: form.method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        const result = await res.json();

        if (result.success && result.orderId) {
          Swal.fire({ icon: "success", title: "Order Placed!", text: "Redirecting..." });
          setTimeout(() => location.href = `/order-success?orderId=${result.orderId}&finalAmount=${result.finalAmount}&paymentMethod=${result.paymentMethod}`, 1200);
        } else {
          throw new Error(result.message || "Order failed");
        }
      } catch (err) {
        Swal.fire({ icon: "error", title: "Error", text: err.message });
      } finally {
        btn.disabled = false;
        btn.textContent = "Place Order";
      }
    }

    // MAIN CHECKOUT SUBMIT (handles Razorpay + COD)
    checkoutForm.addEventListener("submit", async e => {
      e.preventDefault();

      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
      const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked')?.value;

      if (!selectedAddress) return Swal.fire({ icon: "error", title: "Address Required", text: "Please select a shipping address" });
      if (!paymentMethod) return Swal.fire({ icon: "error", title: "Payment Required", text: "Please select a payment method" });

      if (paymentMethod !== "razorpay") {
        return submitOrder();
      }

      // RAZORPAY FLOW
      const btn = placeOrderBtn;
      btn.disabled = true;
      btn.textContent = "Creating Order...";

      try {
        const formData = new FormData(checkoutForm);
        const data = Object.fromEntries(formData);
        if (appliedCouponData) {
          data.couponCode = appliedCouponData.code;
        }

        const res = await fetch("/checkout/place-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        const result = await res.json();

        if (!result.success || !result.razorpay) {
          throw new Error(result.message || "Failed to create Razorpay order");
        }

        const options = {
          key: result.key_id,
          amount: result.amount,
          currency: "INR",
          name: "Beauty Cart",
          description: "Order Payment",
          order_id: result.razorpayOrderId,
          retry: false,
          handler: async function (response) {
            const verifyRes = await fetch("/checkout/verify-razorpay", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                razorpay_order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_signature: response.razorpay_signature,
                orderId: result.orderId
              })
            });
            const vData = await verifyRes.json();

            if (vData.success) {
              Swal.fire({ icon: "success", title: "Payment Success!", text: "Redirecting..." });
              setTimeout(() => location.href = `/order-success?orderId=${vData.orderId}&finalAmount=${vData.finalAmount}&paymentMethod=${vData.paymentMethod}`, 1500);
            } else {
              Swal.fire({ icon: "error", title: "Payment Failed", text: vData.message || "Verification failed" });
            }
          },
          prefill: {},
          theme: { color: "#000000" },
          modal: {
            ondismiss: () => {
              // Redirect to order error with orderId for retry
              const orderId = result.orderId;
              const finalAmount = result.finalAmount;
              window.location.href = `/order-error?message=Payment%20Cancelled&details=You%20cancelled%20the%20payment.%20You%20can%20retry%20from%20orders%20page.&orderId=${orderId}&finalAmount=${finalAmount}`;
            }
          }
        };

        const rzp = new Razorpay(options);
        rzp.on("payment.failed", async (resp) => {
          // Record payment failure
          await fetch('/checkout/handle-payment-failure', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              orderId: result.orderId,
              error: resp.error
            })
          });

          // Redirect to error page with retry option
          const orderId = result.orderId;
          const finalAmount = result.finalAmount;
          const errorMsg = resp.error?.description || 'Payment failed';
          window.location.href = `/order-error?message=Payment%20Failed&details=${encodeURIComponent(errorMsg)}&orderId=${orderId}&finalAmount=${finalAmount}`;
        });

        rzp.open();
        btn.disabled = false;
        btn.textContent = "Place Order";

      } catch (err) {
        console.error(err);
        Swal.fire({ icon: "error", title: "Error", text: err.message });
        btn.disabled = false;
        btn.textContent = "Place Order";
      }
    });

    // Validation
    function validateForm(data) {
      let valid = true;
      clearErrors();
      const phonePattern = /^\d{10}$/;
      const pinPattern = /^\d{6}$/;

      if (!data.fullName?.trim()) { showError("fullName", "Full name required"); valid = false; }
      if (!data.phone || !phonePattern.test(data.phone) || data.phone === "0000000000") { showError("phone", "Valid 10-digit phone"); valid = false; }
      if (!data.address?.trim()) { showError("address", "Address required"); valid = false; }
      if (!data.city?.trim()) { showError("city", "City required"); valid = false; }
      if (!data.state?.trim()) { showError("state", "State required"); valid = false; }
      if (!data.country?.trim()) { showError("country", "Country required"); valid = false; }
      if (!data.pincode || !pinPattern.test(data.pincode) || data.pincode === "000000") { showError("pincode", "Valid 6-digit pin"); valid = false; }
      if (!data.addressType?.trim()) { showError("addressType", "Address type required"); valid = false; }

      return valid;
    }

    function showError(field, msg) {
      const el = document.querySelector(`[name="${field}"]`);
      const err = document.getElementById(`error-${field}`);
      el.classList.add("error");
      err.textContent = msg;
      err.classList.add("show");
    }

    function clearErrors() {
      newAddressForm.querySelectorAll(".input-field").forEach(i => i.classList.remove("error"));
      newAddressForm.querySelectorAll(".error-message").forEach(d => { d.textContent = ""; d.classList.remove("show"); });
    }
  });

  // Coupon Functions
  async function applyCoupon() {
    const couponCode = document.getElementById('couponCode').value.trim();
    const warningDiv = document.getElementById('coupon-warning');
    
    if (!couponCode) {
      showCouponWarning('Please enter a coupon code', 'error');
      return;
    }

    const currentTotal = <%= subtotal %>;

    try {
      const response = await fetch('/apply-coupon', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ couponCode, cartTotal: currentTotal })
      });

      const data = await response.json();

      if (data.success) {
        appliedCouponData = data.coupon;
        showAppliedCoupon(data.coupon);
        updatePriceSummary(data.coupon.discountAmount);
        showCouponWarning(`Coupon "${data.coupon.code}" applied successfully!`, 'success');
        
        // Hide input section after successful application
        document.getElementById('coupon-input-section').style.display = 'none';
      } else {
        showCouponWarning(data.message, 'error');
      }
    } catch (error) {
      console.error('Error applying coupon:', error);
      showCouponWarning('Failed to apply coupon. Please try again.', 'error');
    }
  }

  function removeCoupon() {
    appliedCouponData = null;
    document.getElementById('applied-coupon').style.display = 'none';
    document.getElementById('coupon-input-section').style.display = 'block';
    document.getElementById('couponCode').value = '';
    
    // Reset price summary
    updatePriceSummary(0);
    
    const warningDiv = document.getElementById('coupon-warning');
    warningDiv.style.display = 'none';
  }

  function showAppliedCoupon(coupon) {
    const appliedDiv = document.getElementById('applied-coupon');
    document.getElementById('applied-coupon-name').textContent = coupon.name;
    document.getElementById('applied-coupon-amount').textContent = coupon.discountAmount.toFixed(2);
    appliedDiv.style.display = 'flex';
  }

  function updatePriceSummary(discountAmount) {
    const couponDiscountRow = document.getElementById('coupon-discount-row');
    const couponDiscountDisplay = document.getElementById('coupon-discount-display');
    const finalTotalElement = document.getElementById('final-total');
    
    if (discountAmount > 0) {
      couponDiscountRow.style.display = 'flex';
      couponDiscountDisplay.textContent = `-₹${discountAmount.toFixed(2)}`;
      
      const newTotal = originalTotal - discountAmount;
      finalTotalElement.textContent = `₹${newTotal.toFixed(2)}`;
    } else {
      couponDiscountRow.style.display = 'none';
      finalTotalElement.textContent = `₹${originalTotal.toFixed(2)}`;
    }
  }

  function showCouponWarning(message, type) {
    const warningDiv = document.getElementById('coupon-warning');
    warningDiv.textContent = message;
    warningDiv.className = `coupon-warning show ${type}`;
    warningDiv.style.display = 'block';
    
    // Hide warning after 5 seconds for success messages
    if (type === 'success') {
      setTimeout(() => {
        warningDiv.style.display = 'none';
      }, 5000);
    }
  }

  async function showAvailableCoupons() {
    const modal = document.getElementById('coupons-modal');
    const loadingDiv = document.getElementById('coupons-loading');
    const couponsList = document.getElementById('coupons-list');
    
    modal.classList.remove('hidden');
    loadingDiv.style.display = 'block';
    couponsList.innerHTML = '';
    
    try {
      const currentTotal = <%= subtotal %>;
      const response = await fetch(`/available-coupons?cartTotal=${currentTotal}`);
      const data = await response.json();
      
      loadingDiv.style.display = 'none';
      
      if (data.success && data.coupons.length > 0) {
        data.coupons.forEach((coupon, index) => {
          const couponCard = createCouponCard(coupon, index);
          couponsList.appendChild(couponCard);
        });
      } else {
        couponsList.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-ticket-alt text-4xl mb-4"></i>
            <p class="text-lg font-semibold">No coupons available</p>
            <p class="text-sm">Check back later for exciting offers!</p>
          </div>
        `;
      }
    } catch (error) {
      console.error('Error fetching coupons:', error);
      loadingDiv.style.display = 'none';
      couponsList.innerHTML = `
        <div class="text-center py-8 text-red-500">
          <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
          <p class="text-lg font-semibold">Failed to load coupons</p>
          <p class="text-sm">Please try again later</p>
        </div>
      `;
    }
  }

  function createCouponCard(coupon, index) {
    const card = document.createElement('div');
    const gradients = [
      'from-purple-500 to-pink-500',
      'from-blue-500 to-cyan-500', 
      'from-green-500 to-teal-500',
      'from-orange-500 to-red-500',
      'from-indigo-500 to-purple-500'
    ];
    const gradient = gradients[index % gradients.length];
    
    card.className = `p-4 rounded-lg bg-gradient-to-r ${gradient} text-white relative overflow-hidden`;
    
    if (!coupon.isUsable) {
      card.className += ' opacity-60';
    }
    
    card.innerHTML = `
      <div class="flex justify-between items-start">
        <div class="flex-1">
          <h4 class="text-lg font-bold mb-1">${coupon.name}</h4>
          <p class="text-2xl font-bold mb-2">
            ${coupon.discountType === 'percentage' ? coupon.offerPrice + '% OFF' : '₹' + coupon.offerPrice + ' OFF'}
          </p>
          <div class="text-sm opacity-90 space-y-1">
            <p><i class="fas fa-shopping-cart mr-1"></i> Min order: ₹${coupon.minimumPrice}</p>
            <p><i class="fas fa-calendar-alt mr-1"></i> Valid till: ${new Date(coupon.expireOn).toLocaleDateString()}</p>
            ${coupon.discountAmount > 0 ? `<p class="text-yellow-200"><i class="fas fa-tag mr-1"></i> You save: ₹${coupon.discountAmount}</p>` : ''}
          </div>
        </div>
        <div class="text-center">
          <div class="bg-white bg-opacity-20 p-2 rounded mb-2">
            <p class="text-xs opacity-75">CODE</p>
            <p class="font-mono font-bold">${coupon.couponCode}</p>
          </div>
          ${coupon.isUsable 
            ? `<button onclick="selectCoupon('${coupon.couponCode}')" class="bg-white text-gray-800 px-3 py-1 rounded text-sm font-semibold hover:bg-opacity-90 transition">Use Code</button>`
            : `<div class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded">${coupon.reason}</div>`
          }
        </div>
      </div>
    `;
    
    return card;
  }

  function selectCoupon(couponCode) {
    document.getElementById('couponCode').value = couponCode;
    closeCouponsModal();
    applyCoupon();
  }

  function closeCouponsModal() {
    document.getElementById('coupons-modal').classList.add('hidden');
  }
</script>
</body>

</html>