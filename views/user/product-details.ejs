<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title><%= product.productName %> - Pure Botanica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="/css/user/productDetails.css">
  </head>
  <body class="bg-white text-black">
    <%- include("../partials/user/header") %>
    <nav class="max-w-[1400px] mx-auto px-8 py-4 text-sm text-gray-600" style="margin-top: 80px;">
      <ol class="flex space-x-2">
        <li><a href="/" class="hover:underline">Home</a></li>
        <li><span>></span></li>
        <li><a href="/shop" class="hover:underline">Shop</a></li>
        <li><span>></span></li>
        <li><%= product.productName %></li>
      </ol>
    </nav>
    <main class="max-w-[1400px] mx-auto px-8 py-12">
      <% if (product) { %>
        <div class="flex flex-col md:flex-row gap-12">
          <!-- IMAGE SECTION -->
          <div class="w-full md:w-1/2">
            <div class="image-container">
              <img
  id="mainImage"
  alt="<%= product.productName %>"
  class="w-full h-[400px] product-image mb-4 object-cover"
  src="<%= product.productImages?.[0] || 'https://via.placeholder.com/400' %>"
  loading="lazy"
/>

              <div id="zoomLens" class="zoom-lens"></div>
              <div id="zoomResult" class="zoom-result"></div>
            </div>
            <div class="flex space-x-2">
              <% product.productImages.forEach((img, index) => { %>
                <img
  alt="<%= product.productName %> thumbnail <%= index %>"
  class="w-20 h-20 thumbnail <%= index === 0 ? 'active' : '' %>"
  src="<%= img %>"
  data-index="<%= index %>"
  loading="lazy"
/>

              <% }) %>
            </div>
          </div>

          <!-- DETAILS SECTION -->
          <div class="w-full md:w-1/2 relative">
            <!-- WISHLIST ICON (server-rendered) -->
            <button class="absolute top-2 right-2 z-10 p-1.5 rounded-full hover:bg-gray-100 transition-all wishlist-btn"
                            data-product-id="<%= product._id %>" title="Add to Wishlist">
                      <i class="fa<%= wishlistProductIds.includes(product._id.toString()) ? 's text-red-500' : 'r' %> fa-heart text-lg"></i>
                    </button>


            <h1 class="text-3xl font-bold mb-4 text-gray-800"><%= product.productName %></h1>
            <div class="mb-4 flex items-center">
              <span class="text-yellow-400">
                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i>
              </span>
            </div>

            <!-- PRICE -->
            <div class="mb-4 text-center md:text-left">
              <div class="flex items-center justify-center md:justify-start gap-2 flex-wrap">
                <span class="text-3xl font-bold text-green-600">₹<%= product.pricing.displayPrice.toFixed(2) %></span>
                <% if (product.pricing.savings > 0) { %>
                  <span class="text-lg line-through text-gray-500">₹<%= product.pricing.originalPrice.toFixed(2) %></span>
                  <span class="offer-badge"><%= product.pricing.discountPercentage %>%</span>
                <% } %>
              </div>
              <% if (product.pricing.savings > 0) { %>
                <p class="text-sm text-gray-600 mt-1">Save ₹<%= product.pricing.savings.toFixed(2) %></p>
              <% } %>
            </div>

            <% if (discountsApplied) { %>
              <div class="mb-4 text-green-600">Discounts Applied: <%= discountsApplied %></div>
            <% } %>

            <!-- STOCK -->
            <div class="mb-4">
              <% if (product.quantity > 0) { %>
                <span class="available">Available (<%= product.quantity %> in stock)</span>
              <% } else { %>
                <span class="sold-out">Out of Stock</span>
                <p class="text-gray-600">This item is currently out of stock</p>
                <div class="flex mt-2">
                  <input type="email" placeholder="Enter email to get notified" class="p-2 border border-gray-300 rounded text-sm w-64" />
                  <button class="ml-2 bg-orange-500 text-white px-4 py-2 rounded">NOTIFY ME</button>
                </div>
              <% } %>
            </div>

            <!-- QUANTITY + ADD TO CART -->
            <div class="flex items-center gap-4 mb-4">
              <% if (product.quantity > 0) { %>
                <div class="flex items-center gap-2">
                  <button id="decreaseQty" class="quantity-btn"><i class="fas fa-minus"></i></button>
                  <input id="quantity" type="number" value="1" min="1" max="<%= product.quantity %>" class="quantity-input" />
                  <button id="increaseQty" class="quantity-btn"><i class="fas fa-plus"></i></button>
                </div>
              <% } %>

              <!-- MAIN ADD TO CART BUTTON -->
              <button 
                id="addToCartBtn"
                class="bg-black text-white text-sm font-semibold px-6 py-3 rounded hover:bg-gray-800 transition-colors
                       <%= product.quantity === 0 ? 'opacity-50 cursor-not-allowed' : '' %>
                       <%= inCart ? 'bg-green-600 hover:bg-green-700' : '' %>"
                <%= product.quantity === 0 ? 'disabled' : '' %>
                data-product-id="<%= product._id %>"
                data-mode="<%= inCart ? 'goto-cart' : 'add-to-cart' %>"
              >
                <%= inCart ? 'GO TO CART' : 'ADD TO CART' %>
              </button>
            </div>

            <!-- DESCRIPTION SECTIONS -->
            <section class="mt-8">
              <h3 class="font-bold text-lg mb-4 text-[#1a4a5a]">Product Description</h3>
              <p class="text-gray-700"><%= product.description || 'No description available.' %></p>
            </section>
            <section class="mt-8">
              <h3 class="font-bold text-lg mb-4 text-[#1a4a5a]">Skin Concern</h3>
              <p class="text-gray-700"><%= product.skinConcern || 'Not specified.' %></p>
            </section>
            <section class="mt-8">
              <h3 class="font-bold text-lg mb-4 text-[#1a4a5a]">Skin Type</h3>
              <p class="text-gray-700"><%= product.skinType || 'Not specified.' %></p>
            </section>
            <section class="mt-8">
              <h3 class="font-bold text-lg mb-4 text-[#1a4a5a]">How to Use</h3>
              <p class="text-gray-700"><%= product.howToUse || 'No usage instructions provided.' %></p>
            </section>
          </div>
        </div>

        <!-- RELATED PRODUCTS -->
        <section class="mt-12">
          <h3 class="font-bold text-lg mb-4 text-[#1a4a5a]">Related Products</h3>
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-8">
            <% relatedProducts.forEach(relProduct => { %>
              <div class="related-product-card flex flex-col items-center p-4 bg-gray-50 rounded-lg shadow-sm hover:shadow-md transition-shadow relative">
                <button 
                  class="absolute top-2 right-2 z-10 p-1.5 rounded-full hover:bg-gray-100 transition-all wishlist-btn"
                  data-product-id="<%= relProduct._id %>"
                  title="Add to Wishlist">
                  <i class="fa<%= wishlistProductIds.includes(relProduct._id.toString()) ? 's text-red-500' : 'r' %> fa-heart text-lg"></i>
                </button>

                <a href="/product/<%= relProduct._id %>">
                  <img 
  alt="<%= product.name %>" 
  class="mx-auto mb-3 cursor-pointer" 
  height="200" 
  src="<%= product.productImages?.[0] || '/images/placeholder.jpg' %>" 
  width="200"
  onerror="this.src='/images/placeholder.jpg'"
/>

                </a>
                <div class="font-bold text-base mb-2 text-gray-800 text-center"><%= relProduct.productName.toUpperCase() %></div>
                <div class="mb-3 text-center">
                  <div class="flex items-center justify-center gap-2 flex-wrap">
                    <span class="text-xl font-bold text-green-600">₹<%= relProduct.pricing.displayPrice.toFixed(2) %></span>
                    <% if (relProduct.pricing.savings > 0) { %>
                      <span class="text-sm line-through text-gray-500">₹<%= relProduct.pricing.originalPrice.toFixed(2) %></span>
                      <span class="offer-badge"><%= relProduct.pricing.discountPercentage %>%</span>
                    <% } %>
                  </div>
                  <% if (relProduct.pricing.savings > 0) { %>
                    <p class="text-xs text-gray-600 mt-1">Save ₹<%= relProduct.pricing.savings.toFixed(2) %></p>
                  <% } %>
                </div>

                <!-- RELATED PRODUCT BUTTON -->
                <button 
                  class="bg-black text-white text-sm font-semibold px-4 py-1 rounded hover:bg-gray-800 transition-colors add-to-cart-btn
                         <%= relProduct.quantity === 0 ? 'opacity-50 cursor-not-allowed' : '' %>
                         <%= relProduct.inCart ? 'bg-green-600 hover:bg-green-700' : '' %>"
                  data-product-id="<%= relProduct._id %>"
                  data-mode="<%= relProduct.inCart ? 'goto-cart' : 'add-to-cart' %>"
                  <%= relProduct.quantity === 0 ? 'disabled' : '' %>
                >
                  <%= relProduct.inCart ? 'GO TO CART' : (relProduct.quantity === 0 ? 'OUT OF STOCK' : 'ADD TO CART') %>
                </button>
              </div>
            <% }) %>
          </div>
        </section>
      <% } else { %>
        <div class="text-center text-gray-600">Product not found or unavailable.</div>
      <% } %>
    </main>
    <%- include("../partials/user/footer") %>

    <!-- FULL JS (wishlist + cart + zoom) -->
     <script ddefer src="/js/user/productDetails.js"></script>
    
  </body>
</html>